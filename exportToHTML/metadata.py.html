<html>
<head>
<title>metadata.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
metadata.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -*-</span>
<span class="s0">#</span>
<span class="s0"># Copyright (C) 2012 The Python Software Foundation.</span>
<span class="s0"># See LICENSE.txt and CONTRIBUTORS.txt.</span>
<span class="s0">#</span>
<span class="s2">&quot;&quot;&quot;Implementation of the Metadata for Python packages PEPs. 
 
Supports all metadata formats (1.0, 1.1, 1.2, and 2.0 experimental). 
&quot;&quot;&quot;</span>
<span class="s3">from </span><span class="s1">__future__ </span><span class="s3">import </span><span class="s1">unicode_literals</span>

<span class="s3">import </span><span class="s1">codecs</span>
<span class="s3">from </span><span class="s1">email </span><span class="s3">import </span><span class="s1">message_from_file</span>
<span class="s3">import </span><span class="s1">json</span>
<span class="s3">import </span><span class="s1">logging</span>
<span class="s3">import </span><span class="s1">re</span>


<span class="s3">from </span><span class="s1">. </span><span class="s3">import </span><span class="s1">DistlibException</span><span class="s3">, </span><span class="s1">__version__</span>
<span class="s3">from </span><span class="s1">.compat </span><span class="s3">import </span><span class="s1">StringIO</span><span class="s3">, </span><span class="s1">string_types</span><span class="s3">, </span><span class="s1">text_type</span>
<span class="s3">from </span><span class="s1">.markers </span><span class="s3">import </span><span class="s1">interpret</span>
<span class="s3">from </span><span class="s1">.util </span><span class="s3">import </span><span class="s1">extract_by_key</span><span class="s3">, </span><span class="s1">get_extras</span>
<span class="s3">from </span><span class="s1">.version </span><span class="s3">import </span><span class="s1">get_scheme</span><span class="s3">, </span><span class="s1">PEP440_VERSION_RE</span>

<span class="s1">logger = logging.getLogger(__name__)</span>


<span class="s3">class </span><span class="s1">MetadataMissingError(DistlibException):</span>
    <span class="s2">&quot;&quot;&quot;A required metadata is missing&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">MetadataConflictError(DistlibException):</span>
    <span class="s2">&quot;&quot;&quot;Attempt to read or write metadata fields that are conflictual.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">MetadataUnrecognizedVersionError(DistlibException):</span>
    <span class="s2">&quot;&quot;&quot;Unknown metadata version number.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">MetadataInvalidError(DistlibException):</span>
    <span class="s2">&quot;&quot;&quot;A metadata value is invalid&quot;&quot;&quot;</span>

<span class="s0"># public API of this module</span>
<span class="s1">__all__ = [</span><span class="s4">'Metadata'</span><span class="s3">, </span><span class="s4">'PKG_INFO_ENCODING'</span><span class="s3">, </span><span class="s4">'PKG_INFO_PREFERRED_VERSION'</span><span class="s1">]</span>

<span class="s0"># Encoding used for the PKG-INFO files</span>
<span class="s1">PKG_INFO_ENCODING = </span><span class="s4">'utf-8'</span>

<span class="s0"># preferred version. Hopefully will be changed</span>
<span class="s0"># to 1.2 once PEP 345 is supported everywhere</span>
<span class="s1">PKG_INFO_PREFERRED_VERSION = </span><span class="s4">'1.1'</span>

<span class="s1">_LINE_PREFIX_1_2 = re.compile(</span><span class="s4">'</span><span class="s3">\n       \\</span><span class="s4">|'</span><span class="s1">)</span>
<span class="s1">_LINE_PREFIX_PRE_1_2 = re.compile(</span><span class="s4">'</span><span class="s3">\n        </span><span class="s4">'</span><span class="s1">)</span>
<span class="s1">_241_FIELDS = (</span><span class="s4">'Metadata-Version'</span><span class="s3">, </span><span class="s4">'Name'</span><span class="s3">, </span><span class="s4">'Version'</span><span class="s3">, </span><span class="s4">'Platform'</span><span class="s3">,</span>
               <span class="s4">'Summary'</span><span class="s3">, </span><span class="s4">'Description'</span><span class="s3">,</span>
               <span class="s4">'Keywords'</span><span class="s3">, </span><span class="s4">'Home-page'</span><span class="s3">, </span><span class="s4">'Author'</span><span class="s3">, </span><span class="s4">'Author-email'</span><span class="s3">,</span>
               <span class="s4">'License'</span><span class="s1">)</span>

<span class="s1">_314_FIELDS = (</span><span class="s4">'Metadata-Version'</span><span class="s3">, </span><span class="s4">'Name'</span><span class="s3">, </span><span class="s4">'Version'</span><span class="s3">, </span><span class="s4">'Platform'</span><span class="s3">,</span>
               <span class="s4">'Supported-Platform'</span><span class="s3">, </span><span class="s4">'Summary'</span><span class="s3">, </span><span class="s4">'Description'</span><span class="s3">,</span>
               <span class="s4">'Keywords'</span><span class="s3">, </span><span class="s4">'Home-page'</span><span class="s3">, </span><span class="s4">'Author'</span><span class="s3">, </span><span class="s4">'Author-email'</span><span class="s3">,</span>
               <span class="s4">'License'</span><span class="s3">, </span><span class="s4">'Classifier'</span><span class="s3">, </span><span class="s4">'Download-URL'</span><span class="s3">, </span><span class="s4">'Obsoletes'</span><span class="s3">,</span>
               <span class="s4">'Provides'</span><span class="s3">, </span><span class="s4">'Requires'</span><span class="s1">)</span>

<span class="s1">_314_MARKERS = (</span><span class="s4">'Obsoletes'</span><span class="s3">, </span><span class="s4">'Provides'</span><span class="s3">, </span><span class="s4">'Requires'</span><span class="s3">, </span><span class="s4">'Classifier'</span><span class="s3">,</span>
                <span class="s4">'Download-URL'</span><span class="s1">)</span>

<span class="s1">_345_FIELDS = (</span><span class="s4">'Metadata-Version'</span><span class="s3">, </span><span class="s4">'Name'</span><span class="s3">, </span><span class="s4">'Version'</span><span class="s3">, </span><span class="s4">'Platform'</span><span class="s3">,</span>
               <span class="s4">'Supported-Platform'</span><span class="s3">, </span><span class="s4">'Summary'</span><span class="s3">, </span><span class="s4">'Description'</span><span class="s3">,</span>
               <span class="s4">'Keywords'</span><span class="s3">, </span><span class="s4">'Home-page'</span><span class="s3">, </span><span class="s4">'Author'</span><span class="s3">, </span><span class="s4">'Author-email'</span><span class="s3">,</span>
               <span class="s4">'Maintainer'</span><span class="s3">, </span><span class="s4">'Maintainer-email'</span><span class="s3">, </span><span class="s4">'License'</span><span class="s3">,</span>
               <span class="s4">'Classifier'</span><span class="s3">, </span><span class="s4">'Download-URL'</span><span class="s3">, </span><span class="s4">'Obsoletes-Dist'</span><span class="s3">,</span>
               <span class="s4">'Project-URL'</span><span class="s3">, </span><span class="s4">'Provides-Dist'</span><span class="s3">, </span><span class="s4">'Requires-Dist'</span><span class="s3">,</span>
               <span class="s4">'Requires-Python'</span><span class="s3">, </span><span class="s4">'Requires-External'</span><span class="s1">)</span>

<span class="s1">_345_MARKERS = (</span><span class="s4">'Provides-Dist'</span><span class="s3">, </span><span class="s4">'Requires-Dist'</span><span class="s3">, </span><span class="s4">'Requires-Python'</span><span class="s3">,</span>
                <span class="s4">'Obsoletes-Dist'</span><span class="s3">, </span><span class="s4">'Requires-External'</span><span class="s3">, </span><span class="s4">'Maintainer'</span><span class="s3">,</span>
                <span class="s4">'Maintainer-email'</span><span class="s3">, </span><span class="s4">'Project-URL'</span><span class="s1">)</span>

<span class="s1">_426_FIELDS = (</span><span class="s4">'Metadata-Version'</span><span class="s3">, </span><span class="s4">'Name'</span><span class="s3">, </span><span class="s4">'Version'</span><span class="s3">, </span><span class="s4">'Platform'</span><span class="s3">,</span>
               <span class="s4">'Supported-Platform'</span><span class="s3">, </span><span class="s4">'Summary'</span><span class="s3">, </span><span class="s4">'Description'</span><span class="s3">,</span>
               <span class="s4">'Keywords'</span><span class="s3">, </span><span class="s4">'Home-page'</span><span class="s3">, </span><span class="s4">'Author'</span><span class="s3">, </span><span class="s4">'Author-email'</span><span class="s3">,</span>
               <span class="s4">'Maintainer'</span><span class="s3">, </span><span class="s4">'Maintainer-email'</span><span class="s3">, </span><span class="s4">'License'</span><span class="s3">,</span>
               <span class="s4">'Classifier'</span><span class="s3">, </span><span class="s4">'Download-URL'</span><span class="s3">, </span><span class="s4">'Obsoletes-Dist'</span><span class="s3">,</span>
               <span class="s4">'Project-URL'</span><span class="s3">, </span><span class="s4">'Provides-Dist'</span><span class="s3">, </span><span class="s4">'Requires-Dist'</span><span class="s3">,</span>
               <span class="s4">'Requires-Python'</span><span class="s3">, </span><span class="s4">'Requires-External'</span><span class="s3">, </span><span class="s4">'Private-Version'</span><span class="s3">,</span>
               <span class="s4">'Obsoleted-By'</span><span class="s3">, </span><span class="s4">'Setup-Requires-Dist'</span><span class="s3">, </span><span class="s4">'Extension'</span><span class="s3">,</span>
               <span class="s4">'Provides-Extra'</span><span class="s1">)</span>

<span class="s1">_426_MARKERS = (</span><span class="s4">'Private-Version'</span><span class="s3">, </span><span class="s4">'Provides-Extra'</span><span class="s3">, </span><span class="s4">'Obsoleted-By'</span><span class="s3">,</span>
                <span class="s4">'Setup-Requires-Dist'</span><span class="s3">, </span><span class="s4">'Extension'</span><span class="s1">)</span>

<span class="s0"># See issue #106: Sometimes 'Requires' occurs wrongly in the metadata. Include</span>
<span class="s0"># it in the tuple literal below to allow it (for now)</span>
<span class="s1">_566_FIELDS = _426_FIELDS + (</span><span class="s4">'Description-Content-Type'</span><span class="s3">, </span><span class="s4">'Requires'</span><span class="s1">)</span>

<span class="s1">_566_MARKERS = (</span><span class="s4">'Description-Content-Type'</span><span class="s3">,</span><span class="s1">)</span>

<span class="s1">_ALL_FIELDS = set()</span>
<span class="s1">_ALL_FIELDS.update(_241_FIELDS)</span>
<span class="s1">_ALL_FIELDS.update(_314_FIELDS)</span>
<span class="s1">_ALL_FIELDS.update(_345_FIELDS)</span>
<span class="s1">_ALL_FIELDS.update(_426_FIELDS)</span>
<span class="s1">_ALL_FIELDS.update(_566_FIELDS)</span>

<span class="s1">EXTRA_RE = re.compile(</span><span class="s4">r'''extra\s*==\s*(&quot;([^&quot;]+)&quot;|'([^']+)')'''</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">_version2fieldlist(version):</span>
    <span class="s3">if </span><span class="s1">version == </span><span class="s4">'1.0'</span><span class="s1">:</span>
        <span class="s3">return </span><span class="s1">_241_FIELDS</span>
    <span class="s3">elif </span><span class="s1">version == </span><span class="s4">'1.1'</span><span class="s1">:</span>
        <span class="s3">return </span><span class="s1">_314_FIELDS</span>
    <span class="s3">elif </span><span class="s1">version == </span><span class="s4">'1.2'</span><span class="s1">:</span>
        <span class="s3">return </span><span class="s1">_345_FIELDS</span>
    <span class="s3">elif </span><span class="s1">version </span><span class="s3">in </span><span class="s1">(</span><span class="s4">'1.3'</span><span class="s3">, </span><span class="s4">'2.1'</span><span class="s1">):</span>
        <span class="s3">return </span><span class="s1">_345_FIELDS + _566_FIELDS</span>
    <span class="s3">elif </span><span class="s1">version == </span><span class="s4">'2.0'</span><span class="s1">:</span>
        <span class="s3">return </span><span class="s1">_426_FIELDS</span>
    <span class="s3">raise </span><span class="s1">MetadataUnrecognizedVersionError(version)</span>


<span class="s3">def </span><span class="s1">_best_version(fields):</span>
    <span class="s2">&quot;&quot;&quot;Detect the best version depending on the fields used.&quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">_has_marker(keys</span><span class="s3">, </span><span class="s1">markers):</span>
        <span class="s3">for </span><span class="s1">marker </span><span class="s3">in </span><span class="s1">markers:</span>
            <span class="s3">if </span><span class="s1">marker </span><span class="s3">in </span><span class="s1">keys:</span>
                <span class="s3">return True</span>
        <span class="s3">return False</span>

    <span class="s1">keys = []</span>
    <span class="s3">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">fields.items():</span>
        <span class="s3">if </span><span class="s1">value </span><span class="s3">in </span><span class="s1">([]</span><span class="s3">, </span><span class="s4">'UNKNOWN'</span><span class="s3">, None</span><span class="s1">):</span>
            <span class="s3">continue</span>
        <span class="s1">keys.append(key)</span>

    <span class="s1">possible_versions = [</span><span class="s4">'1.0'</span><span class="s3">, </span><span class="s4">'1.1'</span><span class="s3">, </span><span class="s4">'1.2'</span><span class="s3">, </span><span class="s4">'1.3'</span><span class="s3">, </span><span class="s4">'2.0'</span><span class="s3">, </span><span class="s4">'2.1'</span><span class="s1">]</span>

    <span class="s0"># first let's try to see if a field is not part of one of the version</span>
    <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">keys:</span>
        <span class="s3">if </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">_241_FIELDS </span><span class="s3">and </span><span class="s4">'1.0' </span><span class="s3">in </span><span class="s1">possible_versions:</span>
            <span class="s1">possible_versions.remove(</span><span class="s4">'1.0'</span><span class="s1">)</span>
            <span class="s1">logger.debug(</span><span class="s4">'Removed 1.0 due to %s'</span><span class="s3">, </span><span class="s1">key)</span>
        <span class="s3">if </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">_314_FIELDS </span><span class="s3">and </span><span class="s4">'1.1' </span><span class="s3">in </span><span class="s1">possible_versions:</span>
            <span class="s1">possible_versions.remove(</span><span class="s4">'1.1'</span><span class="s1">)</span>
            <span class="s1">logger.debug(</span><span class="s4">'Removed 1.1 due to %s'</span><span class="s3">, </span><span class="s1">key)</span>
        <span class="s3">if </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">_345_FIELDS </span><span class="s3">and </span><span class="s4">'1.2' </span><span class="s3">in </span><span class="s1">possible_versions:</span>
            <span class="s1">possible_versions.remove(</span><span class="s4">'1.2'</span><span class="s1">)</span>
            <span class="s1">logger.debug(</span><span class="s4">'Removed 1.2 due to %s'</span><span class="s3">, </span><span class="s1">key)</span>
        <span class="s3">if </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">_566_FIELDS </span><span class="s3">and </span><span class="s4">'1.3' </span><span class="s3">in </span><span class="s1">possible_versions:</span>
            <span class="s1">possible_versions.remove(</span><span class="s4">'1.3'</span><span class="s1">)</span>
            <span class="s1">logger.debug(</span><span class="s4">'Removed 1.3 due to %s'</span><span class="s3">, </span><span class="s1">key)</span>
        <span class="s3">if </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">_566_FIELDS </span><span class="s3">and </span><span class="s4">'2.1' </span><span class="s3">in </span><span class="s1">possible_versions:</span>
            <span class="s3">if </span><span class="s1">key != </span><span class="s4">'Description'</span><span class="s1">:  </span><span class="s0"># In 2.1, description allowed after headers</span>
                <span class="s1">possible_versions.remove(</span><span class="s4">'2.1'</span><span class="s1">)</span>
                <span class="s1">logger.debug(</span><span class="s4">'Removed 2.1 due to %s'</span><span class="s3">, </span><span class="s1">key)</span>
        <span class="s3">if </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">_426_FIELDS </span><span class="s3">and </span><span class="s4">'2.0' </span><span class="s3">in </span><span class="s1">possible_versions:</span>
            <span class="s1">possible_versions.remove(</span><span class="s4">'2.0'</span><span class="s1">)</span>
            <span class="s1">logger.debug(</span><span class="s4">'Removed 2.0 due to %s'</span><span class="s3">, </span><span class="s1">key)</span>

    <span class="s0"># possible_version contains qualified versions</span>
    <span class="s3">if </span><span class="s1">len(possible_versions) == </span><span class="s5">1</span><span class="s1">:</span>
        <span class="s3">return </span><span class="s1">possible_versions[</span><span class="s5">0</span><span class="s1">]   </span><span class="s0"># found !</span>
    <span class="s3">elif </span><span class="s1">len(possible_versions) == </span><span class="s5">0</span><span class="s1">:</span>
        <span class="s1">logger.debug(</span><span class="s4">'Out of options - unknown metadata set: %s'</span><span class="s3">, </span><span class="s1">fields)</span>
        <span class="s3">raise </span><span class="s1">MetadataConflictError(</span><span class="s4">'Unknown metadata set'</span><span class="s1">)</span>

    <span class="s0"># let's see if one unique marker is found</span>
    <span class="s1">is_1_1 = </span><span class="s4">'1.1' </span><span class="s3">in </span><span class="s1">possible_versions </span><span class="s3">and </span><span class="s1">_has_marker(keys</span><span class="s3">, </span><span class="s1">_314_MARKERS)</span>
    <span class="s1">is_1_2 = </span><span class="s4">'1.2' </span><span class="s3">in </span><span class="s1">possible_versions </span><span class="s3">and </span><span class="s1">_has_marker(keys</span><span class="s3">, </span><span class="s1">_345_MARKERS)</span>
    <span class="s1">is_2_1 = </span><span class="s4">'2.1' </span><span class="s3">in </span><span class="s1">possible_versions </span><span class="s3">and </span><span class="s1">_has_marker(keys</span><span class="s3">, </span><span class="s1">_566_MARKERS)</span>
    <span class="s1">is_2_0 = </span><span class="s4">'2.0' </span><span class="s3">in </span><span class="s1">possible_versions </span><span class="s3">and </span><span class="s1">_has_marker(keys</span><span class="s3">, </span><span class="s1">_426_MARKERS)</span>
    <span class="s3">if </span><span class="s1">int(is_1_1) + int(is_1_2) + int(is_2_1) + int(is_2_0) &gt; </span><span class="s5">1</span><span class="s1">:</span>
        <span class="s3">raise </span><span class="s1">MetadataConflictError(</span><span class="s4">'You used incompatible 1.1/1.2/2.0/2.1 fields'</span><span class="s1">)</span>

    <span class="s0"># we have the choice, 1.0, or 1.2, or 2.0</span>
    <span class="s0">#   - 1.0 has a broken Summary field but works with all tools</span>
    <span class="s0">#   - 1.1 is to avoid</span>
    <span class="s0">#   - 1.2 fixes Summary but has little adoption</span>
    <span class="s0">#   - 2.0 adds more features and is very new</span>
    <span class="s3">if not </span><span class="s1">is_1_1 </span><span class="s3">and not </span><span class="s1">is_1_2 </span><span class="s3">and not </span><span class="s1">is_2_1 </span><span class="s3">and not </span><span class="s1">is_2_0:</span>
        <span class="s0"># we couldn't find any specific marker</span>
        <span class="s3">if </span><span class="s1">PKG_INFO_PREFERRED_VERSION </span><span class="s3">in </span><span class="s1">possible_versions:</span>
            <span class="s3">return </span><span class="s1">PKG_INFO_PREFERRED_VERSION</span>
    <span class="s3">if </span><span class="s1">is_1_1:</span>
        <span class="s3">return </span><span class="s4">'1.1'</span>
    <span class="s3">if </span><span class="s1">is_1_2:</span>
        <span class="s3">return </span><span class="s4">'1.2'</span>
    <span class="s3">if </span><span class="s1">is_2_1:</span>
        <span class="s3">return </span><span class="s4">'2.1'</span>

    <span class="s3">return </span><span class="s4">'2.0'</span>

<span class="s1">_ATTR2FIELD = {</span>
    <span class="s4">'metadata_version'</span><span class="s1">: </span><span class="s4">'Metadata-Version'</span><span class="s3">,</span>
    <span class="s4">'name'</span><span class="s1">: </span><span class="s4">'Name'</span><span class="s3">,</span>
    <span class="s4">'version'</span><span class="s1">: </span><span class="s4">'Version'</span><span class="s3">,</span>
    <span class="s4">'platform'</span><span class="s1">: </span><span class="s4">'Platform'</span><span class="s3">,</span>
    <span class="s4">'supported_platform'</span><span class="s1">: </span><span class="s4">'Supported-Platform'</span><span class="s3">,</span>
    <span class="s4">'summary'</span><span class="s1">: </span><span class="s4">'Summary'</span><span class="s3">,</span>
    <span class="s4">'description'</span><span class="s1">: </span><span class="s4">'Description'</span><span class="s3">,</span>
    <span class="s4">'keywords'</span><span class="s1">: </span><span class="s4">'Keywords'</span><span class="s3">,</span>
    <span class="s4">'home_page'</span><span class="s1">: </span><span class="s4">'Home-page'</span><span class="s3">,</span>
    <span class="s4">'author'</span><span class="s1">: </span><span class="s4">'Author'</span><span class="s3">,</span>
    <span class="s4">'author_email'</span><span class="s1">: </span><span class="s4">'Author-email'</span><span class="s3">,</span>
    <span class="s4">'maintainer'</span><span class="s1">: </span><span class="s4">'Maintainer'</span><span class="s3">,</span>
    <span class="s4">'maintainer_email'</span><span class="s1">: </span><span class="s4">'Maintainer-email'</span><span class="s3">,</span>
    <span class="s4">'license'</span><span class="s1">: </span><span class="s4">'License'</span><span class="s3">,</span>
    <span class="s4">'classifier'</span><span class="s1">: </span><span class="s4">'Classifier'</span><span class="s3">,</span>
    <span class="s4">'download_url'</span><span class="s1">: </span><span class="s4">'Download-URL'</span><span class="s3">,</span>
    <span class="s4">'obsoletes_dist'</span><span class="s1">: </span><span class="s4">'Obsoletes-Dist'</span><span class="s3">,</span>
    <span class="s4">'provides_dist'</span><span class="s1">: </span><span class="s4">'Provides-Dist'</span><span class="s3">,</span>
    <span class="s4">'requires_dist'</span><span class="s1">: </span><span class="s4">'Requires-Dist'</span><span class="s3">,</span>
    <span class="s4">'setup_requires_dist'</span><span class="s1">: </span><span class="s4">'Setup-Requires-Dist'</span><span class="s3">,</span>
    <span class="s4">'requires_python'</span><span class="s1">: </span><span class="s4">'Requires-Python'</span><span class="s3">,</span>
    <span class="s4">'requires_external'</span><span class="s1">: </span><span class="s4">'Requires-External'</span><span class="s3">,</span>
    <span class="s4">'requires'</span><span class="s1">: </span><span class="s4">'Requires'</span><span class="s3">,</span>
    <span class="s4">'provides'</span><span class="s1">: </span><span class="s4">'Provides'</span><span class="s3">,</span>
    <span class="s4">'obsoletes'</span><span class="s1">: </span><span class="s4">'Obsoletes'</span><span class="s3">,</span>
    <span class="s4">'project_url'</span><span class="s1">: </span><span class="s4">'Project-URL'</span><span class="s3">,</span>
    <span class="s4">'private_version'</span><span class="s1">: </span><span class="s4">'Private-Version'</span><span class="s3">,</span>
    <span class="s4">'obsoleted_by'</span><span class="s1">: </span><span class="s4">'Obsoleted-By'</span><span class="s3">,</span>
    <span class="s4">'extension'</span><span class="s1">: </span><span class="s4">'Extension'</span><span class="s3">,</span>
    <span class="s4">'provides_extra'</span><span class="s1">: </span><span class="s4">'Provides-Extra'</span><span class="s3">,</span>
<span class="s1">}</span>

<span class="s1">_PREDICATE_FIELDS = (</span><span class="s4">'Requires-Dist'</span><span class="s3">, </span><span class="s4">'Obsoletes-Dist'</span><span class="s3">, </span><span class="s4">'Provides-Dist'</span><span class="s1">)</span>
<span class="s1">_VERSIONS_FIELDS = (</span><span class="s4">'Requires-Python'</span><span class="s3">,</span><span class="s1">)</span>
<span class="s1">_VERSION_FIELDS = (</span><span class="s4">'Version'</span><span class="s3">,</span><span class="s1">)</span>
<span class="s1">_LISTFIELDS = (</span><span class="s4">'Platform'</span><span class="s3">, </span><span class="s4">'Classifier'</span><span class="s3">, </span><span class="s4">'Obsoletes'</span><span class="s3">,</span>
               <span class="s4">'Requires'</span><span class="s3">, </span><span class="s4">'Provides'</span><span class="s3">, </span><span class="s4">'Obsoletes-Dist'</span><span class="s3">,</span>
               <span class="s4">'Provides-Dist'</span><span class="s3">, </span><span class="s4">'Requires-Dist'</span><span class="s3">, </span><span class="s4">'Requires-External'</span><span class="s3">,</span>
               <span class="s4">'Project-URL'</span><span class="s3">, </span><span class="s4">'Supported-Platform'</span><span class="s3">, </span><span class="s4">'Setup-Requires-Dist'</span><span class="s3">,</span>
               <span class="s4">'Provides-Extra'</span><span class="s3">, </span><span class="s4">'Extension'</span><span class="s1">)</span>
<span class="s1">_LISTTUPLEFIELDS = (</span><span class="s4">'Project-URL'</span><span class="s3">,</span><span class="s1">)</span>

<span class="s1">_ELEMENTSFIELD = (</span><span class="s4">'Keywords'</span><span class="s3">,</span><span class="s1">)</span>

<span class="s1">_UNICODEFIELDS = (</span><span class="s4">'Author'</span><span class="s3">, </span><span class="s4">'Maintainer'</span><span class="s3">, </span><span class="s4">'Summary'</span><span class="s3">, </span><span class="s4">'Description'</span><span class="s1">)</span>

<span class="s1">_MISSING = object()</span>

<span class="s1">_FILESAFE = re.compile(</span><span class="s4">'[^A-Za-z0-9.]+'</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">_get_name_and_version(name</span><span class="s3">, </span><span class="s1">version</span><span class="s3">, </span><span class="s1">for_filename=</span><span class="s3">False</span><span class="s1">):</span>
    <span class="s2">&quot;&quot;&quot;Return the distribution name with version. 
 
    If for_filename is true, return a filename-escaped form.&quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">for_filename:</span>
        <span class="s0"># For both name and version any runs of non-alphanumeric or '.'</span>
        <span class="s0"># characters are replaced with a single '-'.  Additionally any</span>
        <span class="s0"># spaces in the version string become '.'</span>
        <span class="s1">name = _FILESAFE.sub(</span><span class="s4">'-'</span><span class="s3">, </span><span class="s1">name)</span>
        <span class="s1">version = _FILESAFE.sub(</span><span class="s4">'-'</span><span class="s3">, </span><span class="s1">version.replace(</span><span class="s4">' '</span><span class="s3">, </span><span class="s4">'.'</span><span class="s1">))</span>
    <span class="s3">return </span><span class="s4">'%s-%s' </span><span class="s1">% (name</span><span class="s3">, </span><span class="s1">version)</span>


<span class="s3">class </span><span class="s1">LegacyMetadata(object):</span>
    <span class="s2">&quot;&quot;&quot;The legacy metadata of a release. 
 
    Supports versions 1.0, 1.1 and 1.2 (auto-detected). You can 
    instantiate the class with one of these arguments (or none): 
    - *path*, the path to a metadata file 
    - *fileobj* give a file-like object with metadata as content 
    - *mapping* is a dict-like object 
    - *scheme* is a version scheme name 
    &quot;&quot;&quot;</span>
    <span class="s0"># TODO document the mapping API and UNKNOWN default key</span>

    <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">path=</span><span class="s3">None, </span><span class="s1">fileobj=</span><span class="s3">None, </span><span class="s1">mapping=</span><span class="s3">None,</span>
                 <span class="s1">scheme=</span><span class="s4">'default'</span><span class="s1">):</span>
        <span class="s3">if </span><span class="s1">[path</span><span class="s3">, </span><span class="s1">fileobj</span><span class="s3">, </span><span class="s1">mapping].count(</span><span class="s3">None</span><span class="s1">) &lt; </span><span class="s5">2</span><span class="s1">:</span>
            <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">'path, fileobj and mapping are exclusive'</span><span class="s1">)</span>
        <span class="s1">self._fields = {}</span>
        <span class="s1">self.requires_files = []</span>
        <span class="s1">self._dependencies = </span><span class="s3">None</span>
        <span class="s1">self.scheme = scheme</span>
        <span class="s3">if </span><span class="s1">path </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s1">self.read(path)</span>
        <span class="s3">elif </span><span class="s1">fileobj </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s1">self.read_file(fileobj)</span>
        <span class="s3">elif </span><span class="s1">mapping </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s1">self.update(mapping)</span>
            <span class="s1">self.set_metadata_version()</span>

    <span class="s3">def </span><span class="s1">set_metadata_version(self):</span>
        <span class="s1">self._fields[</span><span class="s4">'Metadata-Version'</span><span class="s1">] = _best_version(self._fields)</span>

    <span class="s3">def </span><span class="s1">_write_field(self</span><span class="s3">, </span><span class="s1">fileobj</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">value):</span>
        <span class="s1">fileobj.write(</span><span class="s4">'%s: %s</span><span class="s3">\n</span><span class="s4">' </span><span class="s1">% (name</span><span class="s3">, </span><span class="s1">value))</span>

    <span class="s3">def </span><span class="s1">__getitem__(self</span><span class="s3">, </span><span class="s1">name):</span>
        <span class="s3">return </span><span class="s1">self.get(name)</span>

    <span class="s3">def </span><span class="s1">__setitem__(self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">value):</span>
        <span class="s3">return </span><span class="s1">self.set(name</span><span class="s3">, </span><span class="s1">value)</span>

    <span class="s3">def </span><span class="s1">__delitem__(self</span><span class="s3">, </span><span class="s1">name):</span>
        <span class="s1">field_name = self._convert_name(name)</span>
        <span class="s3">try</span><span class="s1">:</span>
            <span class="s3">del </span><span class="s1">self._fields[field_name]</span>
        <span class="s3">except </span><span class="s1">KeyError:</span>
            <span class="s3">raise </span><span class="s1">KeyError(name)</span>

    <span class="s3">def </span><span class="s1">__contains__(self</span><span class="s3">, </span><span class="s1">name):</span>
        <span class="s3">return </span><span class="s1">(name </span><span class="s3">in </span><span class="s1">self._fields </span><span class="s3">or</span>
                <span class="s1">self._convert_name(name) </span><span class="s3">in </span><span class="s1">self._fields)</span>

    <span class="s3">def </span><span class="s1">_convert_name(self</span><span class="s3">, </span><span class="s1">name):</span>
        <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">_ALL_FIELDS:</span>
            <span class="s3">return </span><span class="s1">name</span>
        <span class="s1">name = name.replace(</span><span class="s4">'-'</span><span class="s3">, </span><span class="s4">'_'</span><span class="s1">).lower()</span>
        <span class="s3">return </span><span class="s1">_ATTR2FIELD.get(name</span><span class="s3">, </span><span class="s1">name)</span>

    <span class="s3">def </span><span class="s1">_default_value(self</span><span class="s3">, </span><span class="s1">name):</span>
        <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">_LISTFIELDS </span><span class="s3">or </span><span class="s1">name </span><span class="s3">in </span><span class="s1">_ELEMENTSFIELD:</span>
            <span class="s3">return </span><span class="s1">[]</span>
        <span class="s3">return </span><span class="s4">'UNKNOWN'</span>

    <span class="s3">def </span><span class="s1">_remove_line_prefix(self</span><span class="s3">, </span><span class="s1">value):</span>
        <span class="s3">if </span><span class="s1">self.metadata_version </span><span class="s3">in </span><span class="s1">(</span><span class="s4">'1.0'</span><span class="s3">, </span><span class="s4">'1.1'</span><span class="s1">):</span>
            <span class="s3">return </span><span class="s1">_LINE_PREFIX_PRE_1_2.sub(</span><span class="s4">'</span><span class="s3">\n</span><span class="s4">'</span><span class="s3">, </span><span class="s1">value)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s1">_LINE_PREFIX_1_2.sub(</span><span class="s4">'</span><span class="s3">\n</span><span class="s4">'</span><span class="s3">, </span><span class="s1">value)</span>

    <span class="s3">def </span><span class="s1">__getattr__(self</span><span class="s3">, </span><span class="s1">name):</span>
        <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">_ATTR2FIELD:</span>
            <span class="s3">return </span><span class="s1">self[name]</span>
        <span class="s3">raise </span><span class="s1">AttributeError(name)</span>

    <span class="s0">#</span>
    <span class="s0"># Public API</span>
    <span class="s0">#</span>

<span class="s0">#    dependencies = property(_get_dependencies, _set_dependencies)</span>

    <span class="s3">def </span><span class="s1">get_fullname(self</span><span class="s3">, </span><span class="s1">filesafe=</span><span class="s3">False</span><span class="s1">):</span>
        <span class="s2">&quot;&quot;&quot;Return the distribution name with version. 
 
        If filesafe is true, return a filename-escaped form.&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">_get_name_and_version(self[</span><span class="s4">'Name'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">self[</span><span class="s4">'Version'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">filesafe)</span>

    <span class="s3">def </span><span class="s1">is_field(self</span><span class="s3">, </span><span class="s1">name):</span>
        <span class="s2">&quot;&quot;&quot;return True if name is a valid metadata key&quot;&quot;&quot;</span>
        <span class="s1">name = self._convert_name(name)</span>
        <span class="s3">return </span><span class="s1">name </span><span class="s3">in </span><span class="s1">_ALL_FIELDS</span>

    <span class="s3">def </span><span class="s1">is_multi_field(self</span><span class="s3">, </span><span class="s1">name):</span>
        <span class="s1">name = self._convert_name(name)</span>
        <span class="s3">return </span><span class="s1">name </span><span class="s3">in </span><span class="s1">_LISTFIELDS</span>

    <span class="s3">def </span><span class="s1">read(self</span><span class="s3">, </span><span class="s1">filepath):</span>
        <span class="s2">&quot;&quot;&quot;Read the metadata values from a file path.&quot;&quot;&quot;</span>
        <span class="s1">fp = codecs.open(filepath</span><span class="s3">, </span><span class="s4">'r'</span><span class="s3">, </span><span class="s1">encoding=</span><span class="s4">'utf-8'</span><span class="s1">)</span>
        <span class="s3">try</span><span class="s1">:</span>
            <span class="s1">self.read_file(fp)</span>
        <span class="s3">finally</span><span class="s1">:</span>
            <span class="s1">fp.close()</span>

    <span class="s3">def </span><span class="s1">read_file(self</span><span class="s3">, </span><span class="s1">fileob):</span>
        <span class="s2">&quot;&quot;&quot;Read the metadata values from a file object.&quot;&quot;&quot;</span>
        <span class="s1">msg = message_from_file(fileob)</span>
        <span class="s1">self._fields[</span><span class="s4">'Metadata-Version'</span><span class="s1">] = msg[</span><span class="s4">'metadata-version'</span><span class="s1">]</span>

        <span class="s0"># When reading, get all the fields we can</span>
        <span class="s3">for </span><span class="s1">field </span><span class="s3">in </span><span class="s1">_ALL_FIELDS:</span>
            <span class="s3">if </span><span class="s1">field </span><span class="s3">not in </span><span class="s1">msg:</span>
                <span class="s3">continue</span>
            <span class="s3">if </span><span class="s1">field </span><span class="s3">in </span><span class="s1">_LISTFIELDS:</span>
                <span class="s0"># we can have multiple lines</span>
                <span class="s1">values = msg.get_all(field)</span>
                <span class="s3">if </span><span class="s1">field </span><span class="s3">in </span><span class="s1">_LISTTUPLEFIELDS </span><span class="s3">and </span><span class="s1">values </span><span class="s3">is not None</span><span class="s1">:</span>
                    <span class="s1">values = [tuple(value.split(</span><span class="s4">','</span><span class="s1">)) </span><span class="s3">for </span><span class="s1">value </span><span class="s3">in </span><span class="s1">values]</span>
                <span class="s1">self.set(field</span><span class="s3">, </span><span class="s1">values)</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s0"># single line</span>
                <span class="s1">value = msg[field]</span>
                <span class="s3">if </span><span class="s1">value </span><span class="s3">is not None and </span><span class="s1">value != </span><span class="s4">'UNKNOWN'</span><span class="s1">:</span>
                    <span class="s1">self.set(field</span><span class="s3">, </span><span class="s1">value)</span>
        <span class="s0"># logger.debug('Attempting to set metadata for %s', self)</span>
        <span class="s0"># self.set_metadata_version()</span>

    <span class="s3">def </span><span class="s1">write(self</span><span class="s3">, </span><span class="s1">filepath</span><span class="s3">, </span><span class="s1">skip_unknown=</span><span class="s3">False</span><span class="s1">):</span>
        <span class="s2">&quot;&quot;&quot;Write the metadata fields to filepath.&quot;&quot;&quot;</span>
        <span class="s1">fp = codecs.open(filepath</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">, </span><span class="s1">encoding=</span><span class="s4">'utf-8'</span><span class="s1">)</span>
        <span class="s3">try</span><span class="s1">:</span>
            <span class="s1">self.write_file(fp</span><span class="s3">, </span><span class="s1">skip_unknown)</span>
        <span class="s3">finally</span><span class="s1">:</span>
            <span class="s1">fp.close()</span>

    <span class="s3">def </span><span class="s1">write_file(self</span><span class="s3">, </span><span class="s1">fileobject</span><span class="s3">, </span><span class="s1">skip_unknown=</span><span class="s3">False</span><span class="s1">):</span>
        <span class="s2">&quot;&quot;&quot;Write the PKG-INFO format data to a file object.&quot;&quot;&quot;</span>
        <span class="s1">self.set_metadata_version()</span>

        <span class="s3">for </span><span class="s1">field </span><span class="s3">in </span><span class="s1">_version2fieldlist(self[</span><span class="s4">'Metadata-Version'</span><span class="s1">]):</span>
            <span class="s1">values = self.get(field)</span>
            <span class="s3">if </span><span class="s1">skip_unknown </span><span class="s3">and </span><span class="s1">values </span><span class="s3">in </span><span class="s1">(</span><span class="s4">'UNKNOWN'</span><span class="s3">, </span><span class="s1">[]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">'UNKNOWN'</span><span class="s1">]):</span>
                <span class="s3">continue</span>
            <span class="s3">if </span><span class="s1">field </span><span class="s3">in </span><span class="s1">_ELEMENTSFIELD:</span>
                <span class="s1">self._write_field(fileobject</span><span class="s3">, </span><span class="s1">field</span><span class="s3">, </span><span class="s4">','</span><span class="s1">.join(values))</span>
                <span class="s3">continue</span>
            <span class="s3">if </span><span class="s1">field </span><span class="s3">not in </span><span class="s1">_LISTFIELDS:</span>
                <span class="s3">if </span><span class="s1">field == </span><span class="s4">'Description'</span><span class="s1">:</span>
                    <span class="s3">if </span><span class="s1">self.metadata_version </span><span class="s3">in </span><span class="s1">(</span><span class="s4">'1.0'</span><span class="s3">, </span><span class="s4">'1.1'</span><span class="s1">):</span>
                        <span class="s1">values = values.replace(</span><span class="s4">'</span><span class="s3">\n</span><span class="s4">'</span><span class="s3">, </span><span class="s4">'</span><span class="s3">\n        </span><span class="s4">'</span><span class="s1">)</span>
                    <span class="s3">else</span><span class="s1">:</span>
                        <span class="s1">values = values.replace(</span><span class="s4">'</span><span class="s3">\n</span><span class="s4">'</span><span class="s3">, </span><span class="s4">'</span><span class="s3">\n       </span><span class="s4">|'</span><span class="s1">)</span>
                <span class="s1">values = [values]</span>

            <span class="s3">if </span><span class="s1">field </span><span class="s3">in </span><span class="s1">_LISTTUPLEFIELDS:</span>
                <span class="s1">values = [</span><span class="s4">','</span><span class="s1">.join(value) </span><span class="s3">for </span><span class="s1">value </span><span class="s3">in </span><span class="s1">values]</span>

            <span class="s3">for </span><span class="s1">value </span><span class="s3">in </span><span class="s1">values:</span>
                <span class="s1">self._write_field(fileobject</span><span class="s3">, </span><span class="s1">field</span><span class="s3">, </span><span class="s1">value)</span>

    <span class="s3">def </span><span class="s1">update(self</span><span class="s3">, </span><span class="s1">other=</span><span class="s3">None, </span><span class="s1">**kwargs):</span>
        <span class="s2">&quot;&quot;&quot;Set metadata values from the given iterable `other` and kwargs. 
 
        Behavior is like `dict.update`: If `other` has a ``keys`` method, 
        they are looped over and ``self[key]`` is assigned ``other[key]``. 
        Else, ``other`` is an iterable of ``(key, value)`` iterables. 
 
        Keys that don't match a metadata field or that have an empty value are 
        dropped. 
        &quot;&quot;&quot;</span>
        <span class="s3">def </span><span class="s1">_set(key</span><span class="s3">, </span><span class="s1">value):</span>
            <span class="s3">if </span><span class="s1">key </span><span class="s3">in </span><span class="s1">_ATTR2FIELD </span><span class="s3">and </span><span class="s1">value:</span>
                <span class="s1">self.set(self._convert_name(key)</span><span class="s3">, </span><span class="s1">value)</span>

        <span class="s3">if not </span><span class="s1">other:</span>
            <span class="s0"># other is None or empty container</span>
            <span class="s3">pass</span>
        <span class="s3">elif </span><span class="s1">hasattr(other</span><span class="s3">, </span><span class="s4">'keys'</span><span class="s1">):</span>
            <span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">other.keys():</span>
                <span class="s1">_set(k</span><span class="s3">, </span><span class="s1">other[k])</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s3">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">other:</span>
                <span class="s1">_set(k</span><span class="s3">, </span><span class="s1">v)</span>

        <span class="s3">if </span><span class="s1">kwargs:</span>
            <span class="s3">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">kwargs.items():</span>
                <span class="s1">_set(k</span><span class="s3">, </span><span class="s1">v)</span>

    <span class="s3">def </span><span class="s1">set(self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">value):</span>
        <span class="s2">&quot;&quot;&quot;Control then set a metadata field.&quot;&quot;&quot;</span>
        <span class="s1">name = self._convert_name(name)</span>

        <span class="s3">if </span><span class="s1">((name </span><span class="s3">in </span><span class="s1">_ELEMENTSFIELD </span><span class="s3">or </span><span class="s1">name == </span><span class="s4">'Platform'</span><span class="s1">) </span><span class="s3">and</span>
            <span class="s3">not </span><span class="s1">isinstance(value</span><span class="s3">, </span><span class="s1">(list</span><span class="s3">, </span><span class="s1">tuple))):</span>
            <span class="s3">if </span><span class="s1">isinstance(value</span><span class="s3">, </span><span class="s1">string_types):</span>
                <span class="s1">value = [v.strip() </span><span class="s3">for </span><span class="s1">v </span><span class="s3">in </span><span class="s1">value.split(</span><span class="s4">','</span><span class="s1">)]</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">value = []</span>
        <span class="s3">elif </span><span class="s1">(name </span><span class="s3">in </span><span class="s1">_LISTFIELDS </span><span class="s3">and</span>
              <span class="s3">not </span><span class="s1">isinstance(value</span><span class="s3">, </span><span class="s1">(list</span><span class="s3">, </span><span class="s1">tuple))):</span>
            <span class="s3">if </span><span class="s1">isinstance(value</span><span class="s3">, </span><span class="s1">string_types):</span>
                <span class="s1">value = [value]</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">value = []</span>

        <span class="s3">if </span><span class="s1">logger.isEnabledFor(logging.WARNING):</span>
            <span class="s1">project_name = self[</span><span class="s4">'Name'</span><span class="s1">]</span>

            <span class="s1">scheme = get_scheme(self.scheme)</span>
            <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">_PREDICATE_FIELDS </span><span class="s3">and </span><span class="s1">value </span><span class="s3">is not None</span><span class="s1">:</span>
                <span class="s3">for </span><span class="s1">v </span><span class="s3">in </span><span class="s1">value:</span>
                    <span class="s0"># check that the values are valid</span>
                    <span class="s3">if not </span><span class="s1">scheme.is_valid_matcher(v.split(</span><span class="s4">';'</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]):</span>
                        <span class="s1">logger.warning(</span>
                            <span class="s4">&quot;'%s': '%s' is not valid (field '%s')&quot;</span><span class="s3">,</span>
                            <span class="s1">project_name</span><span class="s3">, </span><span class="s1">v</span><span class="s3">, </span><span class="s1">name)</span>
            <span class="s0"># FIXME this rejects UNKNOWN, is that right?</span>
            <span class="s3">elif </span><span class="s1">name </span><span class="s3">in </span><span class="s1">_VERSIONS_FIELDS </span><span class="s3">and </span><span class="s1">value </span><span class="s3">is not None</span><span class="s1">:</span>
                <span class="s3">if not </span><span class="s1">scheme.is_valid_constraint_list(value):</span>
                    <span class="s1">logger.warning(</span><span class="s4">&quot;'%s': '%s' is not a valid version (field '%s')&quot;</span><span class="s3">,</span>
                                   <span class="s1">project_name</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, </span><span class="s1">name)</span>
            <span class="s3">elif </span><span class="s1">name </span><span class="s3">in </span><span class="s1">_VERSION_FIELDS </span><span class="s3">and </span><span class="s1">value </span><span class="s3">is not None</span><span class="s1">:</span>
                <span class="s3">if not </span><span class="s1">scheme.is_valid_version(value):</span>
                    <span class="s1">logger.warning(</span><span class="s4">&quot;'%s': '%s' is not a valid version (field '%s')&quot;</span><span class="s3">,</span>
                                   <span class="s1">project_name</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, </span><span class="s1">name)</span>

        <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">_UNICODEFIELDS:</span>
            <span class="s3">if </span><span class="s1">name == </span><span class="s4">'Description'</span><span class="s1">:</span>
                <span class="s1">value = self._remove_line_prefix(value)</span>

        <span class="s1">self._fields[name] = value</span>

    <span class="s3">def </span><span class="s1">get(self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">default=_MISSING):</span>
        <span class="s2">&quot;&quot;&quot;Get a metadata field.&quot;&quot;&quot;</span>
        <span class="s1">name = self._convert_name(name)</span>
        <span class="s3">if </span><span class="s1">name </span><span class="s3">not in </span><span class="s1">self._fields:</span>
            <span class="s3">if </span><span class="s1">default </span><span class="s3">is </span><span class="s1">_MISSING:</span>
                <span class="s1">default = self._default_value(name)</span>
            <span class="s3">return </span><span class="s1">default</span>
        <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">_UNICODEFIELDS:</span>
            <span class="s1">value = self._fields[name]</span>
            <span class="s3">return </span><span class="s1">value</span>
        <span class="s3">elif </span><span class="s1">name </span><span class="s3">in </span><span class="s1">_LISTFIELDS:</span>
            <span class="s1">value = self._fields[name]</span>
            <span class="s3">if </span><span class="s1">value </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">return </span><span class="s1">[]</span>
            <span class="s1">res = []</span>
            <span class="s3">for </span><span class="s1">val </span><span class="s3">in </span><span class="s1">value:</span>
                <span class="s3">if </span><span class="s1">name </span><span class="s3">not in </span><span class="s1">_LISTTUPLEFIELDS:</span>
                    <span class="s1">res.append(val)</span>
                <span class="s3">else</span><span class="s1">:</span>
                    <span class="s0"># That's for Project-URL</span>
                    <span class="s1">res.append((val[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">val[</span><span class="s5">1</span><span class="s1">]))</span>
            <span class="s3">return </span><span class="s1">res</span>

        <span class="s3">elif </span><span class="s1">name </span><span class="s3">in </span><span class="s1">_ELEMENTSFIELD:</span>
            <span class="s1">value = self._fields[name]</span>
            <span class="s3">if </span><span class="s1">isinstance(value</span><span class="s3">, </span><span class="s1">string_types):</span>
                <span class="s3">return </span><span class="s1">value.split(</span><span class="s4">','</span><span class="s1">)</span>
        <span class="s3">return </span><span class="s1">self._fields[name]</span>

    <span class="s3">def </span><span class="s1">check(self</span><span class="s3">, </span><span class="s1">strict=</span><span class="s3">False</span><span class="s1">):</span>
        <span class="s2">&quot;&quot;&quot;Check if the metadata is compliant. If strict is True then raise if 
        no Name or Version are provided&quot;&quot;&quot;</span>
        <span class="s1">self.set_metadata_version()</span>

        <span class="s0"># XXX should check the versions (if the file was loaded)</span>
        <span class="s1">missing</span><span class="s3">, </span><span class="s1">warnings = []</span><span class="s3">, </span><span class="s1">[]</span>

        <span class="s3">for </span><span class="s1">attr </span><span class="s3">in </span><span class="s1">(</span><span class="s4">'Name'</span><span class="s3">, </span><span class="s4">'Version'</span><span class="s1">):  </span><span class="s0"># required by PEP 345</span>
            <span class="s3">if </span><span class="s1">attr </span><span class="s3">not in </span><span class="s1">self:</span>
                <span class="s1">missing.append(attr)</span>

        <span class="s3">if </span><span class="s1">strict </span><span class="s3">and </span><span class="s1">missing != []:</span>
            <span class="s1">msg = </span><span class="s4">'missing required metadata: %s' </span><span class="s1">% </span><span class="s4">', '</span><span class="s1">.join(missing)</span>
            <span class="s3">raise </span><span class="s1">MetadataMissingError(msg)</span>

        <span class="s3">for </span><span class="s1">attr </span><span class="s3">in </span><span class="s1">(</span><span class="s4">'Home-page'</span><span class="s3">, </span><span class="s4">'Author'</span><span class="s1">):</span>
            <span class="s3">if </span><span class="s1">attr </span><span class="s3">not in </span><span class="s1">self:</span>
                <span class="s1">missing.append(attr)</span>

        <span class="s0"># checking metadata 1.2 (XXX needs to check 1.1, 1.0)</span>
        <span class="s3">if </span><span class="s1">self[</span><span class="s4">'Metadata-Version'</span><span class="s1">] != </span><span class="s4">'1.2'</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s1">missing</span><span class="s3">, </span><span class="s1">warnings</span>

        <span class="s1">scheme = get_scheme(self.scheme)</span>

        <span class="s3">def </span><span class="s1">are_valid_constraints(value):</span>
            <span class="s3">for </span><span class="s1">v </span><span class="s3">in </span><span class="s1">value:</span>
                <span class="s3">if not </span><span class="s1">scheme.is_valid_matcher(v.split(</span><span class="s4">';'</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]):</span>
                    <span class="s3">return False</span>
            <span class="s3">return True</span>

        <span class="s3">for </span><span class="s1">fields</span><span class="s3">, </span><span class="s1">controller </span><span class="s3">in </span><span class="s1">((_PREDICATE_FIELDS</span><span class="s3">, </span><span class="s1">are_valid_constraints)</span><span class="s3">,</span>
                                   <span class="s1">(_VERSIONS_FIELDS</span><span class="s3">,</span>
                                    <span class="s1">scheme.is_valid_constraint_list)</span><span class="s3">,</span>
                                   <span class="s1">(_VERSION_FIELDS</span><span class="s3">,</span>
                                    <span class="s1">scheme.is_valid_version)):</span>
            <span class="s3">for </span><span class="s1">field </span><span class="s3">in </span><span class="s1">fields:</span>
                <span class="s1">value = self.get(field</span><span class="s3">, None</span><span class="s1">)</span>
                <span class="s3">if </span><span class="s1">value </span><span class="s3">is not None and not </span><span class="s1">controller(value):</span>
                    <span class="s1">warnings.append(</span><span class="s4">&quot;Wrong value for '%s': %s&quot; </span><span class="s1">% (field</span><span class="s3">, </span><span class="s1">value))</span>

        <span class="s3">return </span><span class="s1">missing</span><span class="s3">, </span><span class="s1">warnings</span>

    <span class="s3">def </span><span class="s1">todict(self</span><span class="s3">, </span><span class="s1">skip_missing=</span><span class="s3">False</span><span class="s1">):</span>
        <span class="s2">&quot;&quot;&quot;Return fields as a dict. 
 
        Field names will be converted to use the underscore-lowercase style 
        instead of hyphen-mixed case (i.e. home_page instead of Home-page). 
        &quot;&quot;&quot;</span>
        <span class="s1">self.set_metadata_version()</span>

        <span class="s1">mapping_1_0 = (</span>
            <span class="s1">(</span><span class="s4">'metadata_version'</span><span class="s3">, </span><span class="s4">'Metadata-Version'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">'name'</span><span class="s3">, </span><span class="s4">'Name'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">'version'</span><span class="s3">, </span><span class="s4">'Version'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">'summary'</span><span class="s3">, </span><span class="s4">'Summary'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">'home_page'</span><span class="s3">, </span><span class="s4">'Home-page'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">'author'</span><span class="s3">, </span><span class="s4">'Author'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">'author_email'</span><span class="s3">, </span><span class="s4">'Author-email'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">'license'</span><span class="s3">, </span><span class="s4">'License'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">'description'</span><span class="s3">, </span><span class="s4">'Description'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">'keywords'</span><span class="s3">, </span><span class="s4">'Keywords'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">'platform'</span><span class="s3">, </span><span class="s4">'Platform'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">'classifiers'</span><span class="s3">, </span><span class="s4">'Classifier'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">(</span><span class="s4">'download_url'</span><span class="s3">, </span><span class="s4">'Download-URL'</span><span class="s1">)</span><span class="s3">,</span>
        <span class="s1">)</span>

        <span class="s1">data = {}</span>
        <span class="s3">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">field_name </span><span class="s3">in </span><span class="s1">mapping_1_0:</span>
            <span class="s3">if not </span><span class="s1">skip_missing </span><span class="s3">or </span><span class="s1">field_name </span><span class="s3">in </span><span class="s1">self._fields:</span>
                <span class="s1">data[key] = self[field_name]</span>

        <span class="s3">if </span><span class="s1">self[</span><span class="s4">'Metadata-Version'</span><span class="s1">] == </span><span class="s4">'1.2'</span><span class="s1">:</span>
            <span class="s1">mapping_1_2 = (</span>
                <span class="s1">(</span><span class="s4">'requires_dist'</span><span class="s3">, </span><span class="s4">'Requires-Dist'</span><span class="s1">)</span><span class="s3">,</span>
                <span class="s1">(</span><span class="s4">'requires_python'</span><span class="s3">, </span><span class="s4">'Requires-Python'</span><span class="s1">)</span><span class="s3">,</span>
                <span class="s1">(</span><span class="s4">'requires_external'</span><span class="s3">, </span><span class="s4">'Requires-External'</span><span class="s1">)</span><span class="s3">,</span>
                <span class="s1">(</span><span class="s4">'provides_dist'</span><span class="s3">, </span><span class="s4">'Provides-Dist'</span><span class="s1">)</span><span class="s3">,</span>
                <span class="s1">(</span><span class="s4">'obsoletes_dist'</span><span class="s3">, </span><span class="s4">'Obsoletes-Dist'</span><span class="s1">)</span><span class="s3">,</span>
                <span class="s1">(</span><span class="s4">'project_url'</span><span class="s3">, </span><span class="s4">'Project-URL'</span><span class="s1">)</span><span class="s3">,</span>
                <span class="s1">(</span><span class="s4">'maintainer'</span><span class="s3">, </span><span class="s4">'Maintainer'</span><span class="s1">)</span><span class="s3">,</span>
                <span class="s1">(</span><span class="s4">'maintainer_email'</span><span class="s3">, </span><span class="s4">'Maintainer-email'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">)</span>
            <span class="s3">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">field_name </span><span class="s3">in </span><span class="s1">mapping_1_2:</span>
                <span class="s3">if not </span><span class="s1">skip_missing </span><span class="s3">or </span><span class="s1">field_name </span><span class="s3">in </span><span class="s1">self._fields:</span>
                    <span class="s3">if </span><span class="s1">key != </span><span class="s4">'project_url'</span><span class="s1">:</span>
                        <span class="s1">data[key] = self[field_name]</span>
                    <span class="s3">else</span><span class="s1">:</span>
                        <span class="s1">data[key] = [</span><span class="s4">','</span><span class="s1">.join(u) </span><span class="s3">for </span><span class="s1">u </span><span class="s3">in </span><span class="s1">self[field_name]]</span>

        <span class="s3">elif </span><span class="s1">self[</span><span class="s4">'Metadata-Version'</span><span class="s1">] == </span><span class="s4">'1.1'</span><span class="s1">:</span>
            <span class="s1">mapping_1_1 = (</span>
                <span class="s1">(</span><span class="s4">'provides'</span><span class="s3">, </span><span class="s4">'Provides'</span><span class="s1">)</span><span class="s3">,</span>
                <span class="s1">(</span><span class="s4">'requires'</span><span class="s3">, </span><span class="s4">'Requires'</span><span class="s1">)</span><span class="s3">,</span>
                <span class="s1">(</span><span class="s4">'obsoletes'</span><span class="s3">, </span><span class="s4">'Obsoletes'</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">)</span>
            <span class="s3">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">field_name </span><span class="s3">in </span><span class="s1">mapping_1_1:</span>
                <span class="s3">if not </span><span class="s1">skip_missing </span><span class="s3">or </span><span class="s1">field_name </span><span class="s3">in </span><span class="s1">self._fields:</span>
                    <span class="s1">data[key] = self[field_name]</span>

        <span class="s3">return </span><span class="s1">data</span>

    <span class="s3">def </span><span class="s1">add_requirements(self</span><span class="s3">, </span><span class="s1">requirements):</span>
        <span class="s3">if </span><span class="s1">self[</span><span class="s4">'Metadata-Version'</span><span class="s1">] == </span><span class="s4">'1.1'</span><span class="s1">:</span>
            <span class="s0"># we can't have 1.1 metadata *and* Setuptools requires</span>
            <span class="s3">for </span><span class="s1">field </span><span class="s3">in </span><span class="s1">(</span><span class="s4">'Obsoletes'</span><span class="s3">, </span><span class="s4">'Requires'</span><span class="s3">, </span><span class="s4">'Provides'</span><span class="s1">):</span>
                <span class="s3">if </span><span class="s1">field </span><span class="s3">in </span><span class="s1">self:</span>
                    <span class="s3">del </span><span class="s1">self[field]</span>
        <span class="s1">self[</span><span class="s4">'Requires-Dist'</span><span class="s1">] += requirements</span>

    <span class="s0"># Mapping API</span>
    <span class="s0"># TODO could add iter* variants</span>

    <span class="s3">def </span><span class="s1">keys(self):</span>
        <span class="s3">return </span><span class="s1">list(_version2fieldlist(self[</span><span class="s4">'Metadata-Version'</span><span class="s1">]))</span>

    <span class="s3">def </span><span class="s1">__iter__(self):</span>
        <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self.keys():</span>
            <span class="s3">yield </span><span class="s1">key</span>

    <span class="s3">def </span><span class="s1">values(self):</span>
        <span class="s3">return </span><span class="s1">[self[key] </span><span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self.keys()]</span>

    <span class="s3">def </span><span class="s1">items(self):</span>
        <span class="s3">return </span><span class="s1">[(key</span><span class="s3">, </span><span class="s1">self[key]) </span><span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self.keys()]</span>

    <span class="s3">def </span><span class="s1">__repr__(self):</span>
        <span class="s3">return </span><span class="s4">'&lt;%s %s %s&gt;' </span><span class="s1">% (self.__class__.__name__</span><span class="s3">, </span><span class="s1">self.name</span><span class="s3">,</span>
                               <span class="s1">self.version)</span>


<span class="s1">METADATA_FILENAME = </span><span class="s4">'pydist.json'</span>
<span class="s1">WHEEL_METADATA_FILENAME = </span><span class="s4">'metadata.json'</span>
<span class="s1">LEGACY_METADATA_FILENAME = </span><span class="s4">'METADATA'</span>


<span class="s3">class </span><span class="s1">Metadata(object):</span>
    <span class="s2">&quot;&quot;&quot; 
    The metadata of a release. This implementation uses 2.0 (JSON) 
    metadata where possible. If not possible, it wraps a LegacyMetadata 
    instance which handles the key-value metadata format. 
    &quot;&quot;&quot;</span>

    <span class="s1">METADATA_VERSION_MATCHER = re.compile(</span><span class="s4">r'^\d+(\.\d+)*$'</span><span class="s1">)</span>

    <span class="s1">NAME_MATCHER = re.compile(</span><span class="s4">'^[0-9A-Z]([0-9A-Z_.-]*[0-9A-Z])?$'</span><span class="s3">, </span><span class="s1">re.I)</span>

    <span class="s1">VERSION_MATCHER = PEP440_VERSION_RE</span>

    <span class="s1">SUMMARY_MATCHER = re.compile(</span><span class="s4">'.{1,2047}'</span><span class="s1">)</span>

    <span class="s1">METADATA_VERSION = </span><span class="s4">'2.0'</span>

    <span class="s1">GENERATOR = </span><span class="s4">'distlib (%s)' </span><span class="s1">% __version__</span>

    <span class="s1">MANDATORY_KEYS = {</span>
        <span class="s4">'name'</span><span class="s1">: ()</span><span class="s3">,</span>
        <span class="s4">'version'</span><span class="s1">: ()</span><span class="s3">,</span>
        <span class="s4">'summary'</span><span class="s1">: (</span><span class="s4">'legacy'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">,</span>
    <span class="s1">}</span>

    <span class="s1">INDEX_KEYS = (</span><span class="s4">'name version license summary description author '</span>
                  <span class="s4">'author_email keywords platform home_page classifiers '</span>
                  <span class="s4">'download_url'</span><span class="s1">)</span>

    <span class="s1">DEPENDENCY_KEYS = (</span><span class="s4">'extras run_requires test_requires build_requires '</span>
                       <span class="s4">'dev_requires provides meta_requires obsoleted_by '</span>
                       <span class="s4">'supports_environments'</span><span class="s1">)</span>

    <span class="s1">SYNTAX_VALIDATORS = {</span>
        <span class="s4">'metadata_version'</span><span class="s1">: (METADATA_VERSION_MATCHER</span><span class="s3">, </span><span class="s1">())</span><span class="s3">,</span>
        <span class="s4">'name'</span><span class="s1">: (NAME_MATCHER</span><span class="s3">, </span><span class="s1">(</span><span class="s4">'legacy'</span><span class="s3">,</span><span class="s1">))</span><span class="s3">,</span>
        <span class="s4">'version'</span><span class="s1">: (VERSION_MATCHER</span><span class="s3">, </span><span class="s1">(</span><span class="s4">'legacy'</span><span class="s3">,</span><span class="s1">))</span><span class="s3">,</span>
        <span class="s4">'summary'</span><span class="s1">: (SUMMARY_MATCHER</span><span class="s3">, </span><span class="s1">(</span><span class="s4">'legacy'</span><span class="s3">,</span><span class="s1">))</span><span class="s3">,</span>
    <span class="s1">}</span>

    <span class="s1">__slots__ = (</span><span class="s4">'_legacy'</span><span class="s3">, </span><span class="s4">'_data'</span><span class="s3">, </span><span class="s4">'scheme'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">path=</span><span class="s3">None, </span><span class="s1">fileobj=</span><span class="s3">None, </span><span class="s1">mapping=</span><span class="s3">None,</span>
                 <span class="s1">scheme=</span><span class="s4">'default'</span><span class="s1">):</span>
        <span class="s3">if </span><span class="s1">[path</span><span class="s3">, </span><span class="s1">fileobj</span><span class="s3">, </span><span class="s1">mapping].count(</span><span class="s3">None</span><span class="s1">) &lt; </span><span class="s5">2</span><span class="s1">:</span>
            <span class="s3">raise </span><span class="s1">TypeError(</span><span class="s4">'path, fileobj and mapping are exclusive'</span><span class="s1">)</span>
        <span class="s1">self._legacy = </span><span class="s3">None</span>
        <span class="s1">self._data = </span><span class="s3">None</span>
        <span class="s1">self.scheme = scheme</span>
        <span class="s0">#import pdb; pdb.set_trace()</span>
        <span class="s3">if </span><span class="s1">mapping </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s3">try</span><span class="s1">:</span>
                <span class="s1">self._validate_mapping(mapping</span><span class="s3">, </span><span class="s1">scheme)</span>
                <span class="s1">self._data = mapping</span>
            <span class="s3">except </span><span class="s1">MetadataUnrecognizedVersionError:</span>
                <span class="s1">self._legacy = LegacyMetadata(mapping=mapping</span><span class="s3">, </span><span class="s1">scheme=scheme)</span>
                <span class="s1">self.validate()</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">data = </span><span class="s3">None</span>
            <span class="s3">if </span><span class="s1">path:</span>
                <span class="s3">with </span><span class="s1">open(path</span><span class="s3">, </span><span class="s4">'rb'</span><span class="s1">) </span><span class="s3">as </span><span class="s1">f:</span>
                    <span class="s1">data = f.read()</span>
            <span class="s3">elif </span><span class="s1">fileobj:</span>
                <span class="s1">data = fileobj.read()</span>
            <span class="s3">if </span><span class="s1">data </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s0"># Initialised with no args - to be added</span>
                <span class="s1">self._data = {</span>
                    <span class="s4">'metadata_version'</span><span class="s1">: self.METADATA_VERSION</span><span class="s3">,</span>
                    <span class="s4">'generator'</span><span class="s1">: self.GENERATOR</span><span class="s3">,</span>
                <span class="s1">}</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s3">if not </span><span class="s1">isinstance(data</span><span class="s3">, </span><span class="s1">text_type):</span>
                    <span class="s1">data = data.decode(</span><span class="s4">'utf-8'</span><span class="s1">)</span>
                <span class="s3">try</span><span class="s1">:</span>
                    <span class="s1">self._data = json.loads(data)</span>
                    <span class="s1">self._validate_mapping(self._data</span><span class="s3">, </span><span class="s1">scheme)</span>
                <span class="s3">except </span><span class="s1">ValueError:</span>
                    <span class="s0"># Note: MetadataUnrecognizedVersionError does not</span>
                    <span class="s0"># inherit from ValueError (it's a DistlibException,</span>
                    <span class="s0"># which should not inherit from ValueError).</span>
                    <span class="s0"># The ValueError comes from the json.load - if that</span>
                    <span class="s0"># succeeds and we get a validation error, we want</span>
                    <span class="s0"># that to propagate</span>
                    <span class="s1">self._legacy = LegacyMetadata(fileobj=StringIO(data)</span><span class="s3">,</span>
                                                  <span class="s1">scheme=scheme)</span>
                    <span class="s1">self.validate()</span>

    <span class="s1">common_keys = set((</span><span class="s4">'name'</span><span class="s3">, </span><span class="s4">'version'</span><span class="s3">, </span><span class="s4">'license'</span><span class="s3">, </span><span class="s4">'keywords'</span><span class="s3">, </span><span class="s4">'summary'</span><span class="s1">))</span>

    <span class="s1">none_list = (</span><span class="s3">None, </span><span class="s1">list)</span>
    <span class="s1">none_dict = (</span><span class="s3">None, </span><span class="s1">dict)</span>

    <span class="s1">mapped_keys = {</span>
        <span class="s4">'run_requires'</span><span class="s1">: (</span><span class="s4">'Requires-Dist'</span><span class="s3">, </span><span class="s1">list)</span><span class="s3">,</span>
        <span class="s4">'build_requires'</span><span class="s1">: (</span><span class="s4">'Setup-Requires-Dist'</span><span class="s3">, </span><span class="s1">list)</span><span class="s3">,</span>
        <span class="s4">'dev_requires'</span><span class="s1">: none_list</span><span class="s3">,</span>
        <span class="s4">'test_requires'</span><span class="s1">: none_list</span><span class="s3">,</span>
        <span class="s4">'meta_requires'</span><span class="s1">: none_list</span><span class="s3">,</span>
        <span class="s4">'extras'</span><span class="s1">: (</span><span class="s4">'Provides-Extra'</span><span class="s3">, </span><span class="s1">list)</span><span class="s3">,</span>
        <span class="s4">'modules'</span><span class="s1">: none_list</span><span class="s3">,</span>
        <span class="s4">'namespaces'</span><span class="s1">: none_list</span><span class="s3">,</span>
        <span class="s4">'exports'</span><span class="s1">: none_dict</span><span class="s3">,</span>
        <span class="s4">'commands'</span><span class="s1">: none_dict</span><span class="s3">,</span>
        <span class="s4">'classifiers'</span><span class="s1">: (</span><span class="s4">'Classifier'</span><span class="s3">, </span><span class="s1">list)</span><span class="s3">,</span>
        <span class="s4">'source_url'</span><span class="s1">: (</span><span class="s4">'Download-URL'</span><span class="s3">, None</span><span class="s1">)</span><span class="s3">,</span>
        <span class="s4">'metadata_version'</span><span class="s1">: (</span><span class="s4">'Metadata-Version'</span><span class="s3">, None</span><span class="s1">)</span><span class="s3">,</span>
    <span class="s1">}</span>

    <span class="s3">del </span><span class="s1">none_list</span><span class="s3">, </span><span class="s1">none_dict</span>

    <span class="s3">def </span><span class="s1">__getattribute__(self</span><span class="s3">, </span><span class="s1">key):</span>
        <span class="s1">common = object.__getattribute__(self</span><span class="s3">, </span><span class="s4">'common_keys'</span><span class="s1">)</span>
        <span class="s1">mapped = object.__getattribute__(self</span><span class="s3">, </span><span class="s4">'mapped_keys'</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">key </span><span class="s3">in </span><span class="s1">mapped:</span>
            <span class="s1">lk</span><span class="s3">, </span><span class="s1">maker = mapped[key]</span>
            <span class="s3">if </span><span class="s1">self._legacy:</span>
                <span class="s3">if </span><span class="s1">lk </span><span class="s3">is None</span><span class="s1">:</span>
                    <span class="s1">result = </span><span class="s3">None if </span><span class="s1">maker </span><span class="s3">is None else </span><span class="s1">maker()</span>
                <span class="s3">else</span><span class="s1">:</span>
                    <span class="s1">result = self._legacy.get(lk)</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">value = </span><span class="s3">None if </span><span class="s1">maker </span><span class="s3">is None else </span><span class="s1">maker()</span>
                <span class="s3">if </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">(</span><span class="s4">'commands'</span><span class="s3">, </span><span class="s4">'exports'</span><span class="s3">, </span><span class="s4">'modules'</span><span class="s3">, </span><span class="s4">'namespaces'</span><span class="s3">,</span>
                               <span class="s4">'classifiers'</span><span class="s1">):</span>
                    <span class="s1">result = self._data.get(key</span><span class="s3">, </span><span class="s1">value)</span>
                <span class="s3">else</span><span class="s1">:</span>
                    <span class="s0"># special cases for PEP 459</span>
                    <span class="s1">sentinel = object()</span>
                    <span class="s1">result = sentinel</span>
                    <span class="s1">d = self._data.get(</span><span class="s4">'extensions'</span><span class="s1">)</span>
                    <span class="s3">if </span><span class="s1">d:</span>
                        <span class="s3">if </span><span class="s1">key == </span><span class="s4">'commands'</span><span class="s1">:</span>
                            <span class="s1">result = d.get(</span><span class="s4">'python.commands'</span><span class="s3">, </span><span class="s1">value)</span>
                        <span class="s3">elif </span><span class="s1">key == </span><span class="s4">'classifiers'</span><span class="s1">:</span>
                            <span class="s1">d = d.get(</span><span class="s4">'python.details'</span><span class="s1">)</span>
                            <span class="s3">if </span><span class="s1">d:</span>
                                <span class="s1">result = d.get(key</span><span class="s3">, </span><span class="s1">value)</span>
                        <span class="s3">else</span><span class="s1">:</span>
                            <span class="s1">d = d.get(</span><span class="s4">'python.exports'</span><span class="s1">)</span>
                            <span class="s3">if not </span><span class="s1">d:</span>
                                <span class="s1">d = self._data.get(</span><span class="s4">'python.exports'</span><span class="s1">)</span>
                            <span class="s3">if </span><span class="s1">d:</span>
                                <span class="s1">result = d.get(key</span><span class="s3">, </span><span class="s1">value)</span>
                    <span class="s3">if </span><span class="s1">result </span><span class="s3">is </span><span class="s1">sentinel:</span>
                        <span class="s1">result = value</span>
        <span class="s3">elif </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">common:</span>
            <span class="s1">result = object.__getattribute__(self</span><span class="s3">, </span><span class="s1">key)</span>
        <span class="s3">elif </span><span class="s1">self._legacy:</span>
            <span class="s1">result = self._legacy.get(key)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">result = self._data.get(key)</span>
        <span class="s3">return </span><span class="s1">result</span>

    <span class="s3">def </span><span class="s1">_validate_value(self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, </span><span class="s1">scheme=</span><span class="s3">None</span><span class="s1">):</span>
        <span class="s3">if </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self.SYNTAX_VALIDATORS:</span>
            <span class="s1">pattern</span><span class="s3">, </span><span class="s1">exclusions = self.SYNTAX_VALIDATORS[key]</span>
            <span class="s3">if </span><span class="s1">(scheme </span><span class="s3">or </span><span class="s1">self.scheme) </span><span class="s3">not in </span><span class="s1">exclusions:</span>
                <span class="s1">m = pattern.match(value)</span>
                <span class="s3">if not </span><span class="s1">m:</span>
                    <span class="s3">raise </span><span class="s1">MetadataInvalidError(</span><span class="s4">&quot;'%s' is an invalid value for &quot;</span>
                                               <span class="s4">&quot;the '%s' property&quot; </span><span class="s1">% (value</span><span class="s3">,</span>
                                                                    <span class="s1">key))</span>

    <span class="s3">def </span><span class="s1">__setattr__(self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value):</span>
        <span class="s1">self._validate_value(key</span><span class="s3">, </span><span class="s1">value)</span>
        <span class="s1">common = object.__getattribute__(self</span><span class="s3">, </span><span class="s4">'common_keys'</span><span class="s1">)</span>
        <span class="s1">mapped = object.__getattribute__(self</span><span class="s3">, </span><span class="s4">'mapped_keys'</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">key </span><span class="s3">in </span><span class="s1">mapped:</span>
            <span class="s1">lk</span><span class="s3">, </span><span class="s1">_ = mapped[key]</span>
            <span class="s3">if </span><span class="s1">self._legacy:</span>
                <span class="s3">if </span><span class="s1">lk </span><span class="s3">is None</span><span class="s1">:</span>
                    <span class="s3">raise </span><span class="s1">NotImplementedError</span>
                <span class="s1">self._legacy[lk] = value</span>
            <span class="s3">elif </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">(</span><span class="s4">'commands'</span><span class="s3">, </span><span class="s4">'exports'</span><span class="s3">, </span><span class="s4">'modules'</span><span class="s3">, </span><span class="s4">'namespaces'</span><span class="s3">,</span>
                             <span class="s4">'classifiers'</span><span class="s1">):</span>
                <span class="s1">self._data[key] = value</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s0"># special cases for PEP 459</span>
                <span class="s1">d = self._data.setdefault(</span><span class="s4">'extensions'</span><span class="s3">, </span><span class="s1">{})</span>
                <span class="s3">if </span><span class="s1">key == </span><span class="s4">'commands'</span><span class="s1">:</span>
                    <span class="s1">d[</span><span class="s4">'python.commands'</span><span class="s1">] = value</span>
                <span class="s3">elif </span><span class="s1">key == </span><span class="s4">'classifiers'</span><span class="s1">:</span>
                    <span class="s1">d = d.setdefault(</span><span class="s4">'python.details'</span><span class="s3">, </span><span class="s1">{})</span>
                    <span class="s1">d[key] = value</span>
                <span class="s3">else</span><span class="s1">:</span>
                    <span class="s1">d = d.setdefault(</span><span class="s4">'python.exports'</span><span class="s3">, </span><span class="s1">{})</span>
                    <span class="s1">d[key] = value</span>
        <span class="s3">elif </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">common:</span>
            <span class="s1">object.__setattr__(self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s3">if </span><span class="s1">key == </span><span class="s4">'keywords'</span><span class="s1">:</span>
                <span class="s3">if </span><span class="s1">isinstance(value</span><span class="s3">, </span><span class="s1">string_types):</span>
                    <span class="s1">value = value.strip()</span>
                    <span class="s3">if </span><span class="s1">value:</span>
                        <span class="s1">value = value.split()</span>
                    <span class="s3">else</span><span class="s1">:</span>
                        <span class="s1">value = []</span>
            <span class="s3">if </span><span class="s1">self._legacy:</span>
                <span class="s1">self._legacy[key] = value</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">self._data[key] = value</span>

    <span class="s1">@property</span>
    <span class="s3">def </span><span class="s1">name_and_version(self):</span>
        <span class="s3">return </span><span class="s1">_get_name_and_version(self.name</span><span class="s3">, </span><span class="s1">self.version</span><span class="s3">, True</span><span class="s1">)</span>

    <span class="s1">@property</span>
    <span class="s3">def </span><span class="s1">provides(self):</span>
        <span class="s3">if </span><span class="s1">self._legacy:</span>
            <span class="s1">result = self._legacy[</span><span class="s4">'Provides-Dist'</span><span class="s1">]</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">result = self._data.setdefault(</span><span class="s4">'provides'</span><span class="s3">, </span><span class="s1">[])</span>
        <span class="s1">s = </span><span class="s4">'%s (%s)' </span><span class="s1">% (self.name</span><span class="s3">, </span><span class="s1">self.version)</span>
        <span class="s3">if </span><span class="s1">s </span><span class="s3">not in </span><span class="s1">result:</span>
            <span class="s1">result.append(s)</span>
        <span class="s3">return </span><span class="s1">result</span>

    <span class="s1">@provides.setter</span>
    <span class="s3">def </span><span class="s1">provides(self</span><span class="s3">, </span><span class="s1">value):</span>
        <span class="s3">if </span><span class="s1">self._legacy:</span>
            <span class="s1">self._legacy[</span><span class="s4">'Provides-Dist'</span><span class="s1">] = value</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">self._data[</span><span class="s4">'provides'</span><span class="s1">] = value</span>

    <span class="s3">def </span><span class="s1">get_requirements(self</span><span class="s3">, </span><span class="s1">reqts</span><span class="s3">, </span><span class="s1">extras=</span><span class="s3">None, </span><span class="s1">env=</span><span class="s3">None</span><span class="s1">):</span>
        <span class="s2">&quot;&quot;&quot; 
        Base method to get dependencies, given a set of extras 
        to satisfy and an optional environment context. 
        :param reqts: A list of sometimes-wanted dependencies, 
                      perhaps dependent on extras and environment. 
        :param extras: A list of optional components being requested. 
        :param env: An optional environment for marker evaluation. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self._legacy:</span>
            <span class="s1">result = reqts</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">result = []</span>
            <span class="s1">extras = get_extras(extras </span><span class="s3">or </span><span class="s1">[]</span><span class="s3">, </span><span class="s1">self.extras)</span>
            <span class="s3">for </span><span class="s1">d </span><span class="s3">in </span><span class="s1">reqts:</span>
                <span class="s3">if </span><span class="s4">'extra' </span><span class="s3">not in </span><span class="s1">d </span><span class="s3">and </span><span class="s4">'environment' </span><span class="s3">not in </span><span class="s1">d:</span>
                    <span class="s0"># unconditional</span>
                    <span class="s1">include = </span><span class="s3">True</span>
                <span class="s3">else</span><span class="s1">:</span>
                    <span class="s3">if </span><span class="s4">'extra' </span><span class="s3">not in </span><span class="s1">d:</span>
                        <span class="s0"># Not extra-dependent - only environment-dependent</span>
                        <span class="s1">include = </span><span class="s3">True</span>
                    <span class="s3">else</span><span class="s1">:</span>
                        <span class="s1">include = d.get(</span><span class="s4">'extra'</span><span class="s1">) </span><span class="s3">in </span><span class="s1">extras</span>
                    <span class="s3">if </span><span class="s1">include:</span>
                        <span class="s0"># Not excluded because of extras, check environment</span>
                        <span class="s1">marker = d.get(</span><span class="s4">'environment'</span><span class="s1">)</span>
                        <span class="s3">if </span><span class="s1">marker:</span>
                            <span class="s1">include = interpret(marker</span><span class="s3">, </span><span class="s1">env)</span>
                <span class="s3">if </span><span class="s1">include:</span>
                    <span class="s1">result.extend(d[</span><span class="s4">'requires'</span><span class="s1">])</span>
            <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">(</span><span class="s4">'build'</span><span class="s3">, </span><span class="s4">'dev'</span><span class="s3">, </span><span class="s4">'test'</span><span class="s1">):</span>
                <span class="s1">e = </span><span class="s4">':%s:' </span><span class="s1">% key</span>
                <span class="s3">if </span><span class="s1">e </span><span class="s3">in </span><span class="s1">extras:</span>
                    <span class="s1">extras.remove(e)</span>
                    <span class="s0"># A recursive call, but it should terminate since 'test'</span>
                    <span class="s0"># has been removed from the extras</span>
                    <span class="s1">reqts = self._data.get(</span><span class="s4">'%s_requires' </span><span class="s1">% key</span><span class="s3">, </span><span class="s1">[])</span>
                    <span class="s1">result.extend(self.get_requirements(reqts</span><span class="s3">, </span><span class="s1">extras=extras</span><span class="s3">,</span>
                                                        <span class="s1">env=env))</span>
        <span class="s3">return </span><span class="s1">result</span>

    <span class="s1">@property</span>
    <span class="s3">def </span><span class="s1">dictionary(self):</span>
        <span class="s3">if </span><span class="s1">self._legacy:</span>
            <span class="s3">return </span><span class="s1">self._from_legacy()</span>
        <span class="s3">return </span><span class="s1">self._data</span>

    <span class="s1">@property</span>
    <span class="s3">def </span><span class="s1">dependencies(self):</span>
        <span class="s3">if </span><span class="s1">self._legacy:</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s1">extract_by_key(self._data</span><span class="s3">, </span><span class="s1">self.DEPENDENCY_KEYS)</span>

    <span class="s1">@dependencies.setter</span>
    <span class="s3">def </span><span class="s1">dependencies(self</span><span class="s3">, </span><span class="s1">value):</span>
        <span class="s3">if </span><span class="s1">self._legacy:</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">self._data.update(value)</span>

    <span class="s3">def </span><span class="s1">_validate_mapping(self</span><span class="s3">, </span><span class="s1">mapping</span><span class="s3">, </span><span class="s1">scheme):</span>
        <span class="s3">if </span><span class="s1">mapping.get(</span><span class="s4">'metadata_version'</span><span class="s1">) != self.METADATA_VERSION:</span>
            <span class="s3">raise </span><span class="s1">MetadataUnrecognizedVersionError()</span>
        <span class="s1">missing = []</span>
        <span class="s3">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">exclusions </span><span class="s3">in </span><span class="s1">self.MANDATORY_KEYS.items():</span>
            <span class="s3">if </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">mapping:</span>
                <span class="s3">if </span><span class="s1">scheme </span><span class="s3">not in </span><span class="s1">exclusions:</span>
                    <span class="s1">missing.append(key)</span>
        <span class="s3">if </span><span class="s1">missing:</span>
            <span class="s1">msg = </span><span class="s4">'Missing metadata items: %s' </span><span class="s1">% </span><span class="s4">', '</span><span class="s1">.join(missing)</span>
            <span class="s3">raise </span><span class="s1">MetadataMissingError(msg)</span>
        <span class="s3">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">mapping.items():</span>
            <span class="s1">self._validate_value(k</span><span class="s3">, </span><span class="s1">v</span><span class="s3">, </span><span class="s1">scheme)</span>

    <span class="s3">def </span><span class="s1">validate(self):</span>
        <span class="s3">if </span><span class="s1">self._legacy:</span>
            <span class="s1">missing</span><span class="s3">, </span><span class="s1">warnings = self._legacy.check(</span><span class="s3">True</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">missing </span><span class="s3">or </span><span class="s1">warnings:</span>
                <span class="s1">logger.warning(</span><span class="s4">'Metadata: missing: %s, warnings: %s'</span><span class="s3">,</span>
                               <span class="s1">missing</span><span class="s3">, </span><span class="s1">warnings)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">self._validate_mapping(self._data</span><span class="s3">, </span><span class="s1">self.scheme)</span>

    <span class="s3">def </span><span class="s1">todict(self):</span>
        <span class="s3">if </span><span class="s1">self._legacy:</span>
            <span class="s3">return </span><span class="s1">self._legacy.todict(</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">result = extract_by_key(self._data</span><span class="s3">, </span><span class="s1">self.INDEX_KEYS)</span>
            <span class="s3">return </span><span class="s1">result</span>

    <span class="s3">def </span><span class="s1">_from_legacy(self):</span>
        <span class="s3">assert </span><span class="s1">self._legacy </span><span class="s3">and not </span><span class="s1">self._data</span>
        <span class="s1">result = {</span>
            <span class="s4">'metadata_version'</span><span class="s1">: self.METADATA_VERSION</span><span class="s3">,</span>
            <span class="s4">'generator'</span><span class="s1">: self.GENERATOR</span><span class="s3">,</span>
        <span class="s1">}</span>
        <span class="s1">lmd = self._legacy.todict(</span><span class="s3">True</span><span class="s1">)     </span><span class="s0"># skip missing ones</span>
        <span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">(</span><span class="s4">'name'</span><span class="s3">, </span><span class="s4">'version'</span><span class="s3">, </span><span class="s4">'license'</span><span class="s3">, </span><span class="s4">'summary'</span><span class="s3">, </span><span class="s4">'description'</span><span class="s3">,</span>
                  <span class="s4">'classifier'</span><span class="s1">):</span>
            <span class="s3">if </span><span class="s1">k </span><span class="s3">in </span><span class="s1">lmd:</span>
                <span class="s3">if </span><span class="s1">k == </span><span class="s4">'classifier'</span><span class="s1">:</span>
                    <span class="s1">nk = </span><span class="s4">'classifiers'</span>
                <span class="s3">else</span><span class="s1">:</span>
                    <span class="s1">nk = k</span>
                <span class="s1">result[nk] = lmd[k]</span>
        <span class="s1">kw = lmd.get(</span><span class="s4">'Keywords'</span><span class="s3">, </span><span class="s1">[])</span>
        <span class="s3">if </span><span class="s1">kw == [</span><span class="s4">''</span><span class="s1">]:</span>
            <span class="s1">kw = []</span>
        <span class="s1">result[</span><span class="s4">'keywords'</span><span class="s1">] = kw</span>
        <span class="s1">keys = ((</span><span class="s4">'requires_dist'</span><span class="s3">, </span><span class="s4">'run_requires'</span><span class="s1">)</span><span class="s3">,</span>
                <span class="s1">(</span><span class="s4">'setup_requires_dist'</span><span class="s3">, </span><span class="s4">'build_requires'</span><span class="s1">))</span>
        <span class="s3">for </span><span class="s1">ok</span><span class="s3">, </span><span class="s1">nk </span><span class="s3">in </span><span class="s1">keys:</span>
            <span class="s3">if </span><span class="s1">ok </span><span class="s3">in </span><span class="s1">lmd </span><span class="s3">and </span><span class="s1">lmd[ok]:</span>
                <span class="s1">result[nk] = [{</span><span class="s4">'requires'</span><span class="s1">: lmd[ok]}]</span>
        <span class="s1">result[</span><span class="s4">'provides'</span><span class="s1">] = self.provides</span>
        <span class="s1">author = {}</span>
        <span class="s1">maintainer = {}</span>
        <span class="s3">return </span><span class="s1">result</span>

    <span class="s1">LEGACY_MAPPING = {</span>
        <span class="s4">'name'</span><span class="s1">: </span><span class="s4">'Name'</span><span class="s3">,</span>
        <span class="s4">'version'</span><span class="s1">: </span><span class="s4">'Version'</span><span class="s3">,</span>
        <span class="s4">'license'</span><span class="s1">: </span><span class="s4">'License'</span><span class="s3">,</span>
        <span class="s4">'summary'</span><span class="s1">: </span><span class="s4">'Summary'</span><span class="s3">,</span>
        <span class="s4">'description'</span><span class="s1">: </span><span class="s4">'Description'</span><span class="s3">,</span>
        <span class="s4">'classifiers'</span><span class="s1">: </span><span class="s4">'Classifier'</span><span class="s3">,</span>
    <span class="s1">}</span>

    <span class="s3">def </span><span class="s1">_to_legacy(self):</span>
        <span class="s3">def </span><span class="s1">process_entries(entries):</span>
            <span class="s1">reqts = set()</span>
            <span class="s3">for </span><span class="s1">e </span><span class="s3">in </span><span class="s1">entries:</span>
                <span class="s1">extra = e.get(</span><span class="s4">'extra'</span><span class="s1">)</span>
                <span class="s1">env = e.get(</span><span class="s4">'environment'</span><span class="s1">)</span>
                <span class="s1">rlist = e[</span><span class="s4">'requires'</span><span class="s1">]</span>
                <span class="s3">for </span><span class="s1">r </span><span class="s3">in </span><span class="s1">rlist:</span>
                    <span class="s3">if not </span><span class="s1">env </span><span class="s3">and not </span><span class="s1">extra:</span>
                        <span class="s1">reqts.add(r)</span>
                    <span class="s3">else</span><span class="s1">:</span>
                        <span class="s1">marker = </span><span class="s4">''</span>
                        <span class="s3">if </span><span class="s1">extra:</span>
                            <span class="s1">marker = </span><span class="s4">'extra == &quot;%s&quot;' </span><span class="s1">% extra</span>
                        <span class="s3">if </span><span class="s1">env:</span>
                            <span class="s3">if </span><span class="s1">marker:</span>
                                <span class="s1">marker = </span><span class="s4">'(%s) and %s' </span><span class="s1">% (env</span><span class="s3">, </span><span class="s1">marker)</span>
                            <span class="s3">else</span><span class="s1">:</span>
                                <span class="s1">marker = env</span>
                        <span class="s1">reqts.add(</span><span class="s4">';'</span><span class="s1">.join((r</span><span class="s3">, </span><span class="s1">marker)))</span>
            <span class="s3">return </span><span class="s1">reqts</span>

        <span class="s3">assert </span><span class="s1">self._data </span><span class="s3">and not </span><span class="s1">self._legacy</span>
        <span class="s1">result = LegacyMetadata()</span>
        <span class="s1">nmd = self._data</span>
        <span class="s3">for </span><span class="s1">nk</span><span class="s3">, </span><span class="s1">ok </span><span class="s3">in </span><span class="s1">self.LEGACY_MAPPING.items():</span>
            <span class="s3">if </span><span class="s1">nk </span><span class="s3">in </span><span class="s1">nmd:</span>
                <span class="s1">result[ok] = nmd[nk]</span>
        <span class="s1">r1 = process_entries(self.run_requires + self.meta_requires)</span>
        <span class="s1">r2 = process_entries(self.build_requires + self.dev_requires)</span>
        <span class="s3">if </span><span class="s1">self.extras:</span>
            <span class="s1">result[</span><span class="s4">'Provides-Extra'</span><span class="s1">] = sorted(self.extras)</span>
        <span class="s1">result[</span><span class="s4">'Requires-Dist'</span><span class="s1">] = sorted(r1)</span>
        <span class="s1">result[</span><span class="s4">'Setup-Requires-Dist'</span><span class="s1">] = sorted(r2)</span>
        <span class="s0"># TODO: other fields such as contacts</span>
        <span class="s3">return </span><span class="s1">result</span>

    <span class="s3">def </span><span class="s1">write(self</span><span class="s3">, </span><span class="s1">path=</span><span class="s3">None, </span><span class="s1">fileobj=</span><span class="s3">None, </span><span class="s1">legacy=</span><span class="s3">False, </span><span class="s1">skip_unknown=</span><span class="s3">True</span><span class="s1">):</span>
        <span class="s3">if </span><span class="s1">[path</span><span class="s3">, </span><span class="s1">fileobj].count(</span><span class="s3">None</span><span class="s1">) != </span><span class="s5">1</span><span class="s1">:</span>
            <span class="s3">raise </span><span class="s1">ValueError(</span><span class="s4">'Exactly one of path and fileobj is needed'</span><span class="s1">)</span>
        <span class="s1">self.validate()</span>
        <span class="s3">if </span><span class="s1">legacy:</span>
            <span class="s3">if </span><span class="s1">self._legacy:</span>
                <span class="s1">legacy_md = self._legacy</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">legacy_md = self._to_legacy()</span>
            <span class="s3">if </span><span class="s1">path:</span>
                <span class="s1">legacy_md.write(path</span><span class="s3">, </span><span class="s1">skip_unknown=skip_unknown)</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">legacy_md.write_file(fileobj</span><span class="s3">, </span><span class="s1">skip_unknown=skip_unknown)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s3">if </span><span class="s1">self._legacy:</span>
                <span class="s1">d = self._from_legacy()</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">d = self._data</span>
            <span class="s3">if </span><span class="s1">fileobj:</span>
                <span class="s1">json.dump(d</span><span class="s3">, </span><span class="s1">fileobj</span><span class="s3">, </span><span class="s1">ensure_ascii=</span><span class="s3">True, </span><span class="s1">indent=</span><span class="s5">2</span><span class="s3">,</span>
                          <span class="s1">sort_keys=</span><span class="s3">True</span><span class="s1">)</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s3">with </span><span class="s1">codecs.open(path</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">, </span><span class="s4">'utf-8'</span><span class="s1">) </span><span class="s3">as </span><span class="s1">f:</span>
                    <span class="s1">json.dump(d</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">ensure_ascii=</span><span class="s3">True, </span><span class="s1">indent=</span><span class="s5">2</span><span class="s3">,</span>
                              <span class="s1">sort_keys=</span><span class="s3">True</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">add_requirements(self</span><span class="s3">, </span><span class="s1">requirements):</span>
        <span class="s3">if </span><span class="s1">self._legacy:</span>
            <span class="s1">self._legacy.add_requirements(requirements)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">run_requires = self._data.setdefault(</span><span class="s4">'run_requires'</span><span class="s3">, </span><span class="s1">[])</span>
            <span class="s1">always = </span><span class="s3">None</span>
            <span class="s3">for </span><span class="s1">entry </span><span class="s3">in </span><span class="s1">run_requires:</span>
                <span class="s3">if </span><span class="s4">'environment' </span><span class="s3">not in </span><span class="s1">entry </span><span class="s3">and </span><span class="s4">'extra' </span><span class="s3">not in </span><span class="s1">entry:</span>
                    <span class="s1">always = entry</span>
                    <span class="s3">break</span>
            <span class="s3">if </span><span class="s1">always </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s1">always = { </span><span class="s4">'requires'</span><span class="s1">: requirements }</span>
                <span class="s1">run_requires.insert(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">always)</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">rset = set(always[</span><span class="s4">'requires'</span><span class="s1">]) | set(requirements)</span>
                <span class="s1">always[</span><span class="s4">'requires'</span><span class="s1">] = sorted(rset)</span>

    <span class="s3">def </span><span class="s1">__repr__(self):</span>
        <span class="s1">name = self.name </span><span class="s3">or </span><span class="s4">'(no name)'</span>
        <span class="s1">version = self.version </span><span class="s3">or </span><span class="s4">'no version'</span>
        <span class="s3">return </span><span class="s4">'&lt;%s %s %s (%s)&gt;' </span><span class="s1">% (self.__class__.__name__</span><span class="s3">,</span>
                                    <span class="s1">self.metadata_version</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">version)</span>
</pre>
</body>
</html>