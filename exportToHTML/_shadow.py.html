<html>
<head>
<title>_shadow.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_shadow.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">math </span><span class="s0">import </span><span class="s1">tan</span><span class="s0">, </span><span class="s1">pi</span>

<span class="s0">from </span><span class="s1">pygame </span><span class="s0">import </span><span class="s1">Surface</span>
<span class="s0">from </span><span class="s1">pygame.transform </span><span class="s0">import </span><span class="s1">rotate</span><span class="s0">, </span><span class="s1">flip</span><span class="s0">, </span><span class="s1">scale</span>

<span class="s0">from </span><span class="s1">thorpy.elements.element </span><span class="s0">import </span><span class="s1">Element</span>
<span class="s0">from </span><span class="s1">thorpy.painting </span><span class="s0">import </span><span class="s1">pilgraphics</span>
<span class="s0">from </span><span class="s1">thorpy.painting.painters.imageframe </span><span class="s0">import </span><span class="s1">ImageFrame</span>
<span class="s0">from </span><span class="s1">thorpy.miscgui </span><span class="s0">import </span><span class="s1">constants</span><span class="s0">, </span><span class="s1">functions</span>
<span class="s0">from </span><span class="s1">thorpy.miscgui.reaction </span><span class="s0">import </span><span class="s1">ConstantReaction</span>


<span class="s1">SUN_ANGLE = </span><span class="s2">30.</span>
<span class="s1">SUN_ANGLE2 = </span><span class="s2">0.</span>
<span class="s1">SHADOW_RADIUS = </span><span class="s2">7</span>
<span class="s1">SHADOW_COLOR = (</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
<span class="s1">BLACK = </span><span class="s2">255</span>
<span class="s1">ALPHA_FACTOR = </span><span class="s2">0.85</span>
<span class="s1">DECAY_MODE = </span><span class="s3">&quot;exponential&quot;</span>
<span class="s1">ANGLE_MODE = </span><span class="s3">&quot;flip&quot;</span>
<span class="s1">MODE_VALUE = (</span><span class="s0">False, True</span><span class="s1">)</span>
<span class="s4">##ANGLE_MODE = &quot;rotate&quot;</span>
<span class="s4">##MODE_VALUE = 90.</span>
<span class="s1">CAPTURE_STATE_STATIC = constants.STATE_NORMAL</span>
<span class="s1">TARGET_ALTITUDE = </span><span class="s2">0.</span>
<span class="s1">OFFSET = (</span><span class="s2">0.</span><span class="s0">, </span><span class="s2">0.</span><span class="s1">)</span>
<span class="s1">VERTICAL = </span><span class="s0">True</span>


<span class="s0">class </span><span class="s1">StaticShadow(Element):</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">target</span><span class="s0">, </span><span class="s1">elements=</span><span class="s0">None, </span><span class="s1">normal_params=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s1">Element.__init__(self</span><span class="s0">, </span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">elements</span><span class="s0">, </span><span class="s1">normal_params)</span>
        <span class="s1">self.link(target)</span>
        <span class="s1">self.sun_angle = SUN_ANGLE</span>
        <span class="s1">self.sun_angle2 = SUN_ANGLE2</span>
        <span class="s1">self.shadow_radius = SHADOW_RADIUS</span>
        <span class="s1">self.black = BLACK</span>
        <span class="s1">self.alpha_factor = ALPHA_FACTOR</span>
        <span class="s1">self.decay_mode = DECAY_MODE</span>
        <span class="s1">self.angle_mode = ANGLE_MODE</span>
        <span class="s1">self.mode_value = MODE_VALUE</span>
        <span class="s1">self.capture_state = CAPTURE_STATE_STATIC</span>
        <span class="s1">self.target_altitude = TARGET_ALTITUDE</span>
        <span class="s1">self.offset = OFFSET</span>
        <span class="s1">self.vertical = VERTICAL </span><span class="s4">#rpg style : vertical=True</span>
        <span class="s1">self.color = SHADOW_COLOR</span>

    <span class="s0">def </span><span class="s1">link(self</span><span class="s0">, </span><span class="s1">target):</span>
        <span class="s1">self.target = target</span>
        <span class="s1">self.target.add_elements([self])</span>
        <span class="s1">self.target.set_blit_before(self)</span>
        <span class="s1">self.target._shadow = self</span>
        <span class="s1">self.target._overframe = </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">self.target._jail:</span>
            <span class="s1">self.set_jailed(self.target._jail)</span>

    <span class="s0">def </span><span class="s1">unlink(self):</span>
        <span class="s1">self.target.remove_elements([self])</span>
        <span class="s1">self.target._shadow = </span><span class="s0">None</span>
        <span class="s1">self.target._overframe = </span><span class="s0">False</span>
        <span class="s1">self.target = </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">_get_raw_shadow(self):</span>
        <span class="s1">target_img = self.target.get_image(self.capture_state)</span>
        <span class="s1">r = target_img.get_rect()</span>
        <span class="s4">#the shadow will be larger in order to make free space for fadeout.</span>
        <span class="s1">r.inflate_ip(</span><span class="s2">2</span><span class="s1">*self.shadow_radius</span><span class="s0">, </span><span class="s2">2</span><span class="s1">*self.shadow_radius)</span>
        <span class="s1">img = Surface(r.size)</span>
        <span class="s1">img.fill((</span><span class="s2">255</span><span class="s0">, </span><span class="s2">255</span><span class="s0">, </span><span class="s2">255</span><span class="s0">, </span><span class="s2">255</span><span class="s1">))</span>
        <span class="s1">img.blit(target_img</span><span class="s0">, </span><span class="s1">(self.shadow_radius</span><span class="s0">, </span><span class="s1">self.shadow_radius))</span>
        <span class="s0">if </span><span class="s1">self.sun_angle &lt;= </span><span class="s2">0.</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">Exception(</span><span class="s3">&quot;Sun angle must be greater than zero.&quot;</span><span class="s1">)</span>
        <span class="s0">elif </span><span class="s1">self.sun_angle != </span><span class="s2">45. </span><span class="s0">and </span><span class="s1">self.vertical:</span>
            <span class="s1">w</span><span class="s0">, </span><span class="s1">h = img.get_size()</span>
            <span class="s1">new_h = h / tan(self.sun_angle * pi / </span><span class="s2">180.</span><span class="s1">)</span>
            <span class="s1">screen_size = functions.get_screen().get_size()</span>
            <span class="s1">new_h = abs(int(min(new_h</span><span class="s0">, </span><span class="s1">max(screen_size))))</span>
            <span class="s1">img = scale(img</span><span class="s0">, </span><span class="s1">(w</span><span class="s0">, </span><span class="s1">new_h))</span>
        <span class="s0">if </span><span class="s1">self.angle_mode == </span><span class="s3">&quot;flip&quot;</span><span class="s1">:</span>
            <span class="s1">img = flip(img</span><span class="s0">, </span><span class="s1">self.mode_value[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">self.mode_value[</span><span class="s2">1</span><span class="s1">])</span>
        <span class="s0">elif </span><span class="s1">self.angle_mode == </span><span class="s3">&quot;rotate&quot;</span><span class="s1">:</span>
            <span class="s1">img = rotate(img</span><span class="s0">, </span><span class="s1">self.mode_value)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">Exception(</span><span class="s3">&quot;angle_mode not available: &quot; </span><span class="s1">+ str(self.angle_mode))</span>
        <span class="s1">shadow = pilgraphics.get_shadow(img</span><span class="s0">,</span>
                                        <span class="s1">radius=self.shadow_radius</span><span class="s0">,</span>
                                        <span class="s1">black=self.black</span><span class="s0">,</span>
                                        <span class="s1">alpha_factor=self.alpha_factor</span><span class="s0">,</span>
                                        <span class="s1">decay_mode=self.decay_mode</span><span class="s0">,</span>
                                        <span class="s1">color=self.color)</span>
        <span class="s0">return </span><span class="s1">shadow</span>

    <span class="s0">def </span><span class="s1">_get_shadow_painter(self):</span>
        <span class="s1">shadow = self._get_raw_shadow()</span>
        <span class="s0">return </span><span class="s1">ImageFrame(shadow</span><span class="s0">, </span><span class="s1">alpha=-</span><span class="s2">1</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">_refresh_position(self):</span>
        <span class="s1">self.center(element=self.target)</span>
        <span class="s0">if </span><span class="s1">self.vertical:</span>
            <span class="s0">if </span><span class="s1">self.angle_mode == </span><span class="s3">&quot;flip&quot;</span><span class="s1">:</span>
                <span class="s1">targ_rect = self.target.get_fus_rect()</span>
                <span class="s1">self_rect = self.get_fus_rect().inflate((-</span><span class="s2">2</span><span class="s1">*self.shadow_radius</span><span class="s0">,</span>
                                                         <span class="s1">-</span><span class="s2">2</span><span class="s1">*self.shadow_radius))</span>
<span class="s4">##                altitude = self.target_altitude / tan(self.sun_angle*pi / 180.)</span>
                <span class="s0">if </span><span class="s1">self.mode_value[</span><span class="s2">1</span><span class="s1">]: </span><span class="s4">#inverted shadow (to the south)</span>
                    <span class="s1">self_rect.top = targ_rect.bottom</span>
                <span class="s0">else</span><span class="s1">: </span><span class="s4">#to the north</span>
                    <span class="s1">self_rect.bottom = targ_rect.bottom</span>
                <span class="s1">self.set_center((targ_rect.centerx+self.offset[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                                 <span class="s1">self_rect.centery+self.offset[</span><span class="s2">1</span><span class="s1">]))</span>
                <span class="s0">if </span><span class="s1">self.sun_angle2 != </span><span class="s2">0.</span><span class="s1">:</span>
                    <span class="s1">functions.info_msg(</span><span class="s3">&quot;Sun angle2 unused for &quot;</span><span class="s0">, </span><span class="s1">self)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">self.move(self.offset)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">dx = </span><span class="s2">0.</span>
            <span class="s0">if </span><span class="s1">self.sun_angle2 &gt; </span><span class="s2">0.</span><span class="s1">:</span>
                <span class="s1">dx = self.target_altitude / tan(self.sun_angle2*pi / </span><span class="s2">180.</span><span class="s1">)</span>
            <span class="s1">dy = self.target_altitude / tan(self.sun_angle*pi / </span><span class="s2">180.</span><span class="s1">)</span>
            <span class="s1">self.move((self.offset[</span><span class="s2">0</span><span class="s1">] + dx</span><span class="s0">, </span><span class="s1">self.offset[</span><span class="s2">1</span><span class="s1">] + dy))</span>


    <span class="s0">def </span><span class="s1">finish(self):</span>
        <span class="s1">painter = self._get_shadow_painter()</span>
        <span class="s1">self.set_painter(painter)</span>
        <span class="s1">Element.finish(self)</span>
        <span class="s1">self._refresh_position()</span>


<span class="s0">class </span><span class="s1">DynamicShadow(StaticShadow):</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">target</span><span class="s0">, </span><span class="s1">elements=</span><span class="s0">None, </span><span class="s1">normal_params=</span><span class="s0">None,</span>
                 <span class="s1">capture_states=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s1">StaticShadow.__init__(self</span><span class="s0">, </span><span class="s1">target</span><span class="s0">, </span><span class="s1">elements</span><span class="s0">, </span><span class="s1">normal_params)</span>
        <span class="s0">if </span><span class="s1">capture_states </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">capture_states = target._states.keys()</span>
<span class="s4">##            capture_states = [CAPTURE_STATE_STATIC]</span>
        <span class="s1">self._capture_states = capture_states</span>
        <span class="s1">self._shadows = {}</span>
        <span class="s1">self.offsets = {s : (</span><span class="s2">0.</span><span class="s0">, </span><span class="s2">0.</span><span class="s1">) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">self._capture_states}</span>
        <span class="s1">reaction = ConstantReaction(constants.THORPY_EVENT</span><span class="s0">,</span>
                                    <span class="s1">self._reaction_change_state</span><span class="s0">,</span>
                                    <span class="s1">{</span><span class="s3">&quot;id&quot;</span><span class="s1">:constants.EVENT_CHANGE_STATE</span><span class="s0">,</span>
                                     <span class="s3">&quot;el&quot; </span><span class="s1">: self.target}</span><span class="s0">,</span>
                                    <span class="s1">reac_name=constants.REAC_CHANGE_STATE)</span>
        <span class="s1">self.add_reaction(reaction)</span>

    <span class="s0">def </span><span class="s1">set_offset(self</span><span class="s0">, </span><span class="s1">offset</span><span class="s0">, </span><span class="s1">state=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s0">if </span><span class="s1">state </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">self._capture_states:</span>
                <span class="s1">self.set_offset(offset</span><span class="s0">, </span><span class="s1">s)</span>
        <span class="s1">self.offsets[state] = offset</span>

    <span class="s0">def </span><span class="s1">set_shadow_image(self</span><span class="s0">, </span><span class="s1">state</span><span class="s0">, </span><span class="s1">image</span><span class="s0">, </span><span class="s1">offset=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s1">self._shadows[state] = image</span>
        <span class="s0">if </span><span class="s1">self.offset </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">self.offsets[state] = offset</span>

    <span class="s0">def </span><span class="s1">finish(self):</span>
        <span class="s0">for </span><span class="s1">state_key </span><span class="s0">in </span><span class="s1">self._capture_states:</span>
            <span class="s1">self.capture_state = state_key</span>
            <span class="s1">self.offset = self.offsets[state_key]</span>
            <span class="s1">painter = self._get_shadow_painter()</span>
            <span class="s1">self.build_state(state_key</span><span class="s0">, </span><span class="s1">painter)</span>
        <span class="s1">self.current_state = self._states[constants.STATE_NORMAL]</span>
        <span class="s1">self._finished = </span><span class="s0">True</span>
        <span class="s1">self._refresh_position()</span>

    <span class="s0">def </span><span class="s1">_reaction_change_state(self):</span>
        <span class="s1">self.change_state(self.target.current_state_key)</span>
        <span class="s1">self._refresh_position()</span>
<span class="s4">##        pass</span>
</pre>
</body>
</html>