<html>
<head>
<title>keyer.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #808080;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
keyer.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Module defining default keyboard behaviour.&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">pygame</span>
<span class="s2">from </span><span class="s1">pygame.locals </span><span class="s2">import </span><span class="s1">*</span>

<span class="s2">from </span><span class="s1">thorpy.miscgui.functions </span><span class="s2">import </span><span class="s1">debug_msg</span>



<span class="s1">MODIFIERS = [K_RSHIFT</span><span class="s2">,</span>
             <span class="s1">K_LSHIFT</span><span class="s2">,</span>
             <span class="s1">K_RCTRL</span><span class="s2">,</span>
             <span class="s1">K_LCTRL</span><span class="s2">,</span>
             <span class="s1">K_RALT</span><span class="s2">,</span>
             <span class="s1">K_LALT</span><span class="s2">,</span>
             <span class="s1">K_RMETA</span><span class="s2">,</span>
             <span class="s1">K_LMETA]</span>

<span class="s1">QWERTZ_SPECIALS = {(K_RALT</span><span class="s2">, </span><span class="s1">K_3): K_HASH</span><span class="s2">,                        </span><span class="s3"># &quot;#&quot;</span>
                   <span class="s1">(K_RALT</span><span class="s2">, </span><span class="s1">K_2): K_AT</span><span class="s2">,                          </span><span class="s3"># &quot;@&quot;</span>
                   <span class="s1">(K_LSHIFT</span><span class="s2">, </span><span class="s1">K_MINUS): K_QUESTION</span><span class="s2">,              </span><span class="s3"># &quot;?&quot;</span>
                   <span class="s1">(K_LSHIFT</span><span class="s2">, </span><span class="s1">K_PERIOD): K_COLON</span><span class="s2">,                </span><span class="s3"># &quot;:&quot;</span>
                   <span class="s1">(K_LSHIFT</span><span class="s2">, </span><span class="s1">K_COMMA): K_SEMICOLON</span><span class="s2">,             </span><span class="s3"># &quot;;&quot;</span>
                   <span class="s1">(K_LSHIFT</span><span class="s2">, </span><span class="s1">K_7): K_SLASH</span><span class="s2">,                     </span><span class="s3"># &quot;/&quot;</span>
                   <span class="s1">(K_LSHIFT</span><span class="s2">, </span><span class="s1">K_LESS): K_GREATER</span><span class="s2">,                </span><span class="s3"># &quot;&gt;&quot;</span>
                   <span class="s1">(K_LSHIFT</span><span class="s2">, </span><span class="s1">K_3): K_ASTERISK</span><span class="s2">,                  </span><span class="s3"># &quot;*&quot;</span>
                   <span class="s1">}</span>
<span class="s1">SPECIALS = {}</span>


<span class="s1">QWERTZ_CHANGES = {K_z: K_y</span><span class="s2">,</span>
                  <span class="s1">K_y: K_z</span><span class="s2">,</span>
                  <span class="s1">K_SLASH: K_MINUS}  </span><span class="s3"># example</span>
<span class="s1">CHANGES = {}</span>


<span class="s2">def </span><span class="s1">set_qwertz():</span>
    <span class="s2">global </span><span class="s1">SPECIALS</span><span class="s2">, </span><span class="s1">CHANGES</span>
    <span class="s1">SPECIALS = QWERTZ_SPECIALS.copy()</span>
    <span class="s1">CHANGES = QWERTZ_CHANGES.copy()</span>

<span class="s2">def </span><span class="s1">set_default():</span>
    <span class="s2">global </span><span class="s1">SPECIALS</span><span class="s2">, </span><span class="s1">CHANGES</span>
    <span class="s1">SPECIALS = {}</span>
    <span class="s1">CHANGES = {}</span>

<span class="s2">class </span><span class="s1">Keyer(object):</span>
    <span class="s3"># Penser a permettre les set blocked et allowed</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">specials=</span><span class="s2">None, </span><span class="s1">modifiers=</span><span class="s2">None, </span><span class="s1">changes=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s2">if not </span><span class="s1">specials:</span>
            <span class="s1">specials = SPECIALS</span>
        <span class="s2">if not </span><span class="s1">modifiers:</span>
            <span class="s1">modifiers = MODIFIERS</span>
        <span class="s2">if not </span><span class="s1">changes:</span>
            <span class="s1">changes = CHANGES</span>
        <span class="s1">self.specials = specials</span>
        <span class="s1">self.changes = changes</span>
        <span class="s1">self.modifiers = modifiers</span>

    <span class="s2">def </span><span class="s1">_get_changed(self</span><span class="s2">, </span><span class="s1">key):</span>
        <span class="s0">&quot;&quot;&quot;Performs the 'translation' between &lt;key&gt; and its corresponding value 
        according to self.changes's dict. 
        &quot;&quot;&quot;</span>
        <span class="s1">changed = self.changes.get(key)</span>
        <span class="s2">if </span><span class="s1">changed:</span>
            <span class="s2">return </span><span class="s1">changed</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">key</span>

    <span class="s2">def </span><span class="s1">_more_than_256(self</span><span class="s2">, </span><span class="s1">key):</span>
        <span class="s1">key = pygame.key.name(key)</span>
        <span class="s2">if </span><span class="s1">key.startswith(</span><span class="s4">&quot;[&quot;</span><span class="s1">):</span>
            <span class="s2">if </span><span class="s1">key.endswith(</span><span class="s4">&quot;]&quot;</span><span class="s1">):</span>
                <span class="s2">return </span><span class="s1">key[</span><span class="s5">1</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s2">return </span><span class="s1">key</span>

    <span class="s2">def </span><span class="s1">get_char_from_key(self</span><span class="s2">, </span><span class="s1">key):</span>
        <span class="s0">&quot;&quot;&quot;&lt;default&gt; is returned if no character can be found from &lt;key&gt;&quot;&quot;&quot;</span>
        <span class="s1">pressed = pygame.key.get_pressed()</span>
        <span class="s1">pygame.event.pump()</span>
        <span class="s2">for </span><span class="s1">(ka</span><span class="s2">, </span><span class="s1">kb) </span><span class="s2">in </span><span class="s1">self.specials:  </span><span class="s3"># handle combinations</span>
            <span class="s2">if </span><span class="s1">pressed[ka]:</span>
                <span class="s2">if </span><span class="s1">kb == key:</span>
                    <span class="s1">key = self.specials[(ka</span><span class="s2">, </span><span class="s1">kb)]</span>
                    <span class="s2">if </span><span class="s1">key &lt; </span><span class="s5">256</span><span class="s1">:</span>
                        <span class="s2">return </span><span class="s1">chr(key)</span>
        <span class="s1">key = self._get_changed(key)</span>
        <span class="s2">if </span><span class="s1">pressed[K_LSHIFT]:  </span><span class="s3"># handle caps</span>
            <span class="s2">if </span><span class="s1">key &gt;= </span><span class="s5">32 </span><span class="s2">and </span><span class="s1">key &lt;= </span><span class="s5">126</span><span class="s1">:</span>
                <span class="s1">key -= </span><span class="s5">32</span>
        <span class="s1">debug_msg(</span><span class="s4">&quot;key interpretation :&quot;</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">pygame.key.name(key))</span>
        <span class="s2">if </span><span class="s1">key &lt; </span><span class="s5">256</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">chr(key)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">self._more_than_256(key)</span>
</pre>
</body>
</html>