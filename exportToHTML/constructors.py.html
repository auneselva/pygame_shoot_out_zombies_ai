<html>
<head>
<title>constructors.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #808080;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
constructors.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Backing implementation for InstallRequirement's various constructors 
 
The idea here is that these formed a major chunk of InstallRequirement's size 
so, moving them and support code dedicated to them outside of that class 
helps creates for better understandability for the rest of the code. 
 
These are meant to be used elsewhere within pip to create instances of 
InstallRequirement. 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">logging</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">re</span>

<span class="s2">from </span><span class="s1">pip._vendor.packaging.markers </span><span class="s2">import </span><span class="s1">Marker</span>
<span class="s2">from </span><span class="s1">pip._vendor.packaging.requirements </span><span class="s2">import </span><span class="s1">InvalidRequirement</span><span class="s2">, </span><span class="s1">Requirement</span>
<span class="s2">from </span><span class="s1">pip._vendor.packaging.specifiers </span><span class="s2">import </span><span class="s1">Specifier</span>
<span class="s2">from </span><span class="s1">pip._vendor.pkg_resources </span><span class="s2">import </span><span class="s1">RequirementParseError</span><span class="s2">, </span><span class="s1">parse_requirements</span>

<span class="s2">from </span><span class="s1">pip._internal.download </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">is_archive_file</span><span class="s2">, </span><span class="s1">is_url</span><span class="s2">, </span><span class="s1">path_to_url</span><span class="s2">, </span><span class="s1">url_to_path</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">from </span><span class="s1">pip._internal.exceptions </span><span class="s2">import </span><span class="s1">InstallationError</span>
<span class="s2">from </span><span class="s1">pip._internal.models.index </span><span class="s2">import </span><span class="s1">PyPI</span><span class="s2">, </span><span class="s1">TestPyPI</span>
<span class="s2">from </span><span class="s1">pip._internal.models.link </span><span class="s2">import </span><span class="s1">Link</span>
<span class="s2">from </span><span class="s1">pip._internal.pyproject </span><span class="s2">import </span><span class="s1">make_pyproject_path</span>
<span class="s2">from </span><span class="s1">pip._internal.req.req_install </span><span class="s2">import </span><span class="s1">InstallRequirement</span>
<span class="s2">from </span><span class="s1">pip._internal.utils.misc </span><span class="s2">import </span><span class="s1">is_installable_dir</span>
<span class="s2">from </span><span class="s1">pip._internal.utils.typing </span><span class="s2">import </span><span class="s1">MYPY_CHECK_RUNNING</span>
<span class="s2">from </span><span class="s1">pip._internal.vcs </span><span class="s2">import </span><span class="s1">vcs</span>
<span class="s2">from </span><span class="s1">pip._internal.wheel </span><span class="s2">import </span><span class="s1">Wheel</span>

<span class="s2">if </span><span class="s1">MYPY_CHECK_RUNNING:</span>
    <span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">(   </span><span class="s3"># noqa: F401</span>
        <span class="s1">Optional</span><span class="s2">, </span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">Set</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">Union</span><span class="s2">, </span><span class="s1">Text</span><span class="s2">, </span><span class="s1">Dict</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s2">from </span><span class="s1">pip._internal.cache </span><span class="s2">import </span><span class="s1">WheelCache  </span><span class="s3"># noqa: F401</span>


<span class="s1">__all__ = [</span>
    <span class="s4">&quot;install_req_from_editable&quot;</span><span class="s2">, </span><span class="s4">&quot;install_req_from_line&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;parse_editable&quot;</span>
<span class="s1">]</span>

<span class="s1">logger = logging.getLogger(__name__)</span>
<span class="s1">operators = Specifier._operators.keys()</span>


<span class="s2">def </span><span class="s1">_strip_extras(path):</span>
    <span class="s3"># type: (str) -&gt; Tuple[str, Optional[str]]</span>
    <span class="s1">m = re.match(</span><span class="s4">r'^(.+)(\[[^\]]+\])$'</span><span class="s2">, </span><span class="s1">path)</span>
    <span class="s1">extras = </span><span class="s2">None</span>
    <span class="s2">if </span><span class="s1">m:</span>
        <span class="s1">path_no_extras = m.group(</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">extras = m.group(</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">path_no_extras = path</span>

    <span class="s2">return </span><span class="s1">path_no_extras</span><span class="s2">, </span><span class="s1">extras</span>


<span class="s2">def </span><span class="s1">parse_editable(editable_req):</span>
    <span class="s3"># type: (str) -&gt; Tuple[Optional[str], str, Optional[Set[str]]]</span>
    <span class="s0">&quot;&quot;&quot;Parses an editable requirement into: 
        - a requirement name 
        - an URL 
        - extras 
        - editable options 
    Accepted requirements: 
        svn+http://blahblah@rev#egg=Foobar[baz]&amp;subdirectory=version_subdir 
        .[some_extra] 
    &quot;&quot;&quot;</span>

    <span class="s1">url = editable_req</span>

    <span class="s3"># If a file path is specified with extras, strip off the extras.</span>
    <span class="s1">url_no_extras</span><span class="s2">, </span><span class="s1">extras = _strip_extras(url)</span>

    <span class="s2">if </span><span class="s1">os.path.isdir(url_no_extras):</span>
        <span class="s2">if not </span><span class="s1">os.path.exists(os.path.join(url_no_extras</span><span class="s2">, </span><span class="s4">'setup.py'</span><span class="s1">)):</span>
            <span class="s1">msg = (</span>
                <span class="s4">'File &quot;setup.py&quot; not found. Directory cannot be installed '</span>
                <span class="s4">'in editable mode: {}'</span><span class="s1">.format(os.path.abspath(url_no_extras))</span>
            <span class="s1">)</span>
            <span class="s1">pyproject_path = make_pyproject_path(url_no_extras)</span>
            <span class="s2">if </span><span class="s1">os.path.isfile(pyproject_path):</span>
                <span class="s1">msg += (</span>
                    <span class="s4">'</span><span class="s2">\n</span><span class="s4">(A &quot;pyproject.toml&quot; file was found, but editable '</span>
                    <span class="s4">'mode currently requires a setup.py based build.)'</span>
                <span class="s1">)</span>
            <span class="s2">raise </span><span class="s1">InstallationError(msg)</span>

        <span class="s3"># Treating it as code that has already been checked out</span>
        <span class="s1">url_no_extras = path_to_url(url_no_extras)</span>

    <span class="s2">if </span><span class="s1">url_no_extras.lower().startswith(</span><span class="s4">'file:'</span><span class="s1">):</span>
        <span class="s1">package_name = Link(url_no_extras).egg_fragment</span>
        <span class="s2">if </span><span class="s1">extras:</span>
            <span class="s2">return </span><span class="s1">(</span>
                <span class="s1">package_name</span><span class="s2">,</span>
                <span class="s1">url_no_extras</span><span class="s2">,</span>
                <span class="s1">Requirement(</span><span class="s4">&quot;placeholder&quot; </span><span class="s1">+ extras.lower()).extras</span><span class="s2">,</span>
            <span class="s1">)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">package_name</span><span class="s2">, </span><span class="s1">url_no_extras</span><span class="s2">, None</span>

    <span class="s2">for </span><span class="s1">version_control </span><span class="s2">in </span><span class="s1">vcs:</span>
        <span class="s2">if </span><span class="s1">url.lower().startswith(</span><span class="s4">'%s:' </span><span class="s1">% version_control):</span>
            <span class="s1">url = </span><span class="s4">'%s+%s' </span><span class="s1">% (version_control</span><span class="s2">, </span><span class="s1">url)</span>
            <span class="s2">break</span>

    <span class="s2">if </span><span class="s4">'+' </span><span class="s2">not in </span><span class="s1">url:</span>
        <span class="s2">raise </span><span class="s1">InstallationError(</span>
            <span class="s4">'%s should either be a path to a local project or a VCS url '</span>
            <span class="s4">'beginning with svn+, git+, hg+, or bzr+' </span><span class="s1">%</span>
            <span class="s1">editable_req</span>
        <span class="s1">)</span>

    <span class="s1">vc_type = url.split(</span><span class="s4">'+'</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">].lower()</span>

    <span class="s2">if not </span><span class="s1">vcs.get_backend(vc_type):</span>
        <span class="s1">error_message = </span><span class="s4">'For --editable=%s only ' </span><span class="s1">% editable_req + \</span>
            <span class="s4">', '</span><span class="s1">.join([backend.name + </span><span class="s4">'+URL' </span><span class="s2">for </span><span class="s1">backend </span><span class="s2">in </span><span class="s1">vcs.backends]) + \</span>
            <span class="s4">' is currently supported'</span>
        <span class="s2">raise </span><span class="s1">InstallationError(error_message)</span>

    <span class="s1">package_name = Link(url).egg_fragment</span>
    <span class="s2">if not </span><span class="s1">package_name:</span>
        <span class="s2">raise </span><span class="s1">InstallationError(</span>
            <span class="s4">&quot;Could not detect requirement name for '%s', please specify one &quot;</span>
            <span class="s4">&quot;with #egg=your_package_name&quot; </span><span class="s1">% editable_req</span>
        <span class="s1">)</span>
    <span class="s2">return </span><span class="s1">package_name</span><span class="s2">, </span><span class="s1">url</span><span class="s2">, None</span>


<span class="s2">def </span><span class="s1">deduce_helpful_msg(req):</span>
    <span class="s3"># type: (str) -&gt; str</span>
    <span class="s0">&quot;&quot;&quot;Returns helpful msg in case requirements file does not exist, 
    or cannot be parsed. 
 
    :params req: Requirements file path 
    &quot;&quot;&quot;</span>
    <span class="s1">msg = </span><span class="s4">&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">os.path.exists(req):</span>
        <span class="s1">msg = </span><span class="s4">&quot; It does exist.&quot;</span>
        <span class="s3"># Try to parse and check if it is a requirements file.</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s2">with </span><span class="s1">open(req</span><span class="s2">, </span><span class="s4">'r'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">fp:</span>
                <span class="s3"># parse first line only</span>
                <span class="s1">next(parse_requirements(fp.read()))</span>
                <span class="s1">msg += </span><span class="s4">&quot; The argument you provided &quot; </span><span class="s1">+ \</span>
                    <span class="s4">&quot;(%s) appears to be a&quot; </span><span class="s1">% (req) + \</span>
                    <span class="s4">&quot; requirements file. If that is the&quot; </span><span class="s1">+ \</span>
                    <span class="s4">&quot; case, use the '-r' flag to install&quot; </span><span class="s1">+ \</span>
                    <span class="s4">&quot; the packages specified within it.&quot;</span>
        <span class="s2">except </span><span class="s1">RequirementParseError:</span>
            <span class="s1">logger.debug(</span><span class="s4">&quot;Cannot parse '%s' as requirements </span><span class="s2">\ 
            </span><span class="s4">file&quot; </span><span class="s1">% (req)</span><span class="s2">, </span><span class="s1">exc_info=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">msg += </span><span class="s4">&quot; File '%s' does not exist.&quot; </span><span class="s1">% (req)</span>
    <span class="s2">return </span><span class="s1">msg</span>


<span class="s3"># ---- The actual constructors follow ----</span>


<span class="s2">def </span><span class="s1">install_req_from_editable(</span>
    <span class="s1">editable_req</span><span class="s2">,  </span><span class="s3"># type: str</span>
    <span class="s1">comes_from=</span><span class="s2">None,  </span><span class="s3"># type: Optional[str]</span>
    <span class="s1">use_pep517=</span><span class="s2">None,  </span><span class="s3"># type: Optional[bool]</span>
    <span class="s1">isolated=</span><span class="s2">False,  </span><span class="s3"># type: bool</span>
    <span class="s1">options=</span><span class="s2">None,  </span><span class="s3"># type: Optional[Dict[str, Any]]</span>
    <span class="s1">wheel_cache=</span><span class="s2">None,  </span><span class="s3"># type: Optional[WheelCache]</span>
    <span class="s1">constraint=</span><span class="s2">False  </span><span class="s3"># type: bool</span>
<span class="s1">):</span>
    <span class="s3"># type: (...) -&gt; InstallRequirement</span>
    <span class="s1">name</span><span class="s2">, </span><span class="s1">url</span><span class="s2">, </span><span class="s1">extras_override = parse_editable(editable_req)</span>
    <span class="s2">if </span><span class="s1">url.startswith(</span><span class="s4">'file:'</span><span class="s1">):</span>
        <span class="s1">source_dir = url_to_path(url)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">source_dir = </span><span class="s2">None</span>

    <span class="s2">if </span><span class="s1">name </span><span class="s2">is not None</span><span class="s1">:</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">req = Requirement(name)</span>
        <span class="s2">except </span><span class="s1">InvalidRequirement:</span>
            <span class="s2">raise </span><span class="s1">InstallationError(</span><span class="s4">&quot;Invalid requirement: '%s'&quot; </span><span class="s1">% name)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">req = </span><span class="s2">None</span>
    <span class="s2">return </span><span class="s1">InstallRequirement(</span>
        <span class="s1">req</span><span class="s2">, </span><span class="s1">comes_from</span><span class="s2">, </span><span class="s1">source_dir=source_dir</span><span class="s2">,</span>
        <span class="s1">editable=</span><span class="s2">True,</span>
        <span class="s1">link=Link(url)</span><span class="s2">,</span>
        <span class="s1">constraint=constraint</span><span class="s2">,</span>
        <span class="s1">use_pep517=use_pep517</span><span class="s2">,</span>
        <span class="s1">isolated=isolated</span><span class="s2">,</span>
        <span class="s1">options=options </span><span class="s2">if </span><span class="s1">options </span><span class="s2">else </span><span class="s1">{}</span><span class="s2">,</span>
        <span class="s1">wheel_cache=wheel_cache</span><span class="s2">,</span>
        <span class="s1">extras=extras_override </span><span class="s2">or </span><span class="s1">()</span><span class="s2">,</span>
    <span class="s1">)</span>


<span class="s2">def </span><span class="s1">install_req_from_line(</span>
    <span class="s1">name</span><span class="s2">,  </span><span class="s3"># type: str</span>
    <span class="s1">comes_from=</span><span class="s2">None,  </span><span class="s3"># type: Optional[Union[str, InstallRequirement]]</span>
    <span class="s1">use_pep517=</span><span class="s2">None,  </span><span class="s3"># type: Optional[bool]</span>
    <span class="s1">isolated=</span><span class="s2">False,  </span><span class="s3"># type: bool</span>
    <span class="s1">options=</span><span class="s2">None,  </span><span class="s3"># type: Optional[Dict[str, Any]]</span>
    <span class="s1">wheel_cache=</span><span class="s2">None,  </span><span class="s3"># type: Optional[WheelCache]</span>
    <span class="s1">constraint=</span><span class="s2">False  </span><span class="s3"># type: bool</span>
<span class="s1">):</span>
    <span class="s3"># type: (...) -&gt; InstallRequirement</span>
    <span class="s0">&quot;&quot;&quot;Creates an InstallRequirement from a name, which might be a 
    requirement, directory containing 'setup.py', filename, or URL. 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">is_url(name):</span>
        <span class="s1">marker_sep = </span><span class="s4">'; '</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">marker_sep = </span><span class="s4">';'</span>
    <span class="s2">if </span><span class="s1">marker_sep </span><span class="s2">in </span><span class="s1">name:</span>
        <span class="s1">name</span><span class="s2">, </span><span class="s1">markers_as_string = name.split(marker_sep</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">markers_as_string = markers_as_string.strip()</span>
        <span class="s2">if not </span><span class="s1">markers_as_string:</span>
            <span class="s1">markers = </span><span class="s2">None</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">markers = Marker(markers_as_string)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">markers = </span><span class="s2">None</span>
    <span class="s1">name = name.strip()</span>
    <span class="s1">req_as_string = </span><span class="s2">None</span>
    <span class="s1">path = os.path.normpath(os.path.abspath(name))</span>
    <span class="s1">link = </span><span class="s2">None</span>
    <span class="s1">extras_as_string = </span><span class="s2">None</span>

    <span class="s2">if </span><span class="s1">is_url(name):</span>
        <span class="s1">link = Link(name)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">p</span><span class="s2">, </span><span class="s1">extras_as_string = _strip_extras(path)</span>
        <span class="s1">looks_like_dir = os.path.isdir(p) </span><span class="s2">and </span><span class="s1">(</span>
            <span class="s1">os.path.sep </span><span class="s2">in </span><span class="s1">name </span><span class="s2">or</span>
            <span class="s1">(os.path.altsep </span><span class="s2">is not None and </span><span class="s1">os.path.altsep </span><span class="s2">in </span><span class="s1">name) </span><span class="s2">or</span>
            <span class="s1">name.startswith(</span><span class="s4">'.'</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s2">if </span><span class="s1">looks_like_dir:</span>
            <span class="s2">if not </span><span class="s1">is_installable_dir(p):</span>
                <span class="s2">raise </span><span class="s1">InstallationError(</span>
                    <span class="s4">&quot;Directory %r is not installable. Neither 'setup.py' &quot;</span>
                    <span class="s4">&quot;nor 'pyproject.toml' found.&quot; </span><span class="s1">% name</span>
                <span class="s1">)</span>
            <span class="s1">link = Link(path_to_url(p))</span>
        <span class="s2">elif </span><span class="s1">is_archive_file(p):</span>
            <span class="s2">if not </span><span class="s1">os.path.isfile(p):</span>
                <span class="s1">logger.warning(</span>
                    <span class="s4">'Requirement %r looks like a filename, but the '</span>
                    <span class="s4">'file does not exist'</span><span class="s2">,</span>
                    <span class="s1">name</span>
                <span class="s1">)</span>
            <span class="s1">link = Link(path_to_url(p))</span>

    <span class="s3"># it's a local file, dir, or url</span>
    <span class="s2">if </span><span class="s1">link:</span>
        <span class="s3"># Handle relative file URLs</span>
        <span class="s2">if </span><span class="s1">link.scheme == </span><span class="s4">'file' </span><span class="s2">and </span><span class="s1">re.search(</span><span class="s4">r'\.\./'</span><span class="s2">, </span><span class="s1">link.url):</span>
            <span class="s1">link = Link(</span>
                <span class="s1">path_to_url(os.path.normpath(os.path.abspath(link.path))))</span>
        <span class="s3"># wheel file</span>
        <span class="s2">if </span><span class="s1">link.is_wheel:</span>
            <span class="s1">wheel = Wheel(link.filename)  </span><span class="s3"># can raise InvalidWheelFilename</span>
            <span class="s1">req_as_string = </span><span class="s4">&quot;%s==%s&quot; </span><span class="s1">% (wheel.name</span><span class="s2">, </span><span class="s1">wheel.version)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s3"># set the req to the egg fragment.  when it's not there, this</span>
            <span class="s3"># will become an 'unnamed' requirement</span>
            <span class="s1">req_as_string = link.egg_fragment</span>

    <span class="s3"># a requirement specifier</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">req_as_string = name</span>

    <span class="s2">if </span><span class="s1">extras_as_string:</span>
        <span class="s1">extras = Requirement(</span><span class="s4">&quot;placeholder&quot; </span><span class="s1">+ extras_as_string.lower()).extras</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">extras = ()</span>
    <span class="s2">if </span><span class="s1">req_as_string </span><span class="s2">is not None</span><span class="s1">:</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">req = Requirement(req_as_string)</span>
        <span class="s2">except </span><span class="s1">InvalidRequirement:</span>
            <span class="s2">if </span><span class="s1">os.path.sep </span><span class="s2">in </span><span class="s1">req_as_string:</span>
                <span class="s1">add_msg = </span><span class="s4">&quot;It looks like a path.&quot;</span>
                <span class="s1">add_msg += deduce_helpful_msg(req_as_string)</span>
            <span class="s2">elif </span><span class="s1">(</span><span class="s4">'=' </span><span class="s2">in </span><span class="s1">req_as_string </span><span class="s2">and</span>
                  <span class="s2">not </span><span class="s1">any(op </span><span class="s2">in </span><span class="s1">req_as_string </span><span class="s2">for </span><span class="s1">op </span><span class="s2">in </span><span class="s1">operators)):</span>
                <span class="s1">add_msg = </span><span class="s4">&quot;= is not a valid operator. Did you mean == ?&quot;</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">add_msg = </span><span class="s4">&quot;&quot;</span>
            <span class="s2">raise </span><span class="s1">InstallationError(</span>
                <span class="s4">&quot;Invalid requirement: '%s'</span><span class="s2">\n</span><span class="s4">%s&quot; </span><span class="s1">% (req_as_string</span><span class="s2">, </span><span class="s1">add_msg)</span>
            <span class="s1">)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">req = </span><span class="s2">None</span>

    <span class="s2">return </span><span class="s1">InstallRequirement(</span>
        <span class="s1">req</span><span class="s2">, </span><span class="s1">comes_from</span><span class="s2">, </span><span class="s1">link=link</span><span class="s2">, </span><span class="s1">markers=markers</span><span class="s2">,</span>
        <span class="s1">use_pep517=use_pep517</span><span class="s2">, </span><span class="s1">isolated=isolated</span><span class="s2">,</span>
        <span class="s1">options=options </span><span class="s2">if </span><span class="s1">options </span><span class="s2">else </span><span class="s1">{}</span><span class="s2">,</span>
        <span class="s1">wheel_cache=wheel_cache</span><span class="s2">,</span>
        <span class="s1">constraint=constraint</span><span class="s2">,</span>
        <span class="s1">extras=extras</span><span class="s2">,</span>
    <span class="s1">)</span>


<span class="s2">def </span><span class="s1">install_req_from_req_string(</span>
    <span class="s1">req_string</span><span class="s2">,  </span><span class="s3"># type: str</span>
    <span class="s1">comes_from=</span><span class="s2">None,  </span><span class="s3"># type: Optional[InstallRequirement]</span>
    <span class="s1">isolated=</span><span class="s2">False,  </span><span class="s3"># type: bool</span>
    <span class="s1">wheel_cache=</span><span class="s2">None,  </span><span class="s3"># type: Optional[WheelCache]</span>
    <span class="s1">use_pep517=</span><span class="s2">None  </span><span class="s3"># type: Optional[bool]</span>
<span class="s1">):</span>
    <span class="s3"># type: (...) -&gt; InstallRequirement</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">req = Requirement(req_string)</span>
    <span class="s2">except </span><span class="s1">InvalidRequirement:</span>
        <span class="s2">raise </span><span class="s1">InstallationError(</span><span class="s4">&quot;Invalid requirement: '%s'&quot; </span><span class="s1">% req)</span>

    <span class="s1">domains_not_allowed = [</span>
        <span class="s1">PyPI.file_storage_domain</span><span class="s2">,</span>
        <span class="s1">TestPyPI.file_storage_domain</span><span class="s2">,</span>
    <span class="s1">]</span>
    <span class="s2">if </span><span class="s1">req.url </span><span class="s2">and </span><span class="s1">comes_from.link.netloc </span><span class="s2">in </span><span class="s1">domains_not_allowed:</span>
        <span class="s3"># Explicitly disallow pypi packages that depend on external urls</span>
        <span class="s2">raise </span><span class="s1">InstallationError(</span>
            <span class="s4">&quot;Packages installed from PyPI cannot depend on packages &quot;</span>
            <span class="s4">&quot;which are not also hosted on PyPI.</span><span class="s2">\n</span><span class="s4">&quot;</span>
            <span class="s4">&quot;%s depends on %s &quot; </span><span class="s1">% (comes_from.name</span><span class="s2">, </span><span class="s1">req)</span>
        <span class="s1">)</span>

    <span class="s2">return </span><span class="s1">InstallRequirement(</span>
        <span class="s1">req</span><span class="s2">, </span><span class="s1">comes_from</span><span class="s2">, </span><span class="s1">isolated=isolated</span><span class="s2">, </span><span class="s1">wheel_cache=wheel_cache</span><span class="s2">,</span>
        <span class="s1">use_pep517=use_pep517</span>
    <span class="s1">)</span>
</pre>
</body>
</html>