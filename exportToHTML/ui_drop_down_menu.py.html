<html>
<head>
<title>ui_drop_down_menu.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ui_drop_down_menu.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Union</span><span class="s0">, </span><span class="s1">List</span><span class="s0">, </span><span class="s1">Tuple</span><span class="s0">, </span><span class="s1">Dict</span>

<span class="s0">import </span><span class="s1">pygame</span>

<span class="s0">from </span><span class="s1">pygame_gui._constants </span><span class="s0">import </span><span class="s1">UI_BUTTON_PRESSED</span><span class="s0">, </span><span class="s1">UI_SELECTION_LIST_NEW_SELECTION</span>
<span class="s0">from </span><span class="s1">pygame_gui._constants </span><span class="s0">import </span><span class="s1">UI_DROP_DOWN_MENU_CHANGED</span>

<span class="s0">from </span><span class="s1">pygame_gui.core.interfaces </span><span class="s0">import </span><span class="s1">IContainerLikeInterface</span><span class="s0">, </span><span class="s1">IUIManagerInterface</span>
<span class="s0">from </span><span class="s1">pygame_gui.core </span><span class="s0">import </span><span class="s1">UIElement</span><span class="s0">, </span><span class="s1">ObjectID</span>
<span class="s0">from </span><span class="s1">pygame_gui.core.drawable_shapes </span><span class="s0">import </span><span class="s1">RectDrawableShape</span><span class="s0">, </span><span class="s1">RoundedRectangleShape</span>

<span class="s0">from </span><span class="s1">pygame_gui.elements.ui_button </span><span class="s0">import </span><span class="s1">UIButton</span>
<span class="s0">from </span><span class="s1">pygame_gui.elements.ui_selection_list </span><span class="s0">import </span><span class="s1">UISelectionList</span>


<span class="s0">class </span><span class="s1">UIExpandedDropDownState:</span>
    <span class="s2">&quot;&quot;&quot; 
    The expanded state of the drop down  displays the currently chosen option, all the available 
    options and a button to close the menu and return to the closed state. 
 
    Picking an option will also close the menu. 
 
    :param drop_down_menu_ui: The UIDropDownElement this state belongs to. 
    :param options_list: The list of options in this drop down. 
    :param selected_option: The currently selected option. 
    :param base_position_rect: Position and dimensions rectangle. 
    :param close_button_width: Width of close button. 
    :param expand_direction: Direction of expansion, 'up' or 'down'. 
    :param manager: The UI Manager for the whole UI. 
    :param container: The container the element is within. 
    :param object_ids: The object IDs for the drop down UI element. 
    :param element_ids: The element IDs for the drop down UI element. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">,</span>
                 <span class="s1">drop_down_menu_ui: </span><span class="s3">'UIDropDownMenu'</span><span class="s0">,</span>
                 <span class="s1">options_list: List[str]</span><span class="s0">,</span>
                 <span class="s1">selected_option: str</span><span class="s0">,</span>
                 <span class="s1">base_position_rect: Union[pygame.Rect</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">close_button_width: int</span><span class="s0">,</span>
                 <span class="s1">expand_direction: Union[str</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">manager: IUIManagerInterface</span><span class="s0">,</span>
                 <span class="s1">container: IContainerLikeInterface</span><span class="s0">,</span>
                 <span class="s1">object_ids: Union[List[Union[str</span><span class="s0">, None</span><span class="s1">]]</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">element_ids: Union[List[str]</span><span class="s0">, None</span><span class="s1">]):</span>

        <span class="s1">self.drop_down_menu_ui = drop_down_menu_ui</span>
        <span class="s1">self.options_list = options_list</span>
        <span class="s1">self.selected_option = selected_option</span>
        <span class="s1">self.base_position_rect = base_position_rect</span>

        <span class="s1">self.expand_direction = expand_direction</span>
        <span class="s1">self.ui_manager = manager</span>
        <span class="s1">self.ui_container = container</span>
        <span class="s1">self.element_ids = element_ids</span>
        <span class="s1">self.object_ids = object_ids</span>

        <span class="s4"># sizing variables</span>
        <span class="s1">self.options_list_height = </span><span class="s5">0</span>
        <span class="s1">self.option_list_y_pos = </span><span class="s5">0</span>
        <span class="s1">self.close_button_width = close_button_width</span>

        <span class="s4"># UI elements</span>
        <span class="s1">self.selected_option_button = </span><span class="s0">None</span>
        <span class="s1">self.close_button = </span><span class="s0">None</span>
        <span class="s1">self.options_selection_list = </span><span class="s0">None</span>

        <span class="s4"># state transitioning</span>
        <span class="s1">self.should_transition = </span><span class="s0">False</span>
        <span class="s1">self.target_state = </span><span class="s3">'closed'</span>

    <span class="s0">def </span><span class="s1">rebuild(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Rebuild the state from theming parameters and dimensions. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">theming_parameters = {</span><span class="s3">'normal_bg'</span><span class="s1">: self.drop_down_menu_ui.background_colour</span><span class="s0">,</span>
                              <span class="s3">'normal_border'</span><span class="s1">: self.drop_down_menu_ui.border_colour</span><span class="s0">,</span>
                              <span class="s3">'border_width'</span><span class="s1">: self.drop_down_menu_ui.border_width</span><span class="s0">,</span>
                              <span class="s3">'shadow_width'</span><span class="s1">: self.drop_down_menu_ui.shadow_width</span><span class="s0">,</span>
                              <span class="s3">'shape_corner_radius'</span><span class="s1">: self.drop_down_menu_ui.shape_corner_radius}</span>

        <span class="s1">shape_rect = self.drop_down_menu_ui.relative_rect</span>
        <span class="s0">if </span><span class="s1">self.drop_down_menu_ui.shape == </span><span class="s3">'rectangle'</span><span class="s1">:</span>
            <span class="s1">self.drop_down_menu_ui.drawable_shape = RectDrawableShape(shape_rect</span><span class="s0">,</span>
                                                                      <span class="s1">theming_parameters</span><span class="s0">,</span>
                                                                      <span class="s1">[</span><span class="s3">'normal'</span><span class="s1">]</span><span class="s0">,</span>
                                                                      <span class="s1">self.ui_manager)</span>

        <span class="s0">elif </span><span class="s1">self.drop_down_menu_ui.shape == </span><span class="s3">'rounded_rectangle'</span><span class="s1">:</span>
            <span class="s1">self.drop_down_menu_ui.drawable_shape = RoundedRectangleShape(shape_rect</span><span class="s0">,</span>
                                                                          <span class="s1">theming_parameters</span><span class="s0">,</span>
                                                                          <span class="s1">[</span><span class="s3">'normal'</span><span class="s1">]</span><span class="s0">,</span>
                                                                          <span class="s1">self.ui_manager)</span>

        <span class="s1">self.on_fresh_drawable_shape_ready()</span>

        <span class="s4"># extra</span>
        <span class="s0">if </span><span class="s1">self.close_button </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">expand_button_symbol = </span><span class="s3">'▼'</span>
            <span class="s0">if </span><span class="s1">self.expand_direction </span><span class="s0">is not None</span><span class="s1">:</span>
                <span class="s0">if </span><span class="s1">self.expand_direction == </span><span class="s3">'up'</span><span class="s1">:</span>
                    <span class="s1">expand_button_symbol = </span><span class="s3">'▲'</span>
                <span class="s0">elif </span><span class="s1">self.expand_direction == </span><span class="s3">'down'</span><span class="s1">:</span>
                    <span class="s1">expand_button_symbol = </span><span class="s3">'▼'</span>
            <span class="s1">self.close_button.set_text(expand_button_symbol)</span>

    <span class="s0">def </span><span class="s1">start(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Called each time we enter the expanded state. It creates the necessary elements, the 
        selected option, all the other available options and the close button. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">self.should_transition = </span><span class="s0">False</span>

        <span class="s1">self.selected_option_button = UIButton(pygame.Rect(self.base_position_rect.topleft</span><span class="s0">,</span>
                                                           <span class="s1">(self.base_position_rect.width -</span>
                                                            <span class="s1">self.close_button_width</span><span class="s0">,</span>
                                                            <span class="s1">self.base_position_rect.height))</span><span class="s0">,</span>
                                               <span class="s1">self.selected_option</span><span class="s0">,</span>
                                               <span class="s1">self.ui_manager</span><span class="s0">,</span>
                                               <span class="s1">self.ui_container</span><span class="s0">,</span>
                                               <span class="s1">starting_height=</span><span class="s5">2</span><span class="s0">,</span>
                                               <span class="s1">parent_element=self.drop_down_menu_ui</span><span class="s0">,</span>
                                               <span class="s1">object_id=ObjectID(</span><span class="s3">'#selected_option'</span><span class="s0">, None</span><span class="s1">))</span>
        <span class="s1">self.drop_down_menu_ui.join_focus_sets(self.selected_option_button)</span>

        <span class="s1">expand_button_symbol = </span><span class="s3">'▼'</span>

        <span class="s1">list_object_id = </span><span class="s3">'#drop_down_options_list'</span>
        <span class="s1">list_object_ids = self.drop_down_menu_ui.object_ids[:]</span>
        <span class="s1">list_object_ids.append(list_object_id)</span>
        <span class="s1">list_class_ids = self.drop_down_menu_ui.class_ids[:]</span>
        <span class="s1">list_class_ids.append(</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">list_element_ids = self.drop_down_menu_ui.element_ids[:]</span>
        <span class="s1">list_element_ids.append(</span><span class="s3">'selection_list'</span><span class="s1">)</span>

        <span class="s1">final_ids = self.ui_manager.get_theme().build_all_combined_ids(list_element_ids</span><span class="s0">,</span>
                                                                       <span class="s1">list_class_ids</span><span class="s0">,</span>
                                                                       <span class="s1">list_object_ids)</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">list_shadow_width = int(</span>
                <span class="s1">self.ui_manager.get_theme().get_misc_data(</span><span class="s3">'shadow_width'</span><span class="s0">, </span><span class="s1">final_ids))</span>
        <span class="s0">except </span><span class="s1">(LookupError</span><span class="s0">, </span><span class="s1">ValueError):</span>
            <span class="s1">list_shadow_width = </span><span class="s5">2</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">list_border_width = int(</span>
                <span class="s1">self.ui_manager.get_theme().get_misc_data(</span><span class="s3">'border_width'</span><span class="s0">, </span><span class="s1">final_ids))</span>
        <span class="s0">except </span><span class="s1">(LookupError</span><span class="s0">, </span><span class="s1">ValueError):</span>
            <span class="s1">list_border_width = </span><span class="s5">1</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">list_item_height = int(</span>
                <span class="s1">self.ui_manager.get_theme().get_misc_data(</span><span class="s3">'list_item_height'</span><span class="s0">, </span><span class="s1">final_ids))</span>
        <span class="s0">except </span><span class="s1">(LookupError</span><span class="s0">, </span><span class="s1">ValueError):</span>
            <span class="s1">list_item_height = </span><span class="s5">20</span>

        <span class="s1">options_list_border_and_shadow = list_shadow_width + list_border_width</span>
        <span class="s1">self.options_list_height = ((list_item_height * len(self.options_list)) +</span>
                                    <span class="s1">(</span><span class="s5">2 </span><span class="s1">* options_list_border_and_shadow))</span>
        <span class="s1">self.option_list_y_pos = </span><span class="s5">0</span>
        <span class="s0">if </span><span class="s1">self.expand_direction </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s0">if </span><span class="s1">self.expand_direction == </span><span class="s3">'up'</span><span class="s1">:</span>
                <span class="s1">expand_button_symbol = </span><span class="s3">'▲'</span>

                <span class="s0">if </span><span class="s1">self.drop_down_menu_ui.expansion_height_limit </span><span class="s0">is None</span><span class="s1">:</span>
                    <span class="s1">self.drop_down_menu_ui.expansion_height_limit = self.base_position_rect.top</span>

                <span class="s1">self.options_list_height = min(self.options_list_height</span><span class="s0">,</span>
                                               <span class="s1">self.drop_down_menu_ui.expansion_height_limit)</span>

                <span class="s1">self.option_list_y_pos = self.base_position_rect.top - self.options_list_height</span>

            <span class="s0">elif </span><span class="s1">self.expand_direction == </span><span class="s3">'down'</span><span class="s1">:</span>
                <span class="s1">expand_button_symbol = </span><span class="s3">'▼'</span>

                <span class="s0">if </span><span class="s1">self.drop_down_menu_ui.expansion_height_limit </span><span class="s0">is None</span><span class="s1">:</span>
                    <span class="s1">height_limit = (self.drop_down_menu_ui.ui_container.relative_rect.height -</span>
                                    <span class="s1">self.base_position_rect.bottom)</span>
                    <span class="s1">self.drop_down_menu_ui.expansion_height_limit = height_limit</span>

                <span class="s1">self.options_list_height = min(self.options_list_height</span><span class="s0">,</span>
                                               <span class="s1">self.drop_down_menu_ui.expansion_height_limit)</span>

                <span class="s1">self.option_list_y_pos = self.base_position_rect.bottom</span>

        <span class="s1">close_button_x = (self.base_position_rect.x +</span>
                          <span class="s1">self.base_position_rect.width -</span>
                          <span class="s1">self.close_button_width)</span>

        <span class="s1">self.close_button = UIButton(pygame.Rect((close_button_x</span><span class="s0">,</span>
                                                  <span class="s1">self.base_position_rect.y)</span><span class="s0">,</span>
                                                 <span class="s1">(self.close_button_width</span><span class="s0">,</span>
                                                  <span class="s1">self.base_position_rect.height))</span><span class="s0">,</span>
                                     <span class="s1">expand_button_symbol</span><span class="s0">,</span>
                                     <span class="s1">self.ui_manager</span><span class="s0">,</span>
                                     <span class="s1">self.ui_container</span><span class="s0">,</span>
                                     <span class="s1">starting_height=</span><span class="s5">2</span><span class="s0">,</span>
                                     <span class="s1">parent_element=self.drop_down_menu_ui</span><span class="s0">,</span>
                                     <span class="s1">object_id=</span><span class="s3">'#expand_button'</span><span class="s1">)</span>
        <span class="s1">self.drop_down_menu_ui.join_focus_sets(self.close_button)</span>

        <span class="s1">list_rect = pygame.Rect(self.drop_down_menu_ui.relative_rect.left</span><span class="s0">,</span>
                                <span class="s1">self.option_list_y_pos</span><span class="s0">,</span>
                                <span class="s1">(self.drop_down_menu_ui.relative_rect.width -</span>
                                 <span class="s1">self.close_button_width)</span><span class="s0">,</span>
                                <span class="s1">self.options_list_height)</span>
        <span class="s1">self.options_selection_list = UISelectionList(list_rect</span><span class="s0">,</span>
                                                      <span class="s1">starting_height=</span><span class="s5">2</span><span class="s0">,</span>
                                                      <span class="s1">item_list=self.options_list</span><span class="s0">,</span>
                                                      <span class="s1">allow_double_clicks=</span><span class="s0">False,</span>
                                                      <span class="s1">manager=self.ui_manager</span><span class="s0">,</span>
                                                      <span class="s1">parent_element=self.drop_down_menu_ui</span><span class="s0">,</span>
                                                      <span class="s1">container=self.ui_container</span><span class="s0">,</span>
                                                      <span class="s1">object_id=</span><span class="s3">'#drop_down_options_list'</span><span class="s1">)</span>
        <span class="s1">self.drop_down_menu_ui.join_focus_sets(self.options_selection_list)</span>

        <span class="s1">self.rebuild()</span>

    <span class="s0">def </span><span class="s1">finish(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        cleans everything up upon exiting the expanded menu state. 
        &quot;&quot;&quot;</span>
        <span class="s1">self.options_selection_list.kill()</span>
        <span class="s1">self.selected_option_button.kill()</span>
        <span class="s1">self.close_button.kill()</span>

    <span class="s0">def </span><span class="s1">process_event(self</span><span class="s0">, </span><span class="s1">event: pygame.event.Event) -&gt; bool:</span>
        <span class="s2">&quot;&quot;&quot; 
        Processes events for the closed state of the drop down. 
 
        :param event: The event to process. 
 
        :return: Return True if we want to consume this event so it is not passed on to the 
                 rest of the UI. 
 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">(event.type == pygame.USEREVENT </span><span class="s0">and</span>
                <span class="s1">event.user_type == UI_BUTTON_PRESSED </span><span class="s0">and</span>
                <span class="s1">event.ui_element </span><span class="s0">in </span><span class="s1">[self.close_button</span><span class="s0">, </span><span class="s1">self.selected_option_button]):</span>

            <span class="s1">self.should_transition = </span><span class="s0">True</span>

        <span class="s0">if </span><span class="s1">(event.type == pygame.USEREVENT </span><span class="s0">and</span>
                <span class="s1">event.user_type == UI_SELECTION_LIST_NEW_SELECTION </span><span class="s0">and</span>
                <span class="s1">event.ui_element == self.options_selection_list):</span>
            <span class="s1">selection = self.options_selection_list.get_single_selection()</span>
            <span class="s1">self.drop_down_menu_ui.selected_option = selection</span>
            <span class="s1">self.should_transition = </span><span class="s0">True</span>

            <span class="s1">event_data = {</span><span class="s3">'user_type'</span><span class="s1">: UI_DROP_DOWN_MENU_CHANGED</span><span class="s0">,</span>
                          <span class="s3">'text'</span><span class="s1">: self.drop_down_menu_ui.selected_option</span><span class="s0">,</span>
                          <span class="s3">'ui_element'</span><span class="s1">: self.drop_down_menu_ui</span><span class="s0">,</span>
                          <span class="s3">'ui_object_id'</span><span class="s1">: self.drop_down_menu_ui.most_specific_combined_id}</span>
            <span class="s1">drop_down_changed_event = pygame.event.Event(pygame.USEREVENT</span><span class="s0">, </span><span class="s1">event_data)</span>
            <span class="s1">pygame.event.post(drop_down_changed_event)</span>

        <span class="s0">return False  </span><span class="s4"># don't consume any events</span>

    <span class="s0">def </span><span class="s1">update_position(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Update the position of all the button elements in the open drop down state. 
 
        Used when the position of the  drop down has been altered directly, rather than when it 
        has been moved as a consequence of it's container being moved. 
        &quot;&quot;&quot;</span>

        <span class="s4"># update the base position rect</span>
        <span class="s1">border_and_shadow = (self.drop_down_menu_ui.shadow_width +</span>
                             <span class="s1">self.drop_down_menu_ui.border_width)</span>
        <span class="s1">self.base_position_rect.x = self.drop_down_menu_ui.relative_rect.x + border_and_shadow</span>
        <span class="s1">self.base_position_rect.y = self.drop_down_menu_ui.relative_rect.y + border_and_shadow</span>

        <span class="s4"># update all the ui elements that depend on the base position</span>
        <span class="s1">self.selected_option_button.set_relative_position(self.base_position_rect.topleft)</span>
        <span class="s1">list_post = (self.drop_down_menu_ui.relative_rect.left</span><span class="s0">, </span><span class="s1">self.option_list_y_pos)</span>
        <span class="s1">self.options_selection_list.set_relative_position(list_post)</span>

        <span class="s1">close_button_x = (self.base_position_rect.x +</span>
                          <span class="s1">self.base_position_rect.width -</span>
                          <span class="s1">self.close_button_width)</span>
        <span class="s1">self.close_button.set_relative_position([close_button_x</span><span class="s0">, </span><span class="s1">self.base_position_rect.y])</span>

    <span class="s0">def </span><span class="s1">update_dimensions(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Update the dimensions of all the button elements in the closed drop down state. 
 
        Used when the dimensions of the drop down have been altered. 
        &quot;&quot;&quot;</span>

        <span class="s4"># update the base position rect</span>
        <span class="s1">border_and_shadow = (self.drop_down_menu_ui.shadow_width +</span>
                             <span class="s1">self.drop_down_menu_ui.border_width)</span>
        <span class="s1">self.base_position_rect.width = (self.drop_down_menu_ui.relative_rect.width -</span>
                                         <span class="s1">(</span><span class="s5">2 </span><span class="s1">* border_and_shadow))</span>
        <span class="s1">self.base_position_rect.height = (self.drop_down_menu_ui.relative_rect.height -</span>
                                          <span class="s1">(</span><span class="s5">2 </span><span class="s1">* border_and_shadow))</span>

        <span class="s0">if </span><span class="s1">self.expand_direction </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s0">if </span><span class="s1">self.expand_direction == </span><span class="s3">'up'</span><span class="s1">:</span>
                <span class="s1">self.options_list_height = min(self.options_list_height</span><span class="s0">,</span>
                                               <span class="s1">self.drop_down_menu_ui.expansion_height_limit)</span>
                <span class="s1">self.option_list_y_pos = self.base_position_rect.top - self.options_list_height</span>

            <span class="s0">elif </span><span class="s1">self.expand_direction == </span><span class="s3">'down'</span><span class="s1">:</span>
                <span class="s1">self.options_list_height = min(self.options_list_height</span><span class="s0">,</span>
                                               <span class="s1">self.drop_down_menu_ui.expansion_height_limit)</span>
                <span class="s1">self.option_list_y_pos = self.base_position_rect.bottom</span>

        <span class="s4"># update all the ui elements that depend on the base position rect</span>
        <span class="s1">self.selected_option_button.set_dimensions((self.base_position_rect.width -</span>
                                                    <span class="s1">self.close_button_width</span><span class="s0">,</span>
                                                    <span class="s1">self.base_position_rect.height))</span>

        <span class="s1">self.options_selection_list.set_dimensions(((self.drop_down_menu_ui.relative_rect.width -</span>
                                                     <span class="s1">self.close_button_width)</span><span class="s0">,</span>
                                                    <span class="s1">self.options_list_height))</span>

        <span class="s1">list_pos = (self.drop_down_menu_ui.relative_rect.left</span><span class="s0">, </span><span class="s1">self.option_list_y_pos)</span>
        <span class="s1">self.options_selection_list.set_relative_position(list_pos)</span>

        <span class="s1">close_button_x = (self.base_position_rect.x +</span>
                          <span class="s1">self.base_position_rect.width -</span>
                          <span class="s1">self.close_button_width)</span>
        <span class="s1">self.close_button.set_dimensions((self.close_button_width</span><span class="s0">,</span>
                                          <span class="s1">self.base_position_rect.height))</span>
        <span class="s1">self.close_button.set_relative_position((close_button_x</span><span class="s0">, </span><span class="s1">self.base_position_rect.y))</span>

        <span class="s4"># self.rebuild()</span>

    <span class="s0">def </span><span class="s1">on_fresh_drawable_shape_ready(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Called by an element's drawable shape when it has a new image surface ready for use, 
        normally after a rebuilding/redrawing of some kind. 
 
        In this case the result is to set the UI element's image to the new surface. 
        &quot;&quot;&quot;</span>
        <span class="s1">image = self.drop_down_menu_ui.drawable_shape.get_fresh_surface()</span>
        <span class="s1">self.drop_down_menu_ui.set_image(image)</span>

    <span class="s0">def </span><span class="s1">hide(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Transition from expanded state to closed state. 
        &quot;&quot;&quot;</span>
        <span class="s1">self.should_transition = </span><span class="s0">True</span>


<span class="s0">class </span><span class="s1">UIClosedDropDownState:</span>
    <span class="s2">&quot;&quot;&quot; 
    The closed state of the drop down just displays the currently chosen option and a button that 
    will switch the menu to the expanded state. 
 
    :param drop_down_menu_ui: The UIDropDownElement this state belongs to. 
    :param selected_option: The currently selected option. 
    :param base_position_rect: Position and dimensions rectangle. 
    :param open_button_width: Width of open button. 
    :param expand_direction: Direction of expansion, 'up' or 'down'. 
    :param manager: The UI Manager for the whole UI. 
    :param container: The container the element is within. 
    :param object_ids: The object IDs for the drop down UI element. 
    :param element_ids: The element IDs for the drop down UI element. 
    :param visible: Whether the element is visible by default. Warning - 
                    container visibility may override this. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">,</span>
                 <span class="s1">drop_down_menu_ui: </span><span class="s3">'UIDropDownMenu'</span><span class="s0">,</span>
                 <span class="s1">selected_option: str</span><span class="s0">,</span>
                 <span class="s1">base_position_rect: Union[pygame.Rect</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">open_button_width: int</span><span class="s0">,</span>
                 <span class="s1">expand_direction: Union[str</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">manager: IUIManagerInterface</span><span class="s0">,</span>
                 <span class="s1">container: IContainerLikeInterface</span><span class="s0">,</span>
                 <span class="s1">object_ids: Union[List[Union[str</span><span class="s0">, None</span><span class="s1">]]</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">element_ids: Union[List[str]</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">visible: int = </span><span class="s5">1</span><span class="s1">):</span>

        <span class="s1">self.drop_down_menu_ui = drop_down_menu_ui</span>
        <span class="s1">self.selected_option_button = </span><span class="s0">None</span>
        <span class="s1">self.open_button = </span><span class="s0">None</span>
        <span class="s1">self.selected_option = selected_option</span>
        <span class="s1">self.base_position_rect = base_position_rect</span>
        <span class="s1">self.expand_direction = expand_direction</span>
        <span class="s1">self.ui_manager = manager</span>
        <span class="s1">self.ui_container = container</span>
        <span class="s1">self.element_ids = element_ids</span>
        <span class="s1">self.object_ids = object_ids</span>

        <span class="s1">self.open_button_width = open_button_width</span>

        <span class="s1">self.should_transition = </span><span class="s0">False</span>
        <span class="s1">self.target_state = </span><span class="s3">'expanded'</span>
        <span class="s1">self.visible = visible</span>

    <span class="s0">def </span><span class="s1">disable(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Disables the closed state so that it is no longer interactive. 
        &quot;&quot;&quot;</span>
        <span class="s1">self.selected_option_button.disable()</span>
        <span class="s1">self.open_button.disable()</span>
        <span class="s1">self.drop_down_menu_ui.drawable_shape.set_active_state(</span><span class="s3">'disabled'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">enable(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Re-enables the closed state so we can once again interact with it. 
        &quot;&quot;&quot;</span>
        <span class="s1">self.selected_option_button.enable()</span>
        <span class="s1">self.open_button.enable()</span>
        <span class="s1">self.drop_down_menu_ui.drawable_shape.set_active_state(</span><span class="s3">'normal'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">rebuild(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Rebuild the closed state from theming parameters and dimensions. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">theming_parameters = {</span><span class="s3">'normal_bg'</span><span class="s1">: self.drop_down_menu_ui.background_colour</span><span class="s0">,</span>
                              <span class="s3">'normal_border'</span><span class="s1">: self.drop_down_menu_ui.border_colour</span><span class="s0">,</span>
                              <span class="s3">'disabled_bg'</span><span class="s1">: self.drop_down_menu_ui.disabled_background_colour</span><span class="s0">,</span>
                              <span class="s3">'disabled_border'</span><span class="s1">: self.drop_down_menu_ui.disabled_border_colour</span><span class="s0">,</span>
                              <span class="s3">'border_width'</span><span class="s1">: self.drop_down_menu_ui.border_width</span><span class="s0">,</span>
                              <span class="s3">'shadow_width'</span><span class="s1">: self.drop_down_menu_ui.shadow_width</span><span class="s0">,</span>
                              <span class="s3">'shape_corner_radius'</span><span class="s1">: self.drop_down_menu_ui.shape_corner_radius}</span>

        <span class="s0">if </span><span class="s1">self.drop_down_menu_ui.shape == </span><span class="s3">'rectangle'</span><span class="s1">:</span>
            <span class="s1">self.drop_down_menu_ui.drawable_shape = RectDrawableShape(self.drop_down_menu_ui.rect</span><span class="s0">,</span>
                                                                      <span class="s1">theming_parameters</span><span class="s0">,</span>
                                                                      <span class="s1">[</span><span class="s3">'normal'</span><span class="s0">, </span><span class="s3">'disabled'</span><span class="s1">]</span><span class="s0">,</span>
                                                                      <span class="s1">self.ui_manager)</span>
        <span class="s0">elif </span><span class="s1">self.drop_down_menu_ui.shape == </span><span class="s3">'rounded_rectangle'</span><span class="s1">:</span>
            <span class="s1">shape_rect = self.drop_down_menu_ui.rect</span>
            <span class="s1">self.drop_down_menu_ui.drawable_shape = RoundedRectangleShape(shape_rect</span><span class="s0">,</span>
                                                                          <span class="s1">theming_parameters</span><span class="s0">,</span>
                                                                          <span class="s1">[</span><span class="s3">'normal'</span><span class="s0">, </span><span class="s3">'disabled'</span><span class="s1">]</span><span class="s0">,</span>
                                                                          <span class="s1">self.ui_manager)</span>

        <span class="s1">self.drop_down_menu_ui.image = self.drop_down_menu_ui.drawable_shape.get_fresh_surface()</span>

        <span class="s4"># extra</span>
        <span class="s0">if </span><span class="s1">self.open_button </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">expand_button_symbol = </span><span class="s3">'▼'</span>
            <span class="s0">if </span><span class="s1">self.expand_direction </span><span class="s0">is not None</span><span class="s1">:</span>
                <span class="s0">if </span><span class="s1">self.expand_direction == </span><span class="s3">'up'</span><span class="s1">:</span>
                    <span class="s1">expand_button_symbol = </span><span class="s3">'▲'</span>
                <span class="s0">elif </span><span class="s1">self.expand_direction == </span><span class="s3">'down'</span><span class="s1">:</span>
                    <span class="s1">expand_button_symbol = </span><span class="s3">'▼'</span>
            <span class="s1">self.open_button.set_text(expand_button_symbol)</span>

    <span class="s0">def </span><span class="s1">start(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Called each time we enter the closed state. It creates the necessary elements, the 
        selected option and the open button. 
        &quot;&quot;&quot;</span>
        <span class="s1">self.rebuild()</span>

        <span class="s1">self.should_transition = </span><span class="s0">False</span>
        <span class="s1">self.selected_option_button = UIButton(pygame.Rect((self.base_position_rect.x</span><span class="s0">,</span>
                                                            <span class="s1">self.base_position_rect.y)</span><span class="s0">,</span>
                                                           <span class="s1">(self.base_position_rect.width -</span>
                                                            <span class="s1">self.open_button_width</span><span class="s0">,</span>
                                                            <span class="s1">self.base_position_rect.height))</span><span class="s0">,</span>
                                               <span class="s1">self.selected_option</span><span class="s0">,</span>
                                               <span class="s1">self.ui_manager</span><span class="s0">,</span>
                                               <span class="s1">self.ui_container</span><span class="s0">,</span>
                                               <span class="s1">starting_height=</span><span class="s5">2</span><span class="s0">,</span>
                                               <span class="s1">parent_element=self.drop_down_menu_ui</span><span class="s0">,</span>
                                               <span class="s1">object_id=</span><span class="s3">'#selected_option'</span><span class="s0">,</span>
                                               <span class="s1">visible=self.visible)</span>
        <span class="s1">self.drop_down_menu_ui.join_focus_sets(self.selected_option_button)</span>

        <span class="s1">open_button_x = (self.base_position_rect.x +</span>
                         <span class="s1">self.base_position_rect.width -</span>
                         <span class="s1">self.open_button_width)</span>

        <span class="s1">expand_button_symbol = </span><span class="s3">'▼'</span>
        <span class="s0">if </span><span class="s1">self.expand_direction </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s0">if </span><span class="s1">self.expand_direction == </span><span class="s3">'up'</span><span class="s1">:</span>
                <span class="s1">expand_button_symbol = </span><span class="s3">'▲'</span>
            <span class="s0">elif </span><span class="s1">self.expand_direction == </span><span class="s3">'down'</span><span class="s1">:</span>
                <span class="s1">expand_button_symbol = </span><span class="s3">'▼'</span>

        <span class="s1">self.open_button = UIButton(pygame.Rect((open_button_x</span><span class="s0">,</span>
                                                 <span class="s1">self.base_position_rect.y)</span><span class="s0">,</span>
                                                <span class="s1">(self.open_button_width</span><span class="s0">,</span>
                                                 <span class="s1">self.base_position_rect.height))</span><span class="s0">,</span>
                                    <span class="s1">expand_button_symbol</span><span class="s0">,</span>
                                    <span class="s1">self.ui_manager</span><span class="s0">,</span>
                                    <span class="s1">self.ui_container</span><span class="s0">,</span>
                                    <span class="s1">starting_height=</span><span class="s5">2</span><span class="s0">,</span>
                                    <span class="s1">parent_element=self.drop_down_menu_ui</span><span class="s0">,</span>
                                    <span class="s1">object_id=</span><span class="s3">'#expand_button'</span><span class="s0">,</span>
                                    <span class="s1">visible=self.visible)</span>
        <span class="s1">self.drop_down_menu_ui.join_focus_sets(self.open_button)</span>

    <span class="s0">def </span><span class="s1">finish(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Called when we leave the closed state. Kills the open button and the selected option button. 
        &quot;&quot;&quot;</span>
        <span class="s1">self.selected_option_button.kill()</span>
        <span class="s1">self.open_button.kill()</span>

    <span class="s0">def </span><span class="s1">process_event(self</span><span class="s0">, </span><span class="s1">event: pygame.event.Event) -&gt; bool:</span>
        <span class="s2">&quot;&quot;&quot; 
        Processes events for the closed state of the drop down. 
 
        :param event: The event to process. 
 
        :return: Return True if we want to consume this event so it is not passed on to the 
                 rest of the UI. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">(event.type == pygame.USEREVENT </span><span class="s0">and </span><span class="s1">event.user_type == UI_BUTTON_PRESSED </span><span class="s0">and</span>
                <span class="s1">event.ui_element </span><span class="s0">in </span><span class="s1">[self.open_button</span><span class="s0">, </span><span class="s1">self.selected_option_button]):</span>

            <span class="s1">self.should_transition = </span><span class="s0">True</span>

        <span class="s0">return False</span>

    <span class="s0">def </span><span class="s1">update_position(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Update the position of all the button elements in the closed drop down state. 
 
        Used when the position of the  drop down has been altered directly, rather than when it has 
        been moved as a consequence of it's container being moved. 
        &quot;&quot;&quot;</span>

        <span class="s4"># update the base position rect</span>
        <span class="s1">border_and_shadow = (self.drop_down_menu_ui.shadow_width +</span>
                             <span class="s1">self.drop_down_menu_ui.border_width)</span>
        <span class="s1">self.base_position_rect.x = self.drop_down_menu_ui.relative_rect.x + border_and_shadow</span>
        <span class="s1">self.base_position_rect.y = self.drop_down_menu_ui.relative_rect.y + border_and_shadow</span>

        <span class="s4"># update all the ui elements that depend on the base position</span>
        <span class="s1">self.selected_option_button.set_relative_position(self.base_position_rect.topleft)</span>

        <span class="s1">open_button_x = (self.base_position_rect.x +</span>
                         <span class="s1">self.base_position_rect.width -</span>
                         <span class="s1">self.open_button_width)</span>
        <span class="s1">self.open_button.set_relative_position((open_button_x</span><span class="s0">, </span><span class="s1">self.base_position_rect.y))</span>

    <span class="s0">def </span><span class="s1">update_dimensions(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Update the dimensions of all the button elements in the closed drop down state. 
 
        Used when the dimensions of the drop down have been altered. 
        &quot;&quot;&quot;</span>

        <span class="s4"># update the base position rect</span>
        <span class="s1">border_and_shadow = (self.drop_down_menu_ui.shadow_width +</span>
                             <span class="s1">self.drop_down_menu_ui.border_width)</span>
        <span class="s1">self.base_position_rect.width = (self.drop_down_menu_ui.relative_rect.width -</span>
                                         <span class="s1">(</span><span class="s5">2 </span><span class="s1">* border_and_shadow))</span>
        <span class="s1">self.base_position_rect.height = (self.drop_down_menu_ui.relative_rect.height -</span>
                                          <span class="s1">(</span><span class="s5">2 </span><span class="s1">* border_and_shadow))</span>

        <span class="s4"># update all the ui elements that depend on the base position rect</span>
        <span class="s1">self.selected_option_button.set_dimensions((self.base_position_rect.width -</span>
                                                    <span class="s1">self.open_button_width</span><span class="s0">,</span>
                                                    <span class="s1">self.base_position_rect.height))</span>
        <span class="s1">open_button_x = (self.base_position_rect.x +</span>
                         <span class="s1">self.base_position_rect.width -</span>
                         <span class="s1">self.open_button_width)</span>
        <span class="s1">self.open_button.set_dimensions((self.open_button_width</span><span class="s0">, </span><span class="s1">self.base_position_rect.height))</span>
        <span class="s1">self.open_button.set_relative_position((open_button_x</span><span class="s0">, </span><span class="s1">self.base_position_rect.y))</span>

    <span class="s0">def </span><span class="s1">on_fresh_drawable_shape_ready(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Called by an element's drawable shape when it has a new image surface ready for use, 
        normally after a rebuilding/redrawing of some kind. 
 
        In this case the result is to set the UI element's image to the new surface. 
        &quot;&quot;&quot;</span>
        <span class="s1">self.drop_down_menu_ui.set_image(self.drop_down_menu_ui.drawable_shape.get_fresh_surface())</span>

    <span class="s0">def </span><span class="s1">show(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Show selected_option_button and open_button. 
        &quot;&quot;&quot;</span>
        <span class="s1">self.visible = </span><span class="s5">1</span>

        <span class="s0">if </span><span class="s1">self.open_button </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">self.open_button.show()</span>
        <span class="s0">if </span><span class="s1">self.selected_option_button </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">self.selected_option_button.show()</span>

    <span class="s0">def </span><span class="s1">hide(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Hide selected_option_button and open_button. 
        &quot;&quot;&quot;</span>
        <span class="s1">self.visible = </span><span class="s5">0</span>

        <span class="s0">if </span><span class="s1">self.open_button </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">self.open_button.hide()</span>
        <span class="s0">if </span><span class="s1">self.selected_option_button </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">self.selected_option_button.hide()</span>


<span class="s0">class </span><span class="s1">UIDropDownMenu(UIElement):</span>
    <span class="s2">&quot;&quot;&quot; 
    A drop down menu lets us choose one text option from a list. That list of options can be 
    expanded and hidden at the press of a button. While the element is called a drop down, 
    it can also be made to 'climb up' by changing the 'expand_direction' styling option to 'up' 
    in the theme file. 
 
    The drop down is implemented through two states, one representing the 'closed' menu state 
    and one for when it has been 'expanded'. 
 
    :param options_list: The list of of options to choose from. They must be strings. 
    :param starting_option: The starting option, selected when the menu is first created. 
    :param relative_rect: The size and position of the element when not expanded. 
    :param manager: The UIManager that manages this element. 
    :param container: The container that this element is within. If set to None will be the root 
                      window's container. 
    :param parent_element: The element this element 'belongs to' in the theming hierarchy. 
    :param object_id: A custom defined ID for fine tuning of theming. 
    :param expansion_height_limit: Limit on the height that this will expand to, defaults to the 
                                   container bounds. 
    :param anchors: A dictionary describing what this element's relative_rect is relative to. 
    :param visible: Whether the element is visible by default. Warning - container visibility 
                    may override this. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">,</span>
                 <span class="s1">options_list: List[str]</span><span class="s0">,</span>
                 <span class="s1">starting_option: str</span><span class="s0">,</span>
                 <span class="s1">relative_rect: pygame.Rect</span><span class="s0">,</span>
                 <span class="s1">manager: IUIManagerInterface</span><span class="s0">,</span>
                 <span class="s1">container: Union[IContainerLikeInterface</span><span class="s0">, None</span><span class="s1">] = </span><span class="s0">None,</span>
                 <span class="s1">parent_element: UIElement = </span><span class="s0">None,</span>
                 <span class="s1">object_id: Union[ObjectID</span><span class="s0">, </span><span class="s1">str</span><span class="s0">, None</span><span class="s1">] = </span><span class="s0">None,</span>
                 <span class="s1">expansion_height_limit: Union[int</span><span class="s0">, None</span><span class="s1">] = </span><span class="s0">None,</span>
                 <span class="s1">anchors: Dict[str</span><span class="s0">, </span><span class="s1">str] = </span><span class="s0">None,</span>
                 <span class="s1">visible: int = </span><span class="s5">1</span>
                 <span class="s1">):</span>

        <span class="s1">super().__init__(relative_rect</span><span class="s0">, </span><span class="s1">manager</span><span class="s0">, </span><span class="s1">container</span><span class="s0">,</span>
                         <span class="s1">layer_thickness=</span><span class="s5">3</span><span class="s0">, </span><span class="s1">starting_height=</span><span class="s5">1</span><span class="s0">,</span>
                         <span class="s1">anchors=anchors</span><span class="s0">,</span>
                         <span class="s1">visible=visible)</span>

        <span class="s1">self._create_valid_ids(container=container</span><span class="s0">,</span>
                               <span class="s1">parent_element=parent_element</span><span class="s0">,</span>
                               <span class="s1">object_id=object_id</span><span class="s0">,</span>
                               <span class="s1">element_id=</span><span class="s3">'drop_down_menu'</span><span class="s1">)</span>

        <span class="s1">self.options_list = options_list</span>
        <span class="s1">self.selected_option = starting_option</span>
        <span class="s1">self.open_button_width = </span><span class="s5">20</span>

        <span class="s1">self.expansion_height_limit = expansion_height_limit</span>

        <span class="s1">self.border_width = </span><span class="s0">None</span>
        <span class="s1">self.shadow_width = </span><span class="s0">None</span>

        <span class="s1">self.background_colour = </span><span class="s0">None</span>
        <span class="s1">self.border_colour = </span><span class="s0">None</span>
        <span class="s1">self.disabled_background_colour = </span><span class="s0">None</span>
        <span class="s1">self.disabled_border_colour = </span><span class="s0">None</span>

        <span class="s1">self.shape = </span><span class="s3">&quot;rectangle&quot;</span>
        <span class="s1">self.shape_corner_radius = </span><span class="s5">2</span>

        <span class="s1">self.current_state = </span><span class="s0">None</span>
        <span class="s1">self.background_rect = </span><span class="s0">None</span>
        <span class="s1">self.expand_direction = </span><span class="s0">None</span>

        <span class="s1">self.menu_states = {}</span>

        <span class="s1">self.rebuild_from_changed_theme_data()</span>

        <span class="s1">self.menu_states = {</span><span class="s3">'closed'</span><span class="s1">: UIClosedDropDownState(self</span><span class="s0">,</span>
                                                            <span class="s1">self.selected_option</span><span class="s0">,</span>
                                                            <span class="s1">self.background_rect</span><span class="s0">,</span>
                                                            <span class="s1">self.open_button_width</span><span class="s0">,</span>
                                                            <span class="s1">self.expand_direction</span><span class="s0">,</span>
                                                            <span class="s1">self.ui_manager</span><span class="s0">,</span>
                                                            <span class="s1">self.ui_container</span><span class="s0">,</span>
                                                            <span class="s1">self.element_ids</span><span class="s0">,</span>
                                                            <span class="s1">self.object_ids</span><span class="s0">,</span>
                                                            <span class="s1">self.visible)</span><span class="s0">,</span>
                            <span class="s3">'expanded'</span><span class="s1">: UIExpandedDropDownState(self</span><span class="s0">,</span>
                                                                <span class="s1">self.options_list</span><span class="s0">,</span>
                                                                <span class="s1">self.selected_option</span><span class="s0">,</span>
                                                                <span class="s1">self.background_rect</span><span class="s0">,</span>
                                                                <span class="s1">self.open_button_width</span><span class="s0">,</span>
                                                                <span class="s1">self.expand_direction</span><span class="s0">,</span>
                                                                <span class="s1">self.ui_manager</span><span class="s0">,</span>
                                                                <span class="s1">self.ui_container</span><span class="s0">,</span>
                                                                <span class="s1">self.element_ids</span><span class="s0">,</span>
                                                                <span class="s1">self.object_ids</span>
                                                                <span class="s1">)}</span>
        <span class="s1">self.current_state = self.menu_states[</span><span class="s3">'closed'</span><span class="s1">]</span>
        <span class="s1">self.current_state.start()</span>

    <span class="s0">def </span><span class="s1">kill(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Overrides the standard sprite kill to also properly kill/finish the current state of the 
        drop down. Depending on whether it is expanded or closed the drop down menu will have 
        different elements to clean up. 
        &quot;&quot;&quot;</span>
        <span class="s1">self.current_state.finish()</span>
        <span class="s1">super().kill()</span>

    <span class="s0">def </span><span class="s1">unfocus(self):</span>
        <span class="s1">super().unfocus()</span>
        <span class="s0">if </span><span class="s1">self.current_state </span><span class="s0">is </span><span class="s1">self.menu_states[</span><span class="s3">'expanded'</span><span class="s1">]:</span>
            <span class="s1">self.current_state.should_transition = </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">update(self</span><span class="s0">, </span><span class="s1">time_delta: float):</span>
        <span class="s2">&quot;&quot;&quot; 
        The update here deals with transitioning between the two states of the drop down menu and 
        then passes the rest of the work onto whichever state is active. 
 
        :param time_delta: The time in second between calls to update. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">super().update(time_delta)</span>
        <span class="s0">if </span><span class="s1">self.alive() </span><span class="s0">and </span><span class="s1">self.current_state.should_transition:</span>
            <span class="s1">self.current_state.finish()</span>
            <span class="s1">self.current_state = self.menu_states[self.current_state.target_state]</span>
            <span class="s1">self.current_state.selected_option = self.selected_option</span>
            <span class="s1">self.current_state.start()</span>

    <span class="s0">def </span><span class="s1">process_event(self</span><span class="s0">, </span><span class="s1">event: pygame.event.Event) -&gt; bool:</span>
        <span class="s2">&quot;&quot;&quot; 
        Handles various interactions with the drop down menu by passing them along to the 
        active state. 
 
        :param event: The event to process. 
 
        :return: Return True if we want to consume this event so it is not passed on to the 
                 rest of the UI. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">consumed_event = </span><span class="s0">False</span>
        <span class="s0">if </span><span class="s1">self.is_enabled:</span>
            <span class="s1">consumed_event = self.current_state.process_event(event)</span>

        <span class="s0">return </span><span class="s1">consumed_event</span>

    <span class="s0">def </span><span class="s1">rebuild_from_changed_theme_data(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Triggers the element to rebuild if any of it's theming data has changed, which involves a 
        lot of checking and validating it's theming data. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">super().rebuild_from_changed_theme_data()</span>
        <span class="s1">has_any_changed = </span><span class="s0">False</span>

        <span class="s0">if </span><span class="s1">self._check_misc_theme_data_changed(attribute_name=</span><span class="s3">'expand_direction'</span><span class="s0">,</span>
                                               <span class="s1">default_value=</span><span class="s3">'down'</span><span class="s0">,</span>
                                               <span class="s1">casting_func=str</span><span class="s0">,</span>
                                               <span class="s1">allowed_values=[</span><span class="s3">'up'</span><span class="s0">, </span><span class="s3">'down'</span><span class="s1">]):</span>
            <span class="s1">has_any_changed = </span><span class="s0">True</span>

        <span class="s0">if </span><span class="s1">self._check_misc_theme_data_changed(attribute_name=</span><span class="s3">'shape'</span><span class="s0">,</span>
                                               <span class="s1">default_value=</span><span class="s3">'rectangle'</span><span class="s0">,</span>
                                               <span class="s1">casting_func=str</span><span class="s0">,</span>
                                               <span class="s1">allowed_values=[</span><span class="s3">'rectangle'</span><span class="s0">,</span>
                                                               <span class="s3">'rounded_rectangle'</span><span class="s1">]):</span>
            <span class="s1">has_any_changed = </span><span class="s0">True</span>

        <span class="s0">if </span><span class="s1">self._check_shape_theming_changed(defaults={</span><span class="s3">'border_width'</span><span class="s1">: </span><span class="s5">1</span><span class="s0">,</span>
                                                       <span class="s3">'shadow_width'</span><span class="s1">: </span><span class="s5">2</span><span class="s0">,</span>
                                                       <span class="s3">'shape_corner_radius'</span><span class="s1">: </span><span class="s5">2</span><span class="s1">}):</span>
            <span class="s1">has_any_changed = </span><span class="s0">True</span>

        <span class="s1">background_colour = self.ui_theme.get_colour_or_gradient(</span><span class="s3">'dark_bg'</span><span class="s0">,</span>
                                                                 <span class="s1">self.combined_element_ids)</span>
        <span class="s0">if </span><span class="s1">background_colour != self.background_colour:</span>
            <span class="s1">self.background_colour = background_colour</span>
            <span class="s1">has_any_changed = </span><span class="s0">True</span>

        <span class="s1">border_colour = self.ui_theme.get_colour_or_gradient(</span><span class="s3">'normal_border'</span><span class="s0">,</span>
                                                             <span class="s1">self.combined_element_ids)</span>
        <span class="s0">if </span><span class="s1">border_colour != self.border_colour:</span>
            <span class="s1">self.border_colour = border_colour</span>
            <span class="s1">has_any_changed = </span><span class="s0">True</span>

        <span class="s1">disabled_background_colour = self.ui_theme.get_colour_or_gradient(</span><span class="s3">'disabled_dark_bg'</span><span class="s0">,</span>
                                                                          <span class="s1">self.combined_element_ids)</span>
        <span class="s0">if </span><span class="s1">disabled_background_colour != self.disabled_background_colour:</span>
            <span class="s1">self.disabled_background_colour = disabled_background_colour</span>
            <span class="s1">has_any_changed = </span><span class="s0">True</span>

        <span class="s1">disabled_border_colour = self.ui_theme.get_colour_or_gradient(</span><span class="s3">'disabled_border'</span><span class="s0">,</span>
                                                                      <span class="s1">self.combined_element_ids)</span>
        <span class="s0">if </span><span class="s1">disabled_border_colour != self.disabled_border_colour:</span>
            <span class="s1">self.disabled_border_colour = disabled_border_colour</span>
            <span class="s1">has_any_changed = </span><span class="s0">True</span>

        <span class="s0">if </span><span class="s1">has_any_changed:</span>
            <span class="s1">border_and_shadow = self.border_width + self.shadow_width</span>
            <span class="s1">self.background_rect = pygame.Rect(self.relative_rect.x + border_and_shadow</span><span class="s0">,</span>
                                               <span class="s1">self.relative_rect.y + border_and_shadow</span><span class="s0">,</span>
                                               <span class="s1">self.relative_rect.width - (</span><span class="s5">2 </span><span class="s1">* border_and_shadow)</span><span class="s0">,</span>
                                               <span class="s1">self.relative_rect.height - (</span><span class="s5">2 </span><span class="s1">* border_and_shadow))</span>

            <span class="s0">for </span><span class="s1">state </span><span class="s0">in </span><span class="s1">self.menu_states:</span>
                <span class="s1">self.menu_states[state].expand_direction = self.expand_direction</span>

            <span class="s1">self.rebuild()</span>

    <span class="s0">def </span><span class="s1">rebuild(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        A complete rebuild of the drawable parts of this element. 
 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self.current_state </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">self.current_state.rebuild()</span>

    <span class="s0">def </span><span class="s1">set_position(self</span><span class="s0">, </span><span class="s1">position: Union[pygame.math.Vector2</span><span class="s0">,</span>
                                           <span class="s1">Tuple[int</span><span class="s0">, </span><span class="s1">int]</span><span class="s0">,</span>
                                           <span class="s1">Tuple[float</span><span class="s0">, </span><span class="s1">float]]):</span>
        <span class="s2">&quot;&quot;&quot; 
        Sets the absolute screen position of this drop down, updating all subordinate button 
        elements at the same time. 
 
        :param position: The absolute screen position to set. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">super().set_position(position)</span>
        <span class="s1">self.current_state.update_position()</span>

    <span class="s0">def </span><span class="s1">set_relative_position(self</span><span class="s0">, </span><span class="s1">position: Union[pygame.math.Vector2</span><span class="s0">,</span>
                                                    <span class="s1">Tuple[int</span><span class="s0">, </span><span class="s1">int]</span><span class="s0">,</span>
                                                    <span class="s1">Tuple[float</span><span class="s0">, </span><span class="s1">float]]):</span>
        <span class="s2">&quot;&quot;&quot; 
        Sets the relative screen position of this drop down, updating all subordinate button 
        elements at the same time. 
 
        :param position: The relative screen position to set. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">super().set_relative_position(position)</span>
        <span class="s1">self.current_state.update_position()</span>

    <span class="s0">def </span><span class="s1">set_dimensions(self</span><span class="s0">, </span><span class="s1">dimensions: Union[pygame.math.Vector2</span><span class="s0">,</span>
                                               <span class="s1">Tuple[int</span><span class="s0">, </span><span class="s1">int]</span><span class="s0">,</span>
                                               <span class="s1">Tuple[float</span><span class="s0">, </span><span class="s1">float]]):</span>
        <span class="s2">&quot;&quot;&quot; 
        Sets the dimensions of this drop down, updating all subordinate button 
        elements at the same time. 
 
        :param dimensions: The new dimensions to set. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">super().set_dimensions(dimensions)</span>
        <span class="s1">self.current_state.update_dimensions()</span>

    <span class="s0">def </span><span class="s1">on_fresh_drawable_shape_ready(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Called by an element's drawable shape when it has a new image surface ready for use, 
        normally after a rebuilding/redrawing of some kind. 
        &quot;&quot;&quot;</span>
        <span class="s1">self.current_state.on_fresh_drawable_shape_ready()</span>

    <span class="s0">def </span><span class="s1">hover_point(self</span><span class="s0">, </span><span class="s1">hover_x: float</span><span class="s0">, </span><span class="s1">hover_y: float) -&gt; bool:</span>
        <span class="s2">&quot;&quot;&quot; 
        Test if a given point counts as 'hovering' this UI element. Normally that is a 
        straightforward matter of seeing if a point is inside the rectangle. Occasionally it 
        will also check if we are in a wider zone around a UI element once it is already active, 
        this makes it easier to move scroll bars and the like. 
 
        :param hover_x: The x (horizontal) position of the point. 
        :param hover_y: The y (vertical) position of the point. 
 
        :return: Returns True if we are hovering this element. 
 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">(bool(self.rect.collidepoint(hover_x</span><span class="s0">, </span><span class="s1">hover_y)) </span><span class="s0">and</span>
                <span class="s1">bool(self.ui_container.rect.collidepoint(hover_x</span><span class="s0">, </span><span class="s1">hover_y)))</span>

    <span class="s0">def </span><span class="s1">disable(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Disables the button so that it is no longer interactive. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self.is_enabled:</span>
            <span class="s1">self.is_enabled = </span><span class="s0">False</span>
            <span class="s4"># switch back to the closed state if we are in the expanded state</span>
            <span class="s0">if </span><span class="s1">self.current_state </span><span class="s0">is </span><span class="s1">self.menu_states[</span><span class="s3">'expanded'</span><span class="s1">]:</span>
                <span class="s1">self.current_state.finish()</span>
                <span class="s1">self.current_state = self.menu_states[</span><span class="s3">'closed'</span><span class="s1">]</span>
                <span class="s1">self.current_state.selected_option = self.selected_option</span>
                <span class="s1">self.current_state.start()</span>
            <span class="s1">self.current_state.disable()</span>

    <span class="s0">def </span><span class="s1">enable(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        Re-enables the button so we can once again interact with it. 
        &quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">self.is_enabled:</span>
            <span class="s1">self.is_enabled = </span><span class="s0">True</span>
            <span class="s1">self.current_state.enable()</span>

    <span class="s0">def </span><span class="s1">show(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        In addition to the base UIElement.show() - call show() on the closed state - 
        showing it's buttons. 
        &quot;&quot;&quot;</span>
        <span class="s1">super().show()</span>

        <span class="s1">self.menu_states[</span><span class="s3">'closed'</span><span class="s1">].show()</span>

    <span class="s0">def </span><span class="s1">hide(self):</span>
        <span class="s2">&quot;&quot;&quot; 
        In addition to the base UIElement.hide() - if the current state is 'expanded' call it's 
        hide() method, which begins a transition of the UIDropDownMenu to the 'closed' state, and 
        call the hide() method of the 'closed' state which hides all it's children widgets. 
        &quot;&quot;&quot;</span>
        <span class="s1">super().hide()</span>

        <span class="s0">if </span><span class="s1">self.current_state == self.menu_states[</span><span class="s3">'expanded'</span><span class="s1">]:</span>
            <span class="s1">self.menu_states[</span><span class="s3">'expanded'</span><span class="s1">].hide()</span>
        <span class="s1">self.menu_states[</span><span class="s3">'closed'</span><span class="s1">].hide()</span>
</pre>
</body>
</html>