<html>
<head>
<title>surfarray_test.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #a9b7c6;}
.s1 { color: #cc7832;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
surfarray_test.py</font>
</center></td></tr></table>
<pre>
<span class="s1">import </span><span class="s0">unittest</span>
<span class="s1">import </span><span class="s0">platform</span>

<span class="s1">from </span><span class="s0">numpy </span><span class="s1">import </span><span class="s0">\</span>
    <span class="s0">uint8</span><span class="s1">, </span><span class="s0">uint16</span><span class="s1">, </span><span class="s0">uint32</span><span class="s1">, </span><span class="s0">uint64</span><span class="s1">, </span><span class="s0">zeros</span><span class="s1">, </span><span class="s0">\</span>
    <span class="s0">float32</span><span class="s1">, </span><span class="s0">float64</span><span class="s1">, </span><span class="s0">alltrue</span><span class="s1">, </span><span class="s0">rint</span><span class="s1">, </span><span class="s0">arange</span>

<span class="s1">import </span><span class="s0">pygame</span>
<span class="s1">from </span><span class="s0">pygame.locals </span><span class="s1">import </span><span class="s0">*</span>

<span class="s1">import </span><span class="s0">pygame.surfarray</span>
<span class="s0">arraytype = </span><span class="s2">'numpy'</span>


<span class="s0">IS_PYPY = </span><span class="s2">'PyPy' </span><span class="s0">== platform.python_implementation()</span>


<span class="s0">@unittest.skipIf(IS_PYPY</span><span class="s1">, </span><span class="s2">'pypy skip known failure'</span><span class="s0">) </span><span class="s3"># TODO</span>
<span class="s1">class </span><span class="s0">SurfarrayModuleTest (unittest.TestCase):</span>
    <span class="s0">pixels2d = {</span><span class="s4">8</span><span class="s0">: </span><span class="s1">True, </span><span class="s4">16</span><span class="s0">: </span><span class="s1">True, </span><span class="s4">24</span><span class="s0">: </span><span class="s1">False, </span><span class="s4">32</span><span class="s0">: </span><span class="s1">True</span><span class="s0">}</span>
    <span class="s0">pixels3d = {</span><span class="s4">8</span><span class="s0">: </span><span class="s1">False, </span><span class="s4">16</span><span class="s0">: </span><span class="s1">False, </span><span class="s4">24</span><span class="s0">: </span><span class="s1">True, </span><span class="s4">32</span><span class="s0">: </span><span class="s1">True</span><span class="s0">}</span>
    <span class="s0">array2d = {</span><span class="s4">8</span><span class="s0">: </span><span class="s1">True, </span><span class="s4">16</span><span class="s0">: </span><span class="s1">True, </span><span class="s4">24</span><span class="s0">: </span><span class="s1">True, </span><span class="s4">32</span><span class="s0">: </span><span class="s1">True</span><span class="s0">}</span>
    <span class="s0">array3d = {</span><span class="s4">8</span><span class="s0">: </span><span class="s1">False, </span><span class="s4">16</span><span class="s0">: </span><span class="s1">False, </span><span class="s4">24</span><span class="s0">: </span><span class="s1">True, </span><span class="s4">32</span><span class="s0">: </span><span class="s1">True</span><span class="s0">}</span>

    <span class="s0">test_palette = [(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">255</span><span class="s0">)</span><span class="s1">,</span>
                    <span class="s0">(</span><span class="s4">10</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">60</span><span class="s1">, </span><span class="s4">255</span><span class="s0">)</span><span class="s1">,</span>
                    <span class="s0">(</span><span class="s4">25</span><span class="s1">, </span><span class="s4">75</span><span class="s1">, </span><span class="s4">100</span><span class="s1">, </span><span class="s4">255</span><span class="s0">)</span><span class="s1">,</span>
                    <span class="s0">(</span><span class="s4">100</span><span class="s1">, </span><span class="s4">150</span><span class="s1">, </span><span class="s4">200</span><span class="s1">, </span><span class="s4">255</span><span class="s0">)</span><span class="s1">,</span>
                    <span class="s0">(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">100</span><span class="s1">, </span><span class="s4">200</span><span class="s1">, </span><span class="s4">255</span><span class="s0">)]</span>
    <span class="s0">surf_size = (</span><span class="s4">10</span><span class="s1">, </span><span class="s4">12</span><span class="s0">)</span>
    <span class="s0">test_points = [((</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s0">)</span><span class="s1">, </span><span class="s4">1</span><span class="s0">)</span><span class="s1">, </span><span class="s0">((</span><span class="s4">4</span><span class="s1">, </span><span class="s4">5</span><span class="s0">)</span><span class="s1">, </span><span class="s4">1</span><span class="s0">)</span><span class="s1">, </span><span class="s0">((</span><span class="s4">9</span><span class="s1">, </span><span class="s4">0</span><span class="s0">)</span><span class="s1">, </span><span class="s4">2</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">((</span><span class="s4">5</span><span class="s1">, </span><span class="s4">5</span><span class="s0">)</span><span class="s1">, </span><span class="s4">2</span><span class="s0">)</span><span class="s1">, </span><span class="s0">((</span><span class="s4">0</span><span class="s1">, </span><span class="s4">11</span><span class="s0">)</span><span class="s1">, </span><span class="s4">3</span><span class="s0">)</span><span class="s1">, </span><span class="s0">((</span><span class="s4">4</span><span class="s1">, </span><span class="s4">6</span><span class="s0">)</span><span class="s1">, </span><span class="s4">3</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">((</span><span class="s4">9</span><span class="s1">, </span><span class="s4">11</span><span class="s0">)</span><span class="s1">, </span><span class="s4">4</span><span class="s0">)</span><span class="s1">, </span><span class="s0">((</span><span class="s4">5</span><span class="s1">, </span><span class="s4">6</span><span class="s0">)</span><span class="s1">, </span><span class="s4">4</span><span class="s0">)]</span>

    <span class="s0">@classmethod</span>
    <span class="s1">def </span><span class="s0">setUpClass(cls):</span>
        <span class="s3"># Needed for 8 bits-per-pixel color palette surface tests.</span>
        <span class="s0">pygame.init()</span>

    <span class="s0">@classmethod</span>
    <span class="s1">def </span><span class="s0">tearDownClass(cls):</span>
        <span class="s0">pygame.quit()</span>

    <span class="s1">def </span><span class="s0">setUp(cls):</span>
        <span class="s3"># This makes sure pygame is always initialized before each test (in</span>
        <span class="s3"># case a test calls pygame.quit()).</span>
        <span class="s1">if not </span><span class="s0">pygame.get_init():</span>
            <span class="s0">pygame.init()</span>

        <span class="s3"># Makes sure the same array package is used each time.</span>
        <span class="s0">pygame.surfarray.use_arraytype(arraytype)</span>

    <span class="s1">def </span><span class="s0">_make_surface(self</span><span class="s1">, </span><span class="s0">bitsize</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">False, </span><span class="s0">palette=</span><span class="s1">None</span><span class="s0">):</span>
        <span class="s1">if </span><span class="s0">palette </span><span class="s1">is None</span><span class="s0">:</span>
            <span class="s0">palette = self.test_palette</span>
        <span class="s0">flags = </span><span class="s4">0</span>
        <span class="s1">if </span><span class="s0">srcalpha:</span>
            <span class="s0">flags |= SRCALPHA</span>
        <span class="s0">surf = pygame.Surface(self.surf_size</span><span class="s1">, </span><span class="s0">flags</span><span class="s1">, </span><span class="s0">bitsize)</span>
        <span class="s1">if </span><span class="s0">bitsize == </span><span class="s4">8</span><span class="s0">:</span>
            <span class="s0">surf.set_palette([c[:</span><span class="s4">3</span><span class="s0">] </span><span class="s1">for </span><span class="s0">c </span><span class="s1">in </span><span class="s0">palette])</span>
        <span class="s1">return </span><span class="s0">surf</span>

    <span class="s1">def </span><span class="s0">_fill_surface(self</span><span class="s1">, </span><span class="s0">surf</span><span class="s1">, </span><span class="s0">palette=</span><span class="s1">None</span><span class="s0">):</span>
        <span class="s1">if </span><span class="s0">palette </span><span class="s1">is None</span><span class="s0">:</span>
            <span class="s0">palette = self.test_palette</span>
        <span class="s0">surf.fill(palette[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s0">(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">5</span><span class="s1">, </span><span class="s4">6</span><span class="s0">))</span>
        <span class="s0">surf.fill(palette[</span><span class="s4">2</span><span class="s0">]</span><span class="s1">, </span><span class="s0">(</span><span class="s4">5</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">5</span><span class="s1">, </span><span class="s4">6</span><span class="s0">))</span>
        <span class="s0">surf.fill(palette[</span><span class="s4">3</span><span class="s0">]</span><span class="s1">, </span><span class="s0">(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">6</span><span class="s1">, </span><span class="s4">5</span><span class="s1">, </span><span class="s4">6</span><span class="s0">))</span>
        <span class="s0">surf.fill(palette[</span><span class="s4">4</span><span class="s0">]</span><span class="s1">, </span><span class="s0">(</span><span class="s4">5</span><span class="s1">, </span><span class="s4">6</span><span class="s1">, </span><span class="s4">5</span><span class="s1">, </span><span class="s4">6</span><span class="s0">))</span>

    <span class="s1">def </span><span class="s0">_make_src_surface(self</span><span class="s1">, </span><span class="s0">bitsize</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">False, </span><span class="s0">palette=</span><span class="s1">None</span><span class="s0">):</span>
        <span class="s0">surf = self._make_surface(bitsize</span><span class="s1">, </span><span class="s0">srcalpha</span><span class="s1">, </span><span class="s0">palette)</span>
        <span class="s0">self._fill_surface(surf</span><span class="s1">, </span><span class="s0">palette)</span>
        <span class="s1">return </span><span class="s0">surf</span>

    <span class="s1">def </span><span class="s0">_assert_surface(self</span><span class="s1">, </span><span class="s0">surf</span><span class="s1">, </span><span class="s0">palette=</span><span class="s1">None, </span><span class="s0">msg=</span><span class="s2">&quot;&quot;</span><span class="s0">):</span>
        <span class="s1">if </span><span class="s0">palette </span><span class="s1">is None</span><span class="s0">:</span>
            <span class="s0">palette = self.test_palette</span>
        <span class="s1">if </span><span class="s0">surf.get_bitsize() == </span><span class="s4">16</span><span class="s0">:</span>
            <span class="s0">palette = [surf.unmap_rgb(surf.map_rgb(c)) </span><span class="s1">for </span><span class="s0">c </span><span class="s1">in </span><span class="s0">palette]</span>
        <span class="s1">for </span><span class="s0">posn</span><span class="s1">, </span><span class="s0">i </span><span class="s1">in </span><span class="s0">self.test_points:</span>
            <span class="s0">self.assertEqual(surf.get_at(posn)</span><span class="s1">, </span><span class="s0">palette[i]</span><span class="s1">,</span>
                                 <span class="s2">&quot;%s != %s: flags: %i, bpp: %i, posn: %s%s&quot; </span><span class="s0">%</span>
                                 <span class="s0">(surf.get_at(posn)</span><span class="s1">,</span>
                                  <span class="s0">palette[i]</span><span class="s1">, </span><span class="s0">surf.get_flags()</span><span class="s1">,</span>
                                  <span class="s0">surf.get_bitsize()</span><span class="s1">, </span><span class="s0">posn</span><span class="s1">, </span><span class="s0">msg))</span>

    <span class="s1">def </span><span class="s0">_make_array3d(self</span><span class="s1">, </span><span class="s0">dtype):</span>
        <span class="s1">return </span><span class="s0">zeros((self.surf_size[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">, </span><span class="s0">self.surf_size[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s4">3</span><span class="s0">)</span><span class="s1">, </span><span class="s0">dtype)</span>

    <span class="s1">def </span><span class="s0">_fill_array2d(self</span><span class="s1">, </span><span class="s0">arr</span><span class="s1">, </span><span class="s0">surf):</span>
        <span class="s0">palette = self.test_palette</span>
        <span class="s0">arr[:</span><span class="s4">5</span><span class="s1">,</span><span class="s0">:</span><span class="s4">6</span><span class="s0">] = surf.map_rgb(palette[</span><span class="s4">1</span><span class="s0">])</span>
        <span class="s0">arr[</span><span class="s4">5</span><span class="s0">:</span><span class="s1">,</span><span class="s0">:</span><span class="s4">6</span><span class="s0">] = surf.map_rgb(palette[</span><span class="s4">2</span><span class="s0">])</span>
        <span class="s0">arr[:</span><span class="s4">5</span><span class="s1">,</span><span class="s4">6</span><span class="s0">:] = surf.map_rgb(palette[</span><span class="s4">3</span><span class="s0">])</span>
        <span class="s0">arr[</span><span class="s4">5</span><span class="s0">:</span><span class="s1">,</span><span class="s4">6</span><span class="s0">:] = surf.map_rgb(palette[</span><span class="s4">4</span><span class="s0">])</span>

    <span class="s1">def </span><span class="s0">_fill_array3d(self</span><span class="s1">, </span><span class="s0">arr):</span>
        <span class="s0">palette = self.test_palette</span>
        <span class="s0">arr[:</span><span class="s4">5</span><span class="s1">,</span><span class="s0">:</span><span class="s4">6</span><span class="s0">] = palette[</span><span class="s4">1</span><span class="s0">][:</span><span class="s4">3</span><span class="s0">]</span>
        <span class="s0">arr[</span><span class="s4">5</span><span class="s0">:</span><span class="s1">,</span><span class="s0">:</span><span class="s4">6</span><span class="s0">] = palette[</span><span class="s4">2</span><span class="s0">][:</span><span class="s4">3</span><span class="s0">]</span>
        <span class="s0">arr[:</span><span class="s4">5</span><span class="s1">,</span><span class="s4">6</span><span class="s0">:] = palette[</span><span class="s4">3</span><span class="s0">][:</span><span class="s4">3</span><span class="s0">]</span>
        <span class="s0">arr[</span><span class="s4">5</span><span class="s0">:</span><span class="s1">,</span><span class="s4">6</span><span class="s0">:] = palette[</span><span class="s4">4</span><span class="s0">][:</span><span class="s4">3</span><span class="s0">]</span>

    <span class="s1">def </span><span class="s0">_make_src_array3d(self</span><span class="s1">, </span><span class="s0">dtype):</span>
        <span class="s0">arr = self._make_array3d(dtype)</span>
        <span class="s0">self._fill_array3d(arr)</span>
        <span class="s1">return </span><span class="s0">arr</span>

    <span class="s1">def </span><span class="s0">_make_array2d(self</span><span class="s1">, </span><span class="s0">dtype):</span>
        <span class="s1">return </span><span class="s0">zeros(self.surf_size</span><span class="s1">, </span><span class="s0">dtype)</span>

    <span class="s1">def </span><span class="s0">test_array2d(self):</span>

        <span class="s0">sources = [self._make_src_surface(</span><span class="s4">8</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">16</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">16</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">24</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">32</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)]</span>
        <span class="s0">palette = self.test_palette</span>
        <span class="s0">alpha_color = (</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">128</span><span class="s0">)</span>

        <span class="s1">for </span><span class="s0">surf </span><span class="s1">in </span><span class="s0">sources:</span>
            <span class="s0">arr = pygame.surfarray.array2d(surf)</span>
            <span class="s1">for </span><span class="s0">posn</span><span class="s1">, </span><span class="s0">i </span><span class="s1">in </span><span class="s0">self.test_points:</span>
                <span class="s0">self.assertEqual(arr[posn]</span><span class="s1">, </span><span class="s0">surf.get_at_mapped(posn)</span><span class="s1">,</span>
                                     <span class="s2">&quot;%s != %s: flags: %i, bpp: %i, posn: %s&quot; </span><span class="s0">%</span>
                                     <span class="s0">(arr[posn]</span><span class="s1">,</span>
                                      <span class="s0">surf.get_at_mapped(posn)</span><span class="s1">,</span>
                                      <span class="s0">surf.get_flags()</span><span class="s1">, </span><span class="s0">surf.get_bitsize()</span><span class="s1">,</span>
                                      <span class="s0">posn))</span>

            <span class="s1">if </span><span class="s0">surf.get_masks()[</span><span class="s4">3</span><span class="s0">]:</span>
                <span class="s0">surf.fill(alpha_color)</span>
                <span class="s0">arr = pygame.surfarray.array2d(surf)</span>
                <span class="s0">posn = (</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s0">)</span>
                <span class="s0">self.assertEqual(arr[posn]</span><span class="s1">, </span><span class="s0">surf.get_at_mapped(posn)</span><span class="s1">,</span>
                                     <span class="s2">&quot;%s != %s: bpp: %i&quot; </span><span class="s0">%</span>
                                     <span class="s0">(arr[posn]</span><span class="s1">,</span>
                                      <span class="s0">surf.get_at_mapped(posn)</span><span class="s1">,</span>
                                      <span class="s0">surf.get_bitsize()))</span>

    <span class="s1">def </span><span class="s0">test_array3d(self):</span>

        <span class="s0">sources = [self._make_src_surface(</span><span class="s4">16</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">16</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">24</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">32</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)]</span>
        <span class="s0">palette = self.test_palette</span>

        <span class="s1">for </span><span class="s0">surf </span><span class="s1">in </span><span class="s0">sources:</span>
            <span class="s0">arr = pygame.surfarray.array3d(surf)</span>
            <span class="s1">def </span><span class="s0">same_color(ac</span><span class="s1">, </span><span class="s0">sc):</span>
                <span class="s1">return </span><span class="s0">(ac[</span><span class="s4">0</span><span class="s0">] == sc[</span><span class="s4">0</span><span class="s0">] </span><span class="s1">and</span>
                        <span class="s0">ac[</span><span class="s4">1</span><span class="s0">] == sc[</span><span class="s4">1</span><span class="s0">] </span><span class="s1">and</span>
                        <span class="s0">ac[</span><span class="s4">2</span><span class="s0">] == sc[</span><span class="s4">2</span><span class="s0">])</span>
            <span class="s1">for </span><span class="s0">posn</span><span class="s1">, </span><span class="s0">i </span><span class="s1">in </span><span class="s0">self.test_points:</span>
                <span class="s0">self.assertTrue(same_color(arr[posn]</span><span class="s1">, </span><span class="s0">surf.get_at(posn))</span><span class="s1">,</span>
                                <span class="s2">&quot;%s != %s: flags: %i, bpp: %i, posn: %s&quot; </span><span class="s0">% (</span>
                                    <span class="s0">tuple(arr[posn])</span><span class="s1">, </span><span class="s0">surf.get_at(posn)</span><span class="s1">,</span>
                                    <span class="s0">surf.get_flags()</span><span class="s1">, </span><span class="s0">surf.get_bitsize()</span><span class="s1">,</span>
                                    <span class="s0">posn))</span>

    <span class="s1">def </span><span class="s0">test_array_alpha(self):</span>

        <span class="s0">palette = [(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">10</span><span class="s1">, </span><span class="s4">50</span><span class="s1">, </span><span class="s4">100</span><span class="s1">, </span><span class="s4">255</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">60</span><span class="s1">, </span><span class="s4">120</span><span class="s1">, </span><span class="s4">240</span><span class="s1">, </span><span class="s4">130</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">64</span><span class="s1">, </span><span class="s4">128</span><span class="s1">, </span><span class="s4">255</span><span class="s1">, </span><span class="s4">0</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">255</span><span class="s1">, </span><span class="s4">128</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">65</span><span class="s0">)]</span>
        <span class="s0">targets = [self._make_src_surface(</span><span class="s4">8</span><span class="s1">, </span><span class="s0">palette=palette)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">16</span><span class="s1">, </span><span class="s0">palette=palette)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">16</span><span class="s1">, </span><span class="s0">palette=palette</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">24</span><span class="s1">, </span><span class="s0">palette=palette)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">palette=palette)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">palette=palette</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)]</span>

        <span class="s1">for </span><span class="s0">surf </span><span class="s1">in </span><span class="s0">targets:</span>
            <span class="s0">p = palette</span>
            <span class="s1">if </span><span class="s0">surf.get_bitsize() == </span><span class="s4">16</span><span class="s0">:</span>
                <span class="s0">p = [surf.unmap_rgb(surf.map_rgb(c)) </span><span class="s1">for </span><span class="s0">c </span><span class="s1">in </span><span class="s0">p]</span>
            <span class="s0">arr = pygame.surfarray.array_alpha(surf)</span>
            <span class="s1">if </span><span class="s0">surf.get_masks()[</span><span class="s4">3</span><span class="s0">]:</span>
                <span class="s1">for </span><span class="s0">(x</span><span class="s1">, </span><span class="s0">y)</span><span class="s1">, </span><span class="s0">i </span><span class="s1">in </span><span class="s0">self.test_points:</span>
                    <span class="s0">self.assertEqual(arr[x</span><span class="s1">, </span><span class="s0">y]</span><span class="s1">, </span><span class="s0">p[i][</span><span class="s4">3</span><span class="s0">]</span><span class="s1">,</span>
                                         <span class="s0">(</span><span class="s2">&quot;%i != %i, posn: (%i, %i), &quot;</span>
                                          <span class="s2">&quot;bitsize: %i&quot; </span><span class="s0">%</span>
                                          <span class="s0">(arr[x</span><span class="s1">, </span><span class="s0">y]</span><span class="s1">, </span><span class="s0">p[i][</span><span class="s4">3</span><span class="s0">]</span><span class="s1">,</span>
                                           <span class="s0">x</span><span class="s1">, </span><span class="s0">y</span><span class="s1">,</span>
                                           <span class="s0">surf.get_bitsize())))</span>
            <span class="s1">else</span><span class="s0">:</span>
                <span class="s0">self.assertTrue(alltrue(arr == </span><span class="s4">255</span><span class="s0">))</span>

        <span class="s3"># No per-pixel alpha when blanket alpha is None.</span>
        <span class="s1">for </span><span class="s0">surf </span><span class="s1">in </span><span class="s0">targets:</span>
            <span class="s0">blanket_alpha = surf.get_alpha()</span>
            <span class="s0">surf.set_alpha(</span><span class="s1">None</span><span class="s0">)</span>
            <span class="s0">arr = pygame.surfarray.array_alpha(surf)</span>
            <span class="s0">self.assertTrue(alltrue(arr == </span><span class="s4">255</span><span class="s0">)</span><span class="s1">,</span>
                            <span class="s2">&quot;All alpha values should be 255 when&quot;</span>
                            <span class="s2">&quot; surf.set_alpha(None) has been set.&quot;</span>
                            <span class="s2">&quot; bitsize: %i, flags: %i&quot; </span><span class="s0">% (</span>
                                <span class="s0">surf.get_bitsize()</span><span class="s1">, </span><span class="s0">surf.get_flags()))</span>
            <span class="s0">surf.set_alpha(blanket_alpha)</span>

        <span class="s3"># Bug for per-pixel alpha surface when blanket alpha 0.</span>
        <span class="s1">for </span><span class="s0">surf </span><span class="s1">in </span><span class="s0">targets:</span>
            <span class="s0">blanket_alpha = surf.get_alpha()</span>
            <span class="s0">surf.set_alpha(</span><span class="s4">0</span><span class="s0">)</span>
            <span class="s0">arr = pygame.surfarray.array_alpha(surf)</span>
            <span class="s1">if </span><span class="s0">surf.get_masks()[</span><span class="s4">3</span><span class="s0">]:</span>
                <span class="s0">self.assertFalse(alltrue(arr == </span><span class="s4">255</span><span class="s0">)</span><span class="s1">,</span>
                            <span class="s2">&quot;bitsize: %i, flags: %i&quot; </span><span class="s0">%</span>
                            <span class="s0">(surf.get_bitsize()</span><span class="s1">, </span><span class="s0">surf.get_flags()))</span>
            <span class="s1">else</span><span class="s0">:</span>
                <span class="s0">self.assertTrue(alltrue(arr == </span><span class="s4">255</span><span class="s0">)</span><span class="s1">,</span>
                                <span class="s2">&quot;bitsize: %i, flags: %i&quot; </span><span class="s0">% (</span>
                                    <span class="s0">surf.get_bitsize()</span><span class="s1">, </span><span class="s0">surf.get_flags()))</span>
            <span class="s0">surf.set_alpha(blanket_alpha)</span>

    <span class="s1">def </span><span class="s0">test_array_colorkey(self):</span>

        <span class="s0">palette = [(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">10</span><span class="s1">, </span><span class="s4">50</span><span class="s1">, </span><span class="s4">100</span><span class="s1">, </span><span class="s4">255</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">60</span><span class="s1">, </span><span class="s4">120</span><span class="s1">, </span><span class="s4">240</span><span class="s1">, </span><span class="s4">130</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">64</span><span class="s1">, </span><span class="s4">128</span><span class="s1">, </span><span class="s4">255</span><span class="s1">, </span><span class="s4">0</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">255</span><span class="s1">, </span><span class="s4">128</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">65</span><span class="s0">)]</span>
        <span class="s0">targets = [self._make_src_surface(</span><span class="s4">8</span><span class="s1">, </span><span class="s0">palette=palette)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">16</span><span class="s1">, </span><span class="s0">palette=palette)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">16</span><span class="s1">, </span><span class="s0">palette=palette</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">24</span><span class="s1">, </span><span class="s0">palette=palette)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">palette=palette)</span><span class="s1">,</span>
                   <span class="s0">self._make_src_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">palette=palette</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)]</span>

        <span class="s1">for </span><span class="s0">surf </span><span class="s1">in </span><span class="s0">targets:</span>
            <span class="s0">p = palette</span>
            <span class="s1">if </span><span class="s0">surf.get_bitsize() == </span><span class="s4">16</span><span class="s0">:</span>
                <span class="s0">p = [surf.unmap_rgb(surf.map_rgb(c)) </span><span class="s1">for </span><span class="s0">c </span><span class="s1">in </span><span class="s0">p]</span>
            <span class="s0">surf.set_colorkey(</span><span class="s1">None</span><span class="s0">)</span>
            <span class="s0">arr = pygame.surfarray.array_colorkey(surf)</span>
            <span class="s0">self.assertTrue(alltrue(arr == </span><span class="s4">255</span><span class="s0">))</span>

            <span class="s1">for </span><span class="s0">i </span><span class="s1">in </span><span class="s0">range(</span><span class="s4">1</span><span class="s1">, </span><span class="s0">len(palette)):</span>
                <span class="s0">surf.set_colorkey(p[i])</span>
                <span class="s0">alphas = [</span><span class="s4">255</span><span class="s0">] * len(p)</span>
                <span class="s0">alphas[i] = </span><span class="s4">0</span>
                <span class="s0">arr = pygame.surfarray.array_colorkey(surf)</span>
                <span class="s1">for </span><span class="s0">(x</span><span class="s1">, </span><span class="s0">y)</span><span class="s1">, </span><span class="s0">j </span><span class="s1">in </span><span class="s0">self.test_points:</span>
                    <span class="s0">self.assertEqual(arr[x</span><span class="s1">, </span><span class="s0">y]</span><span class="s1">, </span><span class="s0">alphas[j]</span><span class="s1">,</span>
                                         <span class="s0">(</span><span class="s2">&quot;%i != %i, posn: (%i, %i), &quot;</span>
                                          <span class="s2">&quot;bitsize: %i&quot; </span><span class="s0">%</span>
                                          <span class="s0">(arr[x</span><span class="s1">, </span><span class="s0">y]</span><span class="s1">, </span><span class="s0">alphas[j]</span><span class="s1">,</span>
                                           <span class="s0">x</span><span class="s1">, </span><span class="s0">y</span><span class="s1">,</span>
                                           <span class="s0">surf.get_bitsize())))</span>

    <span class="s1">def </span><span class="s0">test_blit_array(self):</span>

        <span class="s3"># bug 24 at http://pygame.motherhamster.org/bugzilla/</span>
        <span class="s1">if </span><span class="s2">'numpy' </span><span class="s1">in </span><span class="s0">pygame.surfarray.get_arraytypes():</span>
            <span class="s0">prev = pygame.surfarray.get_arraytype()</span>
            <span class="s3"># This would raise exception:</span>
            <span class="s3">#  File &quot;[...]\pygame\_numpysurfarray.py&quot;, line 381, in blit_array</span>
            <span class="s3">#    (array[:,:,1::3] &gt;&gt; losses[1] &lt;&lt; shifts[1]) | \</span>
            <span class="s3"># TypeError: unsupported operand type(s) for &gt;&gt;: 'float' and 'int'</span>
            <span class="s0">pygame.surfarray.use_arraytype(</span><span class="s2">'numpy'</span><span class="s0">)</span>
            <span class="s0">s = pygame.Surface((</span><span class="s4">10</span><span class="s1">,</span><span class="s4">10</span><span class="s0">)</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">24</span><span class="s0">)</span>
            <span class="s0">a = pygame.surfarray.array3d(s)</span>
            <span class="s0">pygame.surfarray.blit_array(s</span><span class="s1">, </span><span class="s0">a)</span>
            <span class="s0">prev = pygame.surfarray.use_arraytype(prev)</span>

        <span class="s3"># target surfaces</span>
        <span class="s0">targets = [self._make_surface(</span><span class="s4">8</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_surface(</span><span class="s4">16</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_surface(</span><span class="s4">16</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_surface(</span><span class="s4">24</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_surface(</span><span class="s4">32</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">]</span>

        <span class="s3"># source arrays</span>
        <span class="s0">arrays3d = []</span>
        <span class="s0">dtypes = [(</span><span class="s4">8</span><span class="s1">, </span><span class="s0">uint8)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">16</span><span class="s1">, </span><span class="s0">uint16)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">uint32)]</span>
        <span class="s1">try</span><span class="s0">:</span>
            <span class="s0">dtypes.append((</span><span class="s4">64</span><span class="s1">, </span><span class="s0">uint64))</span>
        <span class="s1">except </span><span class="s0">NameError:</span>
            <span class="s1">pass</span>
        <span class="s0">arrays3d = [(self._make_src_array3d(dtype)</span><span class="s1">, None</span><span class="s0">)</span>
                    <span class="s1">for </span><span class="s0">__</span><span class="s1">, </span><span class="s0">dtype </span><span class="s1">in </span><span class="s0">dtypes]</span>
        <span class="s1">for </span><span class="s0">bitsize </span><span class="s1">in </span><span class="s0">[</span><span class="s4">8</span><span class="s1">, </span><span class="s4">16</span><span class="s1">, </span><span class="s4">24</span><span class="s1">, </span><span class="s4">32</span><span class="s0">]:</span>
            <span class="s0">palette = </span><span class="s1">None</span>
            <span class="s1">if </span><span class="s0">bitsize == </span><span class="s4">16</span><span class="s0">:</span>
                <span class="s0">s = pygame.Surface((</span><span class="s4">1</span><span class="s1">,</span><span class="s4">1</span><span class="s0">)</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">16</span><span class="s0">)</span>
                <span class="s0">palette = [s.unmap_rgb(s.map_rgb(c))</span>
                           <span class="s1">for </span><span class="s0">c </span><span class="s1">in </span><span class="s0">self.test_palette]</span>
            <span class="s1">if </span><span class="s0">self.pixels3d[bitsize]:</span>
                <span class="s0">surf = self._make_src_surface(bitsize)</span>
                <span class="s0">arr = pygame.surfarray.pixels3d(surf)</span>
                <span class="s0">arrays3d.append((arr</span><span class="s1">, </span><span class="s0">palette))</span>
            <span class="s1">if </span><span class="s0">self.array3d[bitsize]:</span>
                <span class="s0">surf = self._make_src_surface(bitsize)</span>
                <span class="s0">arr = pygame.surfarray.array3d(surf)</span>
                <span class="s0">arrays3d.append((arr</span><span class="s1">, </span><span class="s0">palette))</span>
                <span class="s1">for </span><span class="s0">sz</span><span class="s1">, </span><span class="s0">dtype </span><span class="s1">in </span><span class="s0">dtypes:</span>
                    <span class="s0">arrays3d.append((arr.astype(dtype)</span><span class="s1">, </span><span class="s0">palette))</span>

        <span class="s3"># tests on arrays</span>
        <span class="s1">def </span><span class="s0">do_blit(surf</span><span class="s1">, </span><span class="s0">arr):</span>
            <span class="s0">pygame.surfarray.blit_array(surf</span><span class="s1">, </span><span class="s0">arr)</span>

        <span class="s1">for </span><span class="s0">surf </span><span class="s1">in </span><span class="s0">targets:</span>
            <span class="s0">bitsize = surf.get_bitsize()</span>
            <span class="s1">for </span><span class="s0">arr</span><span class="s1">, </span><span class="s0">palette </span><span class="s1">in </span><span class="s0">arrays3d:</span>
                <span class="s0">surf.fill((</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s0">))</span>
                <span class="s1">if </span><span class="s0">bitsize == </span><span class="s4">8</span><span class="s0">:</span>
                    <span class="s0">self.assertRaises(ValueError</span><span class="s1">, </span><span class="s0">do_blit</span><span class="s1">, </span><span class="s0">surf</span><span class="s1">, </span><span class="s0">arr)</span>
                <span class="s1">else</span><span class="s0">:</span>
                    <span class="s0">pygame.surfarray.blit_array(surf</span><span class="s1">, </span><span class="s0">arr)</span>
                    <span class="s0">self._assert_surface(surf</span><span class="s1">, </span><span class="s0">palette)</span>

            <span class="s1">if </span><span class="s0">self.pixels2d[bitsize]:</span>
                <span class="s0">surf.fill((</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s0">))</span>
                <span class="s0">s = self._make_src_surface(bitsize</span><span class="s1">, </span><span class="s0">surf.get_flags() &amp; SRCALPHA)</span>
                <span class="s0">arr = pygame.surfarray.pixels2d(s)</span>
                <span class="s0">pygame.surfarray.blit_array(surf</span><span class="s1">, </span><span class="s0">arr)</span>
                <span class="s0">self._assert_surface(surf)</span>

            <span class="s1">if </span><span class="s0">self.array2d[bitsize]:</span>
                <span class="s0">s = self._make_src_surface(bitsize</span><span class="s1">, </span><span class="s0">surf.get_flags() &amp; SRCALPHA)</span>
                <span class="s0">arr = pygame.surfarray.array2d(s)</span>
                <span class="s1">for </span><span class="s0">sz</span><span class="s1">, </span><span class="s0">dtype </span><span class="s1">in </span><span class="s0">dtypes:</span>
                    <span class="s0">surf.fill((</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s0">))</span>
                    <span class="s1">if </span><span class="s0">sz &gt;= bitsize:</span>
                        <span class="s0">pygame.surfarray.blit_array(surf</span><span class="s1">, </span><span class="s0">arr.astype(dtype))</span>
                        <span class="s0">self._assert_surface(surf)</span>
                    <span class="s1">else</span><span class="s0">:</span>
                        <span class="s0">self.assertRaises(ValueError</span><span class="s1">, </span><span class="s0">do_blit</span><span class="s1">,</span>
                                          <span class="s0">surf</span><span class="s1">, </span><span class="s0">self._make_array2d(dtype))</span>

        <span class="s3"># Check alpha for 2D arrays</span>
        <span class="s0">surf = self._make_surface(</span><span class="s4">16</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)</span>
        <span class="s0">arr = zeros(surf.get_size()</span><span class="s1">, </span><span class="s0">uint16)</span>
        <span class="s0">arr[...] = surf.map_rgb((</span><span class="s4">0</span><span class="s1">, </span><span class="s4">128</span><span class="s1">, </span><span class="s4">255</span><span class="s1">, </span><span class="s4">64</span><span class="s0">))</span>
        <span class="s0">color = surf.unmap_rgb(arr[</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s0">])</span>
        <span class="s0">pygame.surfarray.blit_array(surf</span><span class="s1">, </span><span class="s0">arr)</span>
        <span class="s0">self.assertEqual(surf.get_at((</span><span class="s4">5</span><span class="s1">, </span><span class="s4">5</span><span class="s0">))</span><span class="s1">, </span><span class="s0">color)</span>

        <span class="s0">surf = self._make_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)</span>
        <span class="s0">arr = zeros(surf.get_size()</span><span class="s1">, </span><span class="s0">uint32)</span>
        <span class="s0">color = (</span><span class="s4">0</span><span class="s1">, </span><span class="s4">111</span><span class="s1">, </span><span class="s4">255</span><span class="s1">, </span><span class="s4">63</span><span class="s0">)</span>
        <span class="s0">arr[...] = surf.map_rgb(color)</span>
        <span class="s0">pygame.surfarray.blit_array(surf</span><span class="s1">, </span><span class="s0">arr)</span>
        <span class="s0">self.assertEqual(surf.get_at((</span><span class="s4">5</span><span class="s1">, </span><span class="s4">5</span><span class="s0">))</span><span class="s1">, </span><span class="s0">color)</span>

        <span class="s3"># Check shifts</span>
        <span class="s0">arr3d = self._make_src_array3d(uint8)</span>

        <span class="s0">shift_tests = [(</span><span class="s4">16</span><span class="s1">,</span>
                        <span class="s0">[</span><span class="s4">12</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">8</span><span class="s1">, </span><span class="s4">4</span><span class="s0">]</span><span class="s1">,</span>
                        <span class="s0">[</span><span class="s4">0xf000</span><span class="s1">, </span><span class="s4">0xf</span><span class="s1">, </span><span class="s4">0xf00</span><span class="s1">, </span><span class="s4">0xf0</span><span class="s0">])</span><span class="s1">,</span>
                       <span class="s0">(</span><span class="s4">24</span><span class="s1">,</span>
                        <span class="s0">[</span><span class="s4">16</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">8</span><span class="s1">, </span><span class="s4">0</span><span class="s0">]</span><span class="s1">,</span>
                        <span class="s0">[</span><span class="s4">0xff0000</span><span class="s1">, </span><span class="s4">0xff</span><span class="s1">, </span><span class="s4">0xff00</span><span class="s1">, </span><span class="s4">0</span><span class="s0">])</span><span class="s1">,</span>
                       <span class="s0">(</span><span class="s4">32</span><span class="s1">,</span>
                        <span class="s0">[</span><span class="s4">0</span><span class="s1">, </span><span class="s4">16</span><span class="s1">, </span><span class="s4">24</span><span class="s1">, </span><span class="s4">8</span><span class="s0">]</span><span class="s1">,</span>
                        <span class="s0">[</span><span class="s4">0xff</span><span class="s1">, </span><span class="s4">0xff0000</span><span class="s1">, </span><span class="s4">0xff000000</span><span class="s1">, </span><span class="s4">0xff00</span><span class="s0">])]</span>

        <span class="s1">for </span><span class="s0">bitsize</span><span class="s1">, </span><span class="s0">shifts</span><span class="s1">, </span><span class="s0">masks </span><span class="s1">in </span><span class="s0">shift_tests:</span>
            <span class="s0">surf = self._make_surface(bitsize</span><span class="s1">, </span><span class="s0">srcalpha=(shifts[</span><span class="s4">3</span><span class="s0">] != </span><span class="s4">0</span><span class="s0">))</span>
            <span class="s0">palette = </span><span class="s1">None</span>
            <span class="s1">if </span><span class="s0">bitsize == </span><span class="s4">16</span><span class="s0">:</span>
                <span class="s0">palette = [surf.unmap_rgb(surf.map_rgb(c))</span>
                           <span class="s1">for </span><span class="s0">c </span><span class="s1">in </span><span class="s0">self.test_palette]</span>
            <span class="s0">surf.set_shifts(shifts)</span>
            <span class="s0">surf.set_masks(masks)</span>
            <span class="s0">pygame.surfarray.blit_array(surf</span><span class="s1">, </span><span class="s0">arr3d)</span>
            <span class="s0">self._assert_surface(surf</span><span class="s1">, </span><span class="s0">palette)</span>

        <span class="s3"># Invalid arrays</span>
        <span class="s0">surf = pygame.Surface((</span><span class="s4">1</span><span class="s1">,</span><span class="s4">1</span><span class="s0">)</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">32</span><span class="s0">)</span>
        <span class="s0">t = </span><span class="s2">'abcd'</span>
        <span class="s0">self.assertRaises(ValueError</span><span class="s1">, </span><span class="s0">do_blit</span><span class="s1">, </span><span class="s0">surf</span><span class="s1">, </span><span class="s0">t)</span>

        <span class="s0">surf_size = self.surf_size</span>
        <span class="s0">surf = pygame.Surface(surf_size</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">32</span><span class="s0">)</span>
        <span class="s0">arr = zeros([surf_size[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">, </span><span class="s0">surf_size[</span><span class="s4">1</span><span class="s0">] + </span><span class="s4">1</span><span class="s1">, </span><span class="s4">3</span><span class="s0">]</span><span class="s1">, </span><span class="s0">uint32)</span>
        <span class="s0">self.assertRaises(ValueError</span><span class="s1">, </span><span class="s0">do_blit</span><span class="s1">, </span><span class="s0">surf</span><span class="s1">, </span><span class="s0">arr)</span>
        <span class="s0">arr = zeros([surf_size[</span><span class="s4">0</span><span class="s0">] + </span><span class="s4">1</span><span class="s1">, </span><span class="s0">surf_size[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s4">3</span><span class="s0">]</span><span class="s1">, </span><span class="s0">uint32)</span>
        <span class="s0">self.assertRaises(ValueError</span><span class="s1">, </span><span class="s0">do_blit</span><span class="s1">, </span><span class="s0">surf</span><span class="s1">, </span><span class="s0">arr)</span>

        <span class="s0">surf = pygame.Surface((</span><span class="s4">1</span><span class="s1">, </span><span class="s4">4</span><span class="s0">)</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">32</span><span class="s0">)</span>
        <span class="s0">arr = zeros((</span><span class="s4">4</span><span class="s1">,</span><span class="s0">)</span><span class="s1">, </span><span class="s0">uint32)</span>
        <span class="s0">self.assertRaises(ValueError</span><span class="s1">, </span><span class="s0">do_blit</span><span class="s1">, </span><span class="s0">surf</span><span class="s1">, </span><span class="s0">arr)</span>
        <span class="s0">arr.shape = (</span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s4">4</span><span class="s0">)</span>
        <span class="s0">self.assertRaises(ValueError</span><span class="s1">, </span><span class="s0">do_blit</span><span class="s1">, </span><span class="s0">surf</span><span class="s1">, </span><span class="s0">arr)</span>

        <span class="s3"># Issue #81: round from float to int</span>
        <span class="s1">try</span><span class="s0">:</span>
            <span class="s0">rint</span>
        <span class="s1">except </span><span class="s0">NameError:</span>
            <span class="s1">pass</span>
        <span class="s1">else</span><span class="s0">:</span>
            <span class="s0">surf = pygame.Surface((</span><span class="s4">10</span><span class="s1">, </span><span class="s4">10</span><span class="s0">)</span><span class="s1">, </span><span class="s0">pygame.SRCALPHA</span><span class="s1">, </span><span class="s4">32</span><span class="s0">)</span>
            <span class="s0">w</span><span class="s1">, </span><span class="s0">h = surf.get_size()</span>
            <span class="s0">length = w * h</span>
            <span class="s1">for </span><span class="s0">dtype </span><span class="s1">in </span><span class="s0">[float32</span><span class="s1">, </span><span class="s0">float64]:</span>
                <span class="s0">surf.fill((</span><span class="s4">255</span><span class="s1">, </span><span class="s4">255</span><span class="s1">, </span><span class="s4">255</span><span class="s1">, </span><span class="s4">0</span><span class="s0">))</span>
                <span class="s0">farr = arange(</span><span class="s4">0</span><span class="s1">, </span><span class="s0">length</span><span class="s1">, </span><span class="s0">dtype=dtype)</span>
                <span class="s0">farr.shape = w</span><span class="s1">, </span><span class="s0">h</span>
                <span class="s0">pygame.surfarray.blit_array(surf</span><span class="s1">, </span><span class="s0">farr)</span>
                <span class="s1">for </span><span class="s0">x </span><span class="s1">in </span><span class="s0">range(w):</span>
                    <span class="s1">for </span><span class="s0">y </span><span class="s1">in </span><span class="s0">range(h):</span>
                        <span class="s0">self.assertEqual(surf.get_at_mapped((x</span><span class="s1">, </span><span class="s0">y))</span><span class="s1">,</span>
                                         <span class="s0">int(rint(farr[x</span><span class="s1">, </span><span class="s0">y])))</span>

    <span class="s1">def </span><span class="s0">test_get_arraytype(self):</span>
        <span class="s0">array_type = pygame.surfarray.get_arraytype()</span>

        <span class="s0">self.assertEqual(array_type</span><span class="s1">, </span><span class="s2">'numpy'</span><span class="s1">,</span>
                         <span class="s2">&quot;unknown array type %s&quot; </span><span class="s0">% array_type)</span>

    <span class="s1">def </span><span class="s0">test_get_arraytypes(self):</span>

        <span class="s0">arraytypes = pygame.surfarray.get_arraytypes()</span>
        <span class="s0">self.assertIn(</span><span class="s2">'numpy'</span><span class="s1">, </span><span class="s0">arraytypes)</span>

        <span class="s1">for </span><span class="s0">atype </span><span class="s1">in </span><span class="s0">arraytypes:</span>
            <span class="s0">self.assertEqual(atype</span><span class="s1">, </span><span class="s2">'numpy'</span><span class="s1">, </span><span class="s2">&quot;unknown array type %s&quot; </span><span class="s0">% atype)</span>

    <span class="s1">def </span><span class="s0">test_make_surface(self):</span>

        <span class="s3"># How does one properly test this with 2d arrays. It makes no sense</span>
        <span class="s3"># since the pixel format is not entirely dependent on element size.</span>
        <span class="s3"># Just make sure the surface pixel size is at least as large as the</span>
        <span class="s3"># array element size I guess.</span>
        <span class="s3">#</span>
        <span class="s1">for </span><span class="s0">bitsize</span><span class="s1">, </span><span class="s0">dtype </span><span class="s1">in </span><span class="s0">[(</span><span class="s4">8</span><span class="s1">, </span><span class="s0">uint8)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">16</span><span class="s1">, </span><span class="s0">uint16)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">24</span><span class="s1">, </span><span class="s0">uint32)]:</span>
<span class="s3">## Even this simple assertion fails for 2d arrays. Where's the problem?</span>
<span class="s3">##            surf = pygame.surfarray.make_surface(self._make_array2d(dtype))</span>
<span class="s3">##            self.assertGreaterEqual(surf.get_bitsize(), bitsize,</span>
<span class="s3">##                            &quot;not %i &gt;= %i)&quot; % (surf.get_bitsize(), bitsize))</span>
<span class="s3">##</span>
            <span class="s0">surf = pygame.surfarray.make_surface(self._make_src_array3d(dtype))</span>
            <span class="s0">self._assert_surface(surf)</span>

        <span class="s3"># Issue #81: round from float to int</span>
        <span class="s1">try</span><span class="s0">:</span>
            <span class="s0">rint</span>
        <span class="s1">except </span><span class="s0">NameError:</span>
            <span class="s1">pass</span>
        <span class="s1">else</span><span class="s0">:</span>
            <span class="s0">w = </span><span class="s4">9</span>
            <span class="s0">h = </span><span class="s4">11</span>
            <span class="s0">length = w * h</span>
            <span class="s1">for </span><span class="s0">dtype </span><span class="s1">in </span><span class="s0">[float32</span><span class="s1">, </span><span class="s0">float64]:</span>
                <span class="s0">farr = arange(</span><span class="s4">0</span><span class="s1">, </span><span class="s0">length</span><span class="s1">, </span><span class="s0">dtype=dtype)</span>
                <span class="s0">farr.shape = w</span><span class="s1">, </span><span class="s0">h</span>
                <span class="s0">surf = pygame.surfarray.make_surface(farr)</span>
                <span class="s1">for </span><span class="s0">x </span><span class="s1">in </span><span class="s0">range(w):</span>
                    <span class="s1">for </span><span class="s0">y </span><span class="s1">in </span><span class="s0">range(h):</span>
                        <span class="s0">self.assertEqual(surf.get_at_mapped((x</span><span class="s1">, </span><span class="s0">y))</span><span class="s1">,</span>
                                         <span class="s0">int(rint(farr[x</span><span class="s1">, </span><span class="s0">y])))</span>

    <span class="s1">def </span><span class="s0">test_map_array(self):</span>

        <span class="s0">arr3d = self._make_src_array3d(uint8)</span>
        <span class="s0">targets = [self._make_surface(</span><span class="s4">8</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_surface(</span><span class="s4">16</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_surface(</span><span class="s4">16</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_surface(</span><span class="s4">24</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_surface(</span><span class="s4">32</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)]</span>
        <span class="s0">palette = self.test_palette</span>

        <span class="s1">for </span><span class="s0">surf </span><span class="s1">in </span><span class="s0">targets:</span>
            <span class="s0">arr2d = pygame.surfarray.map_array(surf</span><span class="s1">, </span><span class="s0">arr3d)</span>
            <span class="s1">for </span><span class="s0">posn</span><span class="s1">, </span><span class="s0">i </span><span class="s1">in </span><span class="s0">self.test_points:</span>
                <span class="s0">self.assertEqual(arr2d[posn]</span><span class="s1">, </span><span class="s0">surf.map_rgb(palette[i])</span><span class="s1">,</span>
                                     <span class="s2">&quot;%i != %i, bitsize: %i, flags: %i&quot; </span><span class="s0">%</span>
                                     <span class="s0">(arr2d[posn]</span><span class="s1">, </span><span class="s0">surf.map_rgb(palette[i])</span><span class="s1">,</span>
                                      <span class="s0">surf.get_bitsize()</span><span class="s1">, </span><span class="s0">surf.get_flags()))</span>

        <span class="s3"># Exception checks</span>
        <span class="s0">self.assertRaises(ValueError</span><span class="s1">, </span><span class="s0">pygame.surfarray.map_array</span><span class="s1">,</span>
                          <span class="s0">self._make_surface(</span><span class="s4">32</span><span class="s0">)</span><span class="s1">,</span>
                          <span class="s0">self._make_array2d(uint8))</span>

    <span class="s1">def </span><span class="s0">test_pixels2d(self):</span>

        <span class="s0">sources = [self._make_surface(</span><span class="s4">8</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_surface(</span><span class="s4">16</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)]</span>

        <span class="s1">for </span><span class="s0">surf </span><span class="s1">in </span><span class="s0">sources:</span>
            <span class="s0">self.assertFalse(surf.get_locked())</span>
            <span class="s0">arr = pygame.surfarray.pixels2d(surf)</span>
            <span class="s0">self.assertTrue(surf.get_locked())</span>
            <span class="s0">self._fill_array2d(arr</span><span class="s1">, </span><span class="s0">surf)</span>
            <span class="s0">surf.unlock()</span>
            <span class="s0">self.assertTrue(surf.get_locked())</span>
            <span class="s1">del </span><span class="s0">arr</span>
            <span class="s0">self.assertFalse(surf.get_locked())</span>
            <span class="s0">self.assertEqual(surf.get_locks()</span><span class="s1">, </span><span class="s0">())</span>
            <span class="s0">self._assert_surface(surf)</span>

        <span class="s3"># Error checks</span>
        <span class="s0">self.assertRaises(ValueError</span><span class="s1">,</span>
                          <span class="s0">pygame.surfarray.pixels2d</span><span class="s1">,</span>
                          <span class="s0">self._make_surface(</span><span class="s4">24</span><span class="s0">))</span>

    <span class="s1">def </span><span class="s0">test_pixels3d(self):</span>

        <span class="s0">sources = [self._make_surface(</span><span class="s4">24</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">self._make_surface(</span><span class="s4">32</span><span class="s0">)]</span>

        <span class="s1">for </span><span class="s0">surf </span><span class="s1">in </span><span class="s0">sources:</span>
            <span class="s0">self.assertFalse(surf.get_locked())</span>
            <span class="s0">arr = pygame.surfarray.pixels3d(surf)</span>
            <span class="s0">self.assertTrue(surf.get_locked())</span>
            <span class="s0">self._fill_array3d(arr)</span>
            <span class="s0">surf.unlock()</span>
            <span class="s0">self.assertTrue(surf.get_locked())</span>
            <span class="s1">del </span><span class="s0">arr</span>
            <span class="s0">self.assertFalse(surf.get_locked())</span>
            <span class="s0">self.assertEqual(surf.get_locks()</span><span class="s1">, </span><span class="s0">())</span>
            <span class="s0">self._assert_surface(surf)</span>

        <span class="s3"># Alpha check</span>
        <span class="s0">color = (</span><span class="s4">1</span><span class="s1">, </span><span class="s4">2</span><span class="s1">, </span><span class="s4">3</span><span class="s1">, </span><span class="s4">0</span><span class="s0">)</span>
        <span class="s0">surf = self._make_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True</span><span class="s0">)</span>
        <span class="s0">arr = pygame.surfarray.pixels3d(surf)</span>
        <span class="s0">arr[</span><span class="s4">0</span><span class="s1">,</span><span class="s4">0</span><span class="s0">] = color[:</span><span class="s4">3</span><span class="s0">]</span>
        <span class="s0">self.assertEqual(surf.get_at((</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s0">))</span><span class="s1">, </span><span class="s0">color)</span>

        <span class="s3"># Error checks</span>
        <span class="s1">def </span><span class="s0">do_pixels3d(surf):</span>
            <span class="s0">pygame.surfarray.pixels3d(surf)</span>

        <span class="s0">self.assertRaises(ValueError</span><span class="s1">,</span>
                          <span class="s0">do_pixels3d</span><span class="s1">,</span>
                          <span class="s0">self._make_surface(</span><span class="s4">8</span><span class="s0">))</span>
        <span class="s0">self.assertRaises(ValueError</span><span class="s1">,</span>
                          <span class="s0">do_pixels3d</span><span class="s1">,</span>
                          <span class="s0">self._make_surface(</span><span class="s4">16</span><span class="s0">))</span>

    <span class="s1">def </span><span class="s0">test_pixels_alpha(self):</span>

        <span class="s0">palette = [(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">127</span><span class="s1">, </span><span class="s4">127</span><span class="s1">, </span><span class="s4">127</span><span class="s1">, </span><span class="s4">0</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">127</span><span class="s1">, </span><span class="s4">127</span><span class="s1">, </span><span class="s4">127</span><span class="s1">, </span><span class="s4">85</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">127</span><span class="s1">, </span><span class="s4">127</span><span class="s1">, </span><span class="s4">127</span><span class="s1">, </span><span class="s4">170</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">127</span><span class="s1">, </span><span class="s4">127</span><span class="s1">, </span><span class="s4">127</span><span class="s1">, </span><span class="s4">255</span><span class="s0">)]</span>
        <span class="s0">alphas = [</span><span class="s4">0</span><span class="s1">, </span><span class="s4">45</span><span class="s1">, </span><span class="s4">86</span><span class="s1">, </span><span class="s4">99</span><span class="s1">, </span><span class="s4">180</span><span class="s0">]</span>

        <span class="s0">surf = self._make_src_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True, </span><span class="s0">palette=palette)</span>

        <span class="s0">self.assertFalse(surf.get_locked())</span>
        <span class="s0">arr = pygame.surfarray.pixels_alpha(surf)</span>
        <span class="s0">self.assertTrue(surf.get_locked())</span>
        <span class="s0">surf.unlock()</span>
        <span class="s0">self.assertTrue(surf.get_locked())</span>

        <span class="s1">for </span><span class="s0">(x</span><span class="s1">, </span><span class="s0">y)</span><span class="s1">, </span><span class="s0">i </span><span class="s1">in </span><span class="s0">self.test_points:</span>
            <span class="s0">self.assertEqual(arr[x</span><span class="s1">, </span><span class="s0">y]</span><span class="s1">, </span><span class="s0">palette[i][</span><span class="s4">3</span><span class="s0">])</span>

        <span class="s1">for </span><span class="s0">(x</span><span class="s1">, </span><span class="s0">y)</span><span class="s1">, </span><span class="s0">i </span><span class="s1">in </span><span class="s0">self.test_points:</span>
            <span class="s0">alpha = alphas[i]</span>
            <span class="s0">arr[x</span><span class="s1">, </span><span class="s0">y] = alpha</span>
            <span class="s0">color = (</span><span class="s4">127</span><span class="s1">, </span><span class="s4">127</span><span class="s1">, </span><span class="s4">127</span><span class="s1">, </span><span class="s0">alpha)</span>
            <span class="s0">self.assertEqual(surf.get_at((x</span><span class="s1">, </span><span class="s0">y))</span><span class="s1">, </span><span class="s0">color</span><span class="s1">,</span>
                                 <span class="s2">&quot;posn: (%i, %i)&quot; </span><span class="s0">% (x</span><span class="s1">, </span><span class="s0">y))</span>

        <span class="s1">del </span><span class="s0">arr</span>
        <span class="s0">self.assertFalse(surf.get_locked())</span>
        <span class="s0">self.assertEqual(surf.get_locks()</span><span class="s1">, </span><span class="s0">())</span>

        <span class="s3"># Check exceptions.</span>
        <span class="s1">def </span><span class="s0">do_pixels_alpha(surf):</span>
            <span class="s0">pygame.surfarray.pixels_alpha(surf)</span>

        <span class="s0">targets = [(</span><span class="s4">8</span><span class="s1">, False</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">16</span><span class="s1">, False</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">16</span><span class="s1">, True</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">24</span><span class="s1">, False</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">32</span><span class="s1">, False</span><span class="s0">)]</span>

        <span class="s1">for </span><span class="s0">bitsize</span><span class="s1">, </span><span class="s0">srcalpha </span><span class="s1">in </span><span class="s0">targets:</span>
            <span class="s0">self.assertRaises(ValueError</span><span class="s1">, </span><span class="s0">do_pixels_alpha</span><span class="s1">,</span>
                              <span class="s0">self._make_surface(bitsize</span><span class="s1">, </span><span class="s0">srcalpha))</span>

    <span class="s1">def </span><span class="s0">test_pixels_red(self):</span>
        <span class="s0">self._test_pixels_rgb(</span><span class="s2">'red'</span><span class="s1">, </span><span class="s4">0</span><span class="s0">)</span>

    <span class="s1">def </span><span class="s0">test_pixels_green(self):</span>
        <span class="s0">self._test_pixels_rgb(</span><span class="s2">'green'</span><span class="s1">, </span><span class="s4">1</span><span class="s0">)</span>

    <span class="s1">def </span><span class="s0">test_pixels_blue(self):</span>
        <span class="s0">self._test_pixels_rgb(</span><span class="s2">'blue'</span><span class="s1">, </span><span class="s4">2</span><span class="s0">)</span>

    <span class="s1">def </span><span class="s0">_test_pixels_rgb(self</span><span class="s1">, </span><span class="s0">operation</span><span class="s1">, </span><span class="s0">mask_posn):</span>
        <span class="s0">method_name = </span><span class="s2">&quot;pixels_&quot; </span><span class="s0">+ operation</span>

        <span class="s0">pixels_rgb = getattr(pygame.surfarray</span><span class="s1">, </span><span class="s0">method_name)</span>
        <span class="s0">palette = [(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">255</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">5</span><span class="s1">, </span><span class="s4">13</span><span class="s1">, </span><span class="s4">23</span><span class="s1">, </span><span class="s4">255</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">29</span><span class="s1">, </span><span class="s4">31</span><span class="s1">, </span><span class="s4">37</span><span class="s1">, </span><span class="s4">255</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">131</span><span class="s1">, </span><span class="s4">157</span><span class="s1">, </span><span class="s4">167</span><span class="s1">, </span><span class="s4">255</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">179</span><span class="s1">, </span><span class="s4">191</span><span class="s1">, </span><span class="s4">251</span><span class="s1">, </span><span class="s4">255</span><span class="s0">)]</span>
        <span class="s0">plane = [c[mask_posn] </span><span class="s1">for </span><span class="s0">c </span><span class="s1">in </span><span class="s0">palette]</span>

        <span class="s0">surf24 = self._make_src_surface(</span><span class="s4">24</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">False, </span><span class="s0">palette=palette)</span>
        <span class="s0">surf32 = self._make_src_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">False, </span><span class="s0">palette=palette)</span>
        <span class="s0">surf32a = self._make_src_surface(</span><span class="s4">32</span><span class="s1">, </span><span class="s0">srcalpha=</span><span class="s1">True, </span><span class="s0">palette=palette)</span>

        <span class="s1">for </span><span class="s0">surf </span><span class="s1">in </span><span class="s0">[surf24</span><span class="s1">, </span><span class="s0">surf32</span><span class="s1">, </span><span class="s0">surf32a]:</span>
            <span class="s0">self.assertFalse(surf.get_locked())</span>
            <span class="s0">arr = pixels_rgb(surf)</span>
            <span class="s0">self.assertTrue(surf.get_locked())</span>
            <span class="s0">surf.unlock()</span>
            <span class="s0">self.assertTrue(surf.get_locked())</span>

            <span class="s1">for </span><span class="s0">(x</span><span class="s1">, </span><span class="s0">y)</span><span class="s1">, </span><span class="s0">i </span><span class="s1">in </span><span class="s0">self.test_points:</span>
                <span class="s0">self.assertEqual(arr[x</span><span class="s1">, </span><span class="s0">y]</span><span class="s1">, </span><span class="s0">plane[i])</span>

            <span class="s1">del </span><span class="s0">arr</span>
            <span class="s0">self.assertFalse(surf.get_locked())</span>
            <span class="s0">self.assertEqual(surf.get_locks()</span><span class="s1">, </span><span class="s0">())</span>

        <span class="s3"># Check exceptions.</span>
        <span class="s0">targets = [(</span><span class="s4">8</span><span class="s1">, False</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">16</span><span class="s1">, False</span><span class="s0">)</span><span class="s1">,</span>
                   <span class="s0">(</span><span class="s4">16</span><span class="s1">, True</span><span class="s0">)]</span>

        <span class="s1">for </span><span class="s0">bitsize</span><span class="s1">, </span><span class="s0">srcalpha </span><span class="s1">in </span><span class="s0">targets:</span>
            <span class="s0">self.assertRaises(ValueError</span><span class="s1">, </span><span class="s0">pixels_rgb</span><span class="s1">,</span>
                              <span class="s0">self._make_surface(bitsize</span><span class="s1">, </span><span class="s0">srcalpha))</span>

    <span class="s1">def </span><span class="s0">test_use_arraytype(self):</span>

        <span class="s1">def </span><span class="s0">do_use_arraytype(atype):</span>
            <span class="s0">pygame.surfarray.use_arraytype(atype)</span>

        <span class="s0">pygame.surfarray.use_arraytype(</span><span class="s2">'numpy'</span><span class="s0">)</span>
        <span class="s0">self.assertEqual(pygame.surfarray.get_arraytype()</span><span class="s1">, </span><span class="s2">'numpy'</span><span class="s0">)</span>
        <span class="s0">self.assertRaises(ValueError</span><span class="s1">, </span><span class="s0">do_use_arraytype</span><span class="s1">, </span><span class="s2">'not an option'</span><span class="s0">)</span>

    <span class="s1">def </span><span class="s0">test_surf_lock (self):</span>
        <span class="s0">sf = pygame.Surface ((</span><span class="s4">5</span><span class="s1">, </span><span class="s4">5</span><span class="s0">)</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">32</span><span class="s0">)</span>
        <span class="s1">for </span><span class="s0">atype </span><span class="s1">in </span><span class="s0">pygame.surfarray.get_arraytypes ():</span>
            <span class="s0">pygame.surfarray.use_arraytype (atype)</span>

            <span class="s0">ar = pygame.surfarray.pixels2d (sf)</span>
            <span class="s0">self.assertTrue(sf.get_locked())</span>

            <span class="s0">sf.unlock ()</span>
            <span class="s0">self.assertTrue(sf.get_locked())</span>

            <span class="s1">del </span><span class="s0">ar</span>
            <span class="s0">self.assertFalse(sf.get_locked())</span>
            <span class="s0">self.assertEqual(sf.get_locks()</span><span class="s1">, </span><span class="s0">())</span>


<span class="s1">if </span><span class="s0">__name__ == </span><span class="s2">'__main__'</span><span class="s0">:</span>
    <span class="s0">unittest.main()</span>
</pre>
</body>
</html>