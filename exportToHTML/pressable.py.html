<html>
<head>
<title>pressable.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
pressable.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">copy </span><span class="s0">import </span><span class="s1">copy</span>

<span class="s0">from </span><span class="s1">pygame.event </span><span class="s0">import </span><span class="s1">Event</span><span class="s0">, </span><span class="s1">post</span>
<span class="s0">from </span><span class="s1">pygame </span><span class="s0">import </span><span class="s1">KEYUP</span><span class="s0">, </span><span class="s1">KEYDOWN</span>

<span class="s0">from </span><span class="s1">thorpy.elements.element </span><span class="s0">import </span><span class="s1">Element</span>
<span class="s0">from </span><span class="s1">thorpy.miscgui.state </span><span class="s0">import </span><span class="s1">State</span>
<span class="s0">from </span><span class="s1">thorpy.miscgui.reaction </span><span class="s0">import </span><span class="s1">Reaction</span><span class="s0">, </span><span class="s1">ConstantReaction</span>
<span class="s0">from </span><span class="s1">thorpy.miscgui.initializer </span><span class="s0">import </span><span class="s1">init_params</span>
<span class="s0">from </span><span class="s1">thorpy.miscgui </span><span class="s0">import </span><span class="s1">constants</span><span class="s0">, </span><span class="s1">parameters</span><span class="s0">, </span><span class="s1">style</span><span class="s0">, </span><span class="s1">painterstyle</span>

<span class="s0">class </span><span class="s1">Pressable(Element):</span>
    <span class="s2">&quot;&quot;&quot;Pressable Element&quot;&quot;&quot;</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">make(cls</span><span class="s0">, </span><span class="s1">text=</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">elements=</span><span class="s0">None, </span><span class="s1">size=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s0">if </span><span class="s1">size </span><span class="s0">is None</span><span class="s1">: size=style.MAKE_SIZE</span>
        <span class="s1">e = cls(text</span><span class="s0">, </span><span class="s1">elements)</span>
        <span class="s1">e.finish()</span>
        <span class="s1">e._make_size(size)</span>
        <span class="s0">return </span><span class="s1">e</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">text=</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">elements=</span><span class="s0">None, </span><span class="s1">normal_params=</span><span class="s0">None,</span>
                 <span class="s1">press_params=</span><span class="s0">None, </span><span class="s1">finish=</span><span class="s0">True</span><span class="s1">):</span>
        <span class="s2">&quot;&quot;&quot;Pressable element.&quot;&quot;&quot;</span>
        <span class="s1">self.press_params = init_params(press_params)</span>
        <span class="s1">super(Pressable</span><span class="s0">, </span><span class="s1">self).__init__(text</span><span class="s0">, </span><span class="s1">elements</span><span class="s0">, </span><span class="s1">normal_params</span><span class="s0">,</span>
                                        <span class="s1">finish=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s4"># painters</span>
        <span class="s0">if not </span><span class="s1">press_params </span><span class="s0">or not </span><span class="s3">&quot;painter&quot; </span><span class="s0">in </span><span class="s1">press_params:</span>
            <span class="s1">painter = copy(self.normal_params.params.get(</span><span class="s3">&quot;painter&quot;</span><span class="s1">))</span>
            <span class="s0">if not </span><span class="s1">painter:</span>
                <span class="s1">painter = painterstyle.DEF_PAINTER(size=style.SIZE)</span>
            <span class="s1">painter.pressed = </span><span class="s0">True</span>
            <span class="s1">self.press_params.params[</span><span class="s3">&quot;painter&quot;</span><span class="s1">] = painter</span>
<span class="s4">##        self.set_painter(painterstyle.DEF_PAINTER(size=style.SIZE))</span>
        <span class="s4"># reactions</span>
        <span class="s1">self._set_press_reaction(parameters.BUTTON_PRESS_EVENT</span><span class="s0">,</span>
                                 <span class="s1">{</span><span class="s3">&quot;button&quot;</span><span class="s1">: parameters.LEFT_CLICK_BUTTON})</span>
        <span class="s1">self._set_unpress_reaction(parameters.BUTTON_UNPRESS_EVENT</span><span class="s0">,</span>
                                   <span class="s1">{</span><span class="s3">&quot;button&quot;</span><span class="s1">: parameters.LEFT_CLICK_BUTTON})</span>
        <span class="s0">if </span><span class="s1">finish:</span>
            <span class="s1">self.finish()</span>

    <span class="s0">def </span><span class="s1">finish(self):</span>
        <span class="s1">Element.finish(self)</span>
        <span class="s1">self.press_params._normalize(self)</span>
        <span class="s1">fusionner_press = self.press_params.get_fusionner()</span>
        <span class="s1">state_pressed = State(fusionner_press)</span>
        <span class="s1">self._states[constants.STATE_PRESSED] = state_pressed</span>

    <span class="s0">def </span><span class="s1">set_style(self</span><span class="s0">, </span><span class="s1">new_style):</span>
        <span class="s1">Element.set_style(self</span><span class="s0">, </span><span class="s1">new_style)</span>
        <span class="s1">self.press_params.params[</span><span class="s3">&quot;style&quot;</span><span class="s1">] = new_style</span>

    <span class="s0">def </span><span class="s1">set_painter(self</span><span class="s0">, </span><span class="s1">painter</span><span class="s0">, </span><span class="s1">autopress=</span><span class="s0">True</span><span class="s1">):</span>
        <span class="s2">&quot;&quot;&quot;To use before finish&quot;&quot;&quot;</span>
        <span class="s1">Element.set_painter(self</span><span class="s0">, </span><span class="s1">painter)</span>
        <span class="s0">if </span><span class="s1">autopress:</span>
            <span class="s1">painter = copy(painter)</span>
            <span class="s1">painter.pressed = </span><span class="s0">True</span>
        <span class="s1">self.press_params.params[</span><span class="s3">&quot;painter&quot;</span><span class="s1">] = painter</span>


    <span class="s0">def </span><span class="s1">_set_press_reaction(self</span><span class="s0">, </span><span class="s1">type_</span><span class="s0">, </span><span class="s1">args=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s2">&quot;&quot;&quot;Set event which permit to toggle the element&quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">args:</span>
            <span class="s1">args = {}</span>
        <span class="s1">reac_pressed = Reaction(type_</span><span class="s0">, </span><span class="s1">self._reaction_press</span><span class="s0">, </span><span class="s1">args</span><span class="s0">,</span>
                                <span class="s1">reac_name=constants.REAC_PRESSED)</span>
        <span class="s1">self.add_reaction(reac_pressed)</span>

    <span class="s0">def </span><span class="s1">_set_unpress_reaction(self</span><span class="s0">, </span><span class="s1">type_</span><span class="s0">, </span><span class="s1">args=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s0">if not </span><span class="s1">args:</span>
            <span class="s1">args = {}</span>
        <span class="s1">reac_unpress = Reaction(type_</span><span class="s0">, </span><span class="s1">self._reaction_unpress</span><span class="s0">, </span><span class="s1">args</span><span class="s0">,</span>
                                <span class="s1">reac_name=constants.REAC_UNPRESS)</span>
        <span class="s1">self.add_reaction(reac_unpress)</span>

    <span class="s0">def </span><span class="s1">_reaction_press(self</span><span class="s0">, </span><span class="s1">pygame_event):</span>
        <span class="s2">&quot;&quot;&quot;Specific for pygame.MOUSEBUTTONDOWN. Needs pygame_event to treat 
        arguments of the event&quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self.collide(pygame_event.pos</span><span class="s0">, </span><span class="s1">constants.STATE_NORMAL):</span>
            <span class="s1">self._press()</span>

    <span class="s0">def </span><span class="s1">_reaction_unpress(self</span><span class="s0">, </span><span class="s1">pygame_event):</span>
        <span class="s2">&quot;&quot;&quot;Specific for pygame.MOUSEBUTTONUP. Needs pygame_event to treat 
        arguments of the event&quot;&quot;&quot;</span>
        <span class="s1">self._unpress()</span>
        <span class="s0">if </span><span class="s1">self.collide(pygame_event.pos</span><span class="s0">, </span><span class="s1">constants.STATE_PRESSED):</span>
            <span class="s1">self.run_user_func()</span>

    <span class="s0">def </span><span class="s1">_press(self):</span>
        <span class="s1">state_ok = self.current_state == self._states[constants.STATE_NORMAL]</span>
        <span class="s0">if </span><span class="s1">state_ok:</span>
            <span class="s1">self.unblit()</span>
            <span class="s1">self.change_state(constants.STATE_PRESSED)</span>
            <span class="s1">self.blit()</span>
            <span class="s1">self.update()</span>
            <span class="s1">ev_press = Event(constants.THORPY_EVENT</span><span class="s0">,</span>
                             <span class="s1">id=constants.EVENT_PRESS</span><span class="s0">,</span>
                             <span class="s1">el=self)</span>
            <span class="s1">post(ev_press)</span>

    <span class="s0">def </span><span class="s1">_unpress(self):</span>
        <span class="s1">state_ok = (self.current_state_key == constants.STATE_PRESSED)</span>
        <span class="s0">if </span><span class="s1">state_ok:</span>
            <span class="s1">self.unblit()</span>
            <span class="s1">self.change_state(constants.STATE_NORMAL)</span>
            <span class="s1">self.blit()</span>
            <span class="s1">self.update()</span>
            <span class="s1">ev_unpress = Event(constants.THORPY_EVENT</span><span class="s0">, </span><span class="s1">id=constants.EVENT_UNPRESS</span><span class="s0">, </span><span class="s1">el=self)</span>
            <span class="s1">post(ev_unpress)</span>

    <span class="s0">def </span><span class="s1">_reaction_unpress_key(self):</span>
        <span class="s1">self._unpress()</span>
        <span class="s1">self.run_user_func()</span>

    <span class="s0">def </span><span class="s1">add_press_event(self</span><span class="s0">, </span><span class="s1">event_type</span><span class="s0">, </span><span class="s1">event_args):</span>
        <span class="s1">reaction = ConstantReaction(event_type</span><span class="s0">, </span><span class="s1">self._press</span><span class="s0">, </span><span class="s1">event_args)</span>
        <span class="s1">self.add_reaction(reaction)</span>

    <span class="s0">def </span><span class="s1">add_unpress_event(self</span><span class="s0">, </span><span class="s1">event_type</span><span class="s0">, </span><span class="s1">event_args):</span>
        <span class="s1">reaction = ConstantReaction(event_type</span><span class="s0">, </span><span class="s1">self._reaction_unpress_key)</span>
        <span class="s1">self.add_reaction(reaction)</span>

    <span class="s0">def </span><span class="s1">add_key_event(self</span><span class="s0">, </span><span class="s1">key):</span>
        <span class="s1">self.add_press_event(KEYDOWN</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">:key})</span>
        <span class="s1">self.add_unpress_event(KEYUP</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;key&quot;</span><span class="s1">:key})</span>

</pre>
</body>
</html>